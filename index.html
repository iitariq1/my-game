<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø®Ø§Ø¯Ø¹</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 10px;
            direction: rtl;
            color: #fff;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding-bottom: 200px;
        }

        .screen { display: none; }
        .screen.active { display: block; }

        .header {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .header h1 { font-size: 1.5em; color: #ffd700; }

        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 3px;
            transition: all 0.2s;
        }

        button:hover { transform: scale(1.02); opacity: 0.9; }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .btn-full { width: 100%; margin: 5px 0; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .btn-success { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .btn-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .btn-secondary { background: #6c757d; }
        .btn-small { padding: 5px 10px; font-size: 11px; }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .player-card {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .player-card.is-forensic {
            background: linear-gradient(135deg, #3498db20, #2980b920);
            border: 2px solid #3498db;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.2em;
            background: #fff;
            color: #000;
            padding: 8px 20px;
            border-radius: 25px;
            border: 3px solid #333;
            display: inline-block;
        }

        .player-name.forensic-badge {
            background: #3498db;
            color: white;
            border-color: #2980b9;
        }

        .player-items {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .item-btn {
            padding: 6px 10px;
            font-size: 11px;
            background: #f0f0f0;
            color: #333;
            border-radius: 5px;
        }

        .item-btn.weapon { border-right: 3px solid #e74c3c; }
        .item-btn.evidence { border-right: 3px solid #3498db; }

        .item-btn.selected {
            background: #667eea !important;
            color: white !important;
        }

        .vote-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #ddd;
            display: none;
        }

        .player-card.has-selection .vote-section { display: block; }

        .vote-info {
            background: rgba(231, 76, 60, 0.1);
            border: 1px solid #e74c3c;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9em;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯ÙˆØ± */
        .role-card {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .role-card.murderer { background: linear-gradient(135deg, #c0392b, #e74c3c); }
        .role-card.accomplice { background: linear-gradient(135deg, #8e44ad, #9b59b6); }
        .role-card.witness { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .role-card.forensic { background: linear-gradient(135deg, #2980b9, #3498db); }
        .role-card.investigator { background: linear-gradient(135deg, #27ae60, #2ecc71); }

        .role-icon { font-size: 3em; }
        .role-title { font-size: 1.5em; margin: 10px 0; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ */
        .forensic-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #2980b9ee, #3498dbee);
            padding: 10px 15px;
            z-index: 1000;
            max-height: 60vh;
            overflow-y: auto;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            border-top: 3px solid #ffd700;
        }

        .forensic-panel.minimized {
            max-height: 45px;
            overflow: hidden;
        }

        .forensic-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 5px 0;
        }

        .forensic-panel-header h3 { font-size: 1em; }

        .toggle-btn {
            background: rgba(255,255,255,0.3);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .forensic-secret {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
            font-size: 0.9em;
        }

        .forensic-secret p { margin: 5px 0; }

        .clue-card {
            background: rgba(255,255,255,0.15);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
        }

        .clue-card h4 { margin-bottom: 8px; font-size: 0.95em; }
        .clue-card.used { opacity: 0.5; }

        .clue-options { display: flex; flex-wrap: wrap; gap: 5px; }

        .clue-opt-btn {
            padding: 5px 10px;
            font-size: 11px;
            background: rgba(255,255,255,0.2);
        }

        .clue-opt-btn.selected { background: #27ae60; }

        .round-info {
            background: rgba(255,215,0,0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin: 10px 0;
        }

        /* Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
        .public-clues {
            background: rgba(39, 174, 96, 0.15);
            border: 2px solid #27ae60;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .public-clues h3 { color: #2ecc71; margin-bottom: 10px; }

        .clue-item {
            background: rgba(255,255,255,0.1);
            padding: 8px 12px;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 0.9em;
        }

        /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§ØªÙ„ */
        .murderer-selection {
            background: rgba(192, 57, 43, 0.2);
            border: 2px solid #c0392b;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .murderer-selection h3 { color: #e74c3c; margin-bottom: 15px; }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
        }

        .selection-btn {
            padding: 10px;
            font-size: 12px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
        }

        .selection-btn.selected {
            background: #c0392b;
            border-color: #ffd700;
        }

        /* Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        .results-box {
            background: rgba(0,0,0,0.8);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin-top: 20px;
        }

        .results-box.win { border: 3px solid #27ae60; }
        .results-box.lose { border: 3px solid #e74c3c; }

        .result-icon { font-size: 4em; }
        .result-title { font-size: 1.8em; margin: 15px 0; }

        .truth-reveal {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: right;
        }

        .truth-reveal p { margin: 8px 0; }

        /* Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± */
        .room-code {
            font-size: 2.5em;
            font-weight: bold;
            color: #ffd700;
            letter-spacing: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .lobby-player {
            background: rgba(255,255,255,0.1);
            padding: 12px 15px;
            border-radius: 8px;
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lobby-player.host { border-right: 4px solid #ffd700; }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        .alert-info { background: rgba(52, 152, 219, 0.3); }
        .alert-success { background: rgba(39, 174, 96, 0.3); }
        .alert-danger { background: rgba(231, 76, 60, 0.3); }
        .alert-warning { background: rgba(241, 196, 15, 0.3); }

        .hidden { display: none !important; }

        .my-items {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
        }

        .my-items h4 { margin-bottom: 8px; color: #ffd700; font-size: 0.95em; }
        .my-items .item-tag {
            display: inline-block;
            background: rgba(255,255,255,0.15);
            padding: 4px 10px;
            border-radius: 5px;
            margin: 3px;
            font-size: 0.85em;
        }

        .secret-info {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .secret-info p { margin: 5px 0; }

        .suspects-info {
            background: rgba(241, 196, 15, 0.2);
            border: 2px solid #f1c40f;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div id="homeScreen" class="screen active">
            <div class="header">
                <h1>ğŸ” Ø§Ù„Ù…Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø®Ø§Ø¯Ø¹ ğŸ”ª</h1>
                <p>Ù„Ø¹Ø¨Ø© Ø§Ù„ØºÙ…ÙˆØ¶ ÙˆØ§Ù„ØªØ­Ù‚ÙŠÙ‚</p>
            </div>
            
            <div class="card">
                <p style="text-align: center; margin-bottom: 20px; line-height: 1.8; font-size: 0.95em;">
                    Ø¬Ø±ÙŠÙ…Ø© Ù‚ØªÙ„ ØºØ§Ù…Ø¶Ø©! Ø§Ù„Ù‚Ø§ØªÙ„ ÙŠØ®ØªØ§Ø± Ø³Ù„Ø§Ø­Ù‡ ÙˆØ¯Ù„ÙŠÙ„Ù‡ØŒ ÙˆØ§Ù„Ø´Ø±ÙŠÙƒ ÙŠØ³Ø§Ø¹Ø¯Ù‡ ÙÙŠ Ø§Ù„Ø¥ÙÙ„Ø§Øª.
                    Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ ÙŠØ¹Ø±Ù ÙƒÙ„ Ø´ÙŠØ¡ ÙˆÙŠÙ‚Ø¯Ù… Ø§Ù„Ø£Ø¯Ù„Ø© Ù„Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ†.
                    Ø§Ù„Ø´Ø§Ù‡Ø¯ ÙŠØ¹Ø±Ù Ø§Ù„Ù…ØªÙ‡Ù…ÙÙŠÙ† Ù„ÙƒÙ† Ù„Ø§ ÙŠØ¹Ø±Ù Ø§Ù„ØªÙØ§ØµÙŠÙ„!
                </p>
                <button onclick="showScreen('createRoomScreen')" class="btn-full">ğŸ  Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
                <button onclick="showScreen('joinRoomScreen')" class="btn-full btn-secondary">ğŸšª Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</button>
            </div>
        </div>

        <!-- Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© -->
        <div id="createRoomScreen" class="screen">
            <div class="header"><h1>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h1></div>
            <div class="card">
                <label>Ø§Ø³Ù…Ùƒ:</label>
                <input type="text" id="hostName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" maxlength="15">
                
                <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</label>
                <select id="playerCount">
                    <option value="4">4 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="5">5 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="6">6 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="7">7 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="8">8 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="9">9 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="10">10 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="11">11 Ù„Ø§Ø¹Ø¨</option>
                    <option value="12">12 Ù„Ø§Ø¹Ø¨</option>
                </select>
                
                <button onclick="createRoom()" class="btn-full btn-success">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©</button>
                <button onclick="showScreen('homeScreen')" class="btn-full btn-secondary">Ø±Ø¬ÙˆØ¹</button>
            </div>
        </div>

        <!-- Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… -->
        <div id="joinRoomScreen" class="screen">
            <div class="header"><h1>Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</h1></div>
            <div class="card">
                <label>Ø§Ø³Ù…Ùƒ:</label>
                <input type="text" id="playerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" maxlength="15">
                
                <label>Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©:</label>
                <input type="text" id="roomCodeInput" placeholder="Ù…Ø«Ø§Ù„: ABCD" maxlength="4" style="text-transform: uppercase; text-align: center; font-size: 1.5em; letter-spacing: 5px;">
                
                <button onclick="joinRoom()" class="btn-full btn-success">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
                <button onclick="showScreen('homeScreen')" class="btn-full btn-secondary">Ø±Ø¬ÙˆØ¹</button>
            </div>
        </div>

        <!-- ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± -->
        <div id="lobbyScreen" class="screen">
            <div class="header">
                <h1>ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h1>
                <div class="room-code" id="displayRoomCode">----</div>
                <p style="margin-top:10px;">Ø´Ø§Ø±Ùƒ Ø§Ù„Ø±Ù…Ø² Ù…Ø¹ Ø£ØµØ¯Ù‚Ø§Ø¦Ùƒ</p>
            </div>
            <div class="card">
                <h3>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† (<span id="playerCountDisplay">0</span>/<span id="maxPlayerDisplay">4</span>)</h3>
                <div id="lobbyPlayersList"></div>
            </div>
            <div id="hostControls" class="hidden">
                <button onclick="startGame()" class="btn-full btn-success" id="startBtn">ğŸ® Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div id="gameScreen" class="screen">
            <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯ÙˆØ± -->
            <div id="roleCard" class="role-card">
                <div class="role-icon" id="roleIcon">ğŸ”</div>
                <div class="role-title" id="roleTitle">Ø¯ÙˆØ±Ùƒ</div>
                <div id="roleDescription"></div>
            </div>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ© -->
            <div id="secretInfo" class="secret-info hidden"></div>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø§Ù‡Ø¯ -->
            <div id="witnessInfo" class="suspects-info hidden"></div>

            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§ØªÙ„ Ù„Ù„Ø³Ù„Ø§Ø­ ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„ -->
            <div id="murdererSelection" class="murderer-selection hidden">
                <h3>ğŸ”ª Ø§Ø®ØªØ± Ø³Ù„Ø§Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø© ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„:</h3>
                <p style="margin-bottom:15px;font-size:0.9em;">Ø§Ø®ØªØ± Ø³Ù„Ø§Ø­Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ ÙˆØ¯Ù„ÙŠÙ„Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ù…Ù† Ø£Ø¯ÙˆØ§ØªÙƒ</p>
                
                <h4 style="margin:10px 0;">âš”ï¸ Ø§Ù„Ø£Ø³Ù„Ø­Ø©:</h4>
                <div id="murdererWeapons" class="selection-grid"></div>
                
                <h4 style="margin:15px 0 10px;">ğŸ” Ø§Ù„Ø£Ø¯Ù„Ø©:</h4>
                <div id="murdererEvidence" class="selection-grid"></div>
                
                <button onclick="confirmMurderChoice()" class="btn-full btn-danger" style="margin-top:20px;" id="confirmMurderBtn" disabled>
                    âœ“ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
                </button>
            </div>

            <!-- Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù‚Ø§ØªÙ„ -->
            <div id="waitingForMurderer" class="alert alert-warning hidden">
                <h3>â³ Ø§Ù†ØªØ¸Ø±...</h3>
                <p>Ø§Ù„Ù‚Ø§ØªÙ„ ÙŠØ®ØªØ§Ø± Ø³Ù„Ø§Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø© ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„</p>
            </div>

            <!-- Ø£Ø¯ÙˆØ§ØªÙŠ -->
            <div id="myItems" class="my-items hidden">
                <h4>ğŸ’ Ø£Ø¯ÙˆØ§ØªÙŠ:</h4>
                <div id="myWeapons"></div>
                <div id="myEvidence"></div>
            </div>

            <!-- Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© -->
            <div id="publicCluesSection" class="public-clues hidden">
                <h3>ğŸ“‹ Ø£Ø¯Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ:</h3>
                <div id="publicCluesList">
                    <p style="color: #aaa;">Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ...</p>
                </div>
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
            <div id="playersSection" class="card hidden">
                <h3>ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† - Ø§Ø®ØªØ± Ø§Ù„Ù…ØªÙ‡Ù…:</h3>
                <div id="playersVotingList"></div>
            </div>

            <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
            <div id="gameResults" class="hidden"></div>
        </div>

        <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ -->
        <div id="forensicPanel" class="forensic-panel hidden minimized">
            <div class="forensic-panel-header" onclick="toggleForensicPanel()">
                <h3>ğŸ”¬ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ</h3>
                <span class="toggle-btn" id="panelToggleBtn">â–²</span>
            </div>
            <div id="forensicContent">
                <div class="forensic-secret">
                    <p>ğŸ”ª <strong>Ø§Ù„Ù‚Ø§ØªÙ„:</strong> <span id="fMurderer">-</span></p>
                    <p>ğŸ¤ <strong>Ø§Ù„Ø´Ø±ÙŠÙƒ:</strong> <span id="fAccomplice">-</span></p>
                    <p>ğŸ‘ï¸ <strong>Ø§Ù„Ø´Ø§Ù‡Ø¯:</strong> <span id="fWitness">-</span></p>
                    <hr style="margin:10px 0;border-color:rgba(255,255,255,0.2);">
                    <p>âš”ï¸ <strong>Ø§Ù„Ø³Ù„Ø§Ø­:</strong> <span id="fWeapon">Ø§Ù†ØªØ¸Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§ØªÙ„</span></p>
                    <p>ğŸ” <strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> <span id="fEvidence">Ø§Ù†ØªØ¸Ø± Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§ØªÙ„</span></p>
                </div>
                
                <div class="round-info">
                    <strong>Ø§Ù„Ø¬ÙˆÙ„Ø©: <span id="currentRound">1</span>/3</strong>
                    <span id="roundStatus"></span>
                </div>

                <div id="forensicClueCards"></div>
                
                <button onclick="nextRound()" class="btn-full btn-warning" id="nextRoundBtn" style="display:none;">
                    ğŸ”„ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© (ØªØ¨Ø¯ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø©)
                </button>
            </div>
        </div>
    </div>

    <script>
        // =============== Firebase ===============
        firebase.initializeApp({
            apiKey: "AIzaSyB88NCDQzsUzHZgH07B63e4Dpxc3LfXSyY",
            authDomain: "detective-game-df960.firebaseapp.com",
            databaseURL: "https://detective-game-df960-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "detective-game-df960"
        });
        var db = firebase.database();

        // =============== Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ===============
        var WEAPONS = [
            'ğŸ”« Ù…Ø³Ø¯Ø³', 'ğŸ”ª Ø³ÙƒÙŠÙ†', 'ğŸª¢ Ø­Ø¨Ù„', 'â˜ ï¸ Ø³Ù…', 'ğŸª“ ÙØ£Ø³', 'ğŸ”¨ Ù…Ø·Ø±Ù‚Ø©',
            'âš¾ Ù…Ø¶Ø±Ø¨', 'âœ‚ï¸ Ù…Ù‚Øµ', 'ğŸ’‰ Ø­Ù‚Ù†Ø©', 'ğŸ”Œ ÙƒØ§Ø¨Ù„', 'ğŸª› Ù…ÙÙƒ', 'ğŸ”© Ù‚Ø¶ÙŠØ¨ Ø­Ø¯ÙŠØ¯',
            'âš”ï¸ Ø³ÙŠÙ', 'ğŸ¹ Ù‚ÙˆØ³', 'â›“ï¸ Ø³Ù„Ø³Ù„Ø©', 'ğŸ”§ Ù…ÙØªØ§Ø­', 'ğŸª¨ Ø­Ø¬Ø±', 'ğŸ—¡ï¸ Ø®Ù†Ø¬Ø±',
            'ğŸ³ Ù…Ù‚Ù„Ø§Ø©', 'ğŸ Ø¹ØµØ§', 'âš¡ ØµØ§Ø¹Ù‚', 'ğŸ”¥ Ù†Ø§Ø±', 'ğŸ§Š Ø¬Ù„ÙŠØ¯', 'ğŸ’Š Ø¯ÙˆØ§Ø¡'
        ];

        var EVIDENCE = [
            'ğŸ‘£ Ø£Ø«Ø± Ù‚Ø¯Ù…', 'ğŸ©¸ Ø¯Ù…', 'ğŸ’‡ Ø´Ø¹Ø±Ø©', 'ğŸ‘† Ø¨ØµÙ…Ø©', 'ğŸ§µ Ù‚Ù…Ø§Ø´', 'ğŸ“± Ù‡Ø§ØªÙ',
            'ğŸ”‘ Ù…ÙØªØ§Ø­', 'ğŸ’ Ø®Ø§ØªÙ…', 'ğŸ« ØªØ°ÙƒØ±Ø©', 'ğŸ“ Ø±Ø³Ø§Ù„Ø©', 'ğŸ§¤ Ù‚ÙØ§Ø²', 'ğŸ‘“ Ù†Ø¸Ø§Ø±Ø©',
            'âŒš Ø³Ø§Ø¹Ø©', 'ğŸ­ Ù‚Ù†Ø§Ø¹', 'ğŸ§ª Ø¹ÙŠÙ†Ø©', 'ğŸ“· ØµÙˆØ±Ø©', 'ğŸ’³ Ø¨Ø·Ø§Ù‚Ø©', 'ğŸ—ï¸ Ù…ÙØªØ§Ø­ Ù‚Ø¯ÙŠÙ…',
            'ğŸ“œ ÙˆØ«ÙŠÙ‚Ø©', 'ğŸ’Š Ø­Ø¨ÙˆØ¨', 'ğŸµ ØªØ³Ø¬ÙŠÙ„', 'ğŸ“§ Ø¥ÙŠÙ…ÙŠÙ„', 'ğŸ–Šï¸ Ù‚Ù„Ù…', 'ğŸ‘Ÿ Ø­Ø°Ø§Ø¡'
        ];

        var CLUE_CARDS = [
            { title: 'ğŸ“ Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©', options: ['ØºØ±ÙØ© Ø§Ù„Ù†ÙˆÙ…', 'Ø§Ù„Ù…Ø·Ø¨Ø®', 'Ø§Ù„Ø­Ù…Ø§Ù…', 'Ø§Ù„ØµØ§Ù„Ø©', 'Ø§Ù„Ù…Ø±Ø¢Ø¨', 'Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©', 'Ø§Ù„Ø³Ø·Ø­', 'Ø§Ù„Ù‚Ø¨Ùˆ'] },
            { title: 'ğŸ• ÙˆÙ‚Øª Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©', options: ['Ø§Ù„ÙØ¬Ø±', 'Ø§Ù„ØµØ¨Ø§Ø­', 'Ø§Ù„Ø¸Ù‡Ø±', 'Ø§Ù„Ø¹ØµØ±', 'Ø§Ù„Ù…ØºØ±Ø¨', 'Ø§Ù„Ø¹Ø´Ø§Ø¡', 'Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„', 'Ù‚Ø¨Ù„ Ø§Ù„ÙØ¬Ø±'] },
            { title: 'ğŸ˜µ Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ø­ÙŠØ©', options: ['Ù†Ø§Ø¦Ù…', 'Ø¬Ø§Ù„Ø³', 'ÙˆØ§Ù‚Ù', 'ÙŠØ±ÙƒØ¶', 'ÙŠØ£ÙƒÙ„', 'ÙŠØªØ­Ø¯Ø«', 'ÙŠÙ‚Ø±Ø£', 'ÙŠØ³ØªØ­Ù…'] },
            { title: 'ğŸ’­ Ø§Ù„Ø¯Ø§ÙØ¹', options: ['Ø§Ù„Ù…Ø§Ù„', 'Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù…', 'Ø§Ù„ØºÙŠØ±Ø©', 'Ø§Ù„Ø³Ù„Ø·Ø©', 'Ø§Ù„Ø³Ø±', 'Ø§Ù„Ø­Ø¨', 'Ø§Ù„Ø®ÙˆÙ', 'Ø§Ù„Ø¬Ù†ÙˆÙ†'] },
            { title: 'ğŸŒ¤ï¸ Ø§Ù„Ø·Ù‚Ø³', options: ['Ù…Ø´Ù…Ø³', 'ØºØ§Ø¦Ù…', 'Ù…Ù…Ø·Ø±', 'Ø¹Ø§ØµÙ', 'Ø«Ù„Ø¬ÙŠ', 'Ø¶Ø¨Ø§Ø¨ÙŠ', 'Ø­Ø§Ø±', 'Ø¨Ø§Ø±Ø¯'] },
            { title: 'ğŸ‘” Ù…Ù„Ø§Ø¨Ø³ Ø§Ù„Ù‚Ø§ØªÙ„', options: ['Ø£Ø³ÙˆØ¯', 'Ø£Ø¨ÙŠØ¶', 'Ø£Ø­Ù…Ø±', 'Ø£Ø²Ø±Ù‚', 'Ø±Ù…Ø§Ø¯ÙŠ', 'Ø¨Ù†ÙŠ', 'Ù…ØªÙ†ÙƒØ±', 'Ø±Ø³Ù…ÙŠ'] },
            { title: 'ğŸ­ Ø´Ø®ØµÙŠØ© Ø§Ù„Ù‚Ø§ØªÙ„', options: ['Ù‡Ø§Ø¯Ø¦', 'Ø¹ØµØ¨ÙŠ', 'Ù…Ø§ÙƒØ±', 'Ù…ØªÙ‡ÙˆØ±', 'Ø¨Ø§Ø±Ø¯', 'Ù…Ø¬Ù†ÙˆÙ†', 'Ù…Ø­ØªØ±Ù', 'Ù…Ø¨ØªØ¯Ø¦'] },
            { title: 'ğŸ”Š ØµÙˆØª Ø³ÙÙ…Ø¹', options: ['ØµØ±Ø§Ø®', 'Ø³Ù‚ÙˆØ·', 'ÙƒØ³Ø± Ø²Ø¬Ø§Ø¬', 'Ø·Ù„Ù‚Ø©', 'ØµÙ…Øª', 'Ù…ÙˆØ³ÙŠÙ‚Ù‰', 'ØªÙ„ÙØ§Ø²', 'Ù…Ø­Ø§Ø¯Ø«Ø©'] },
            { title: 'ğŸ’¡ Ø§Ù„Ø¥Ø¶Ø§Ø¡Ø©', options: ['Ù…Ø¸Ù„Ù…', 'Ø®Ø§ÙØª', 'Ø³Ø§Ø·Ø¹', 'Ø´Ù…ÙˆØ¹', 'Ø·Ø¨ÙŠØ¹ÙŠ', 'Ù…Ù„ÙˆÙ†', 'Ù…ØªÙ‚Ø·Ø¹', 'Ø¶ÙˆØ¡ Ø§Ù„Ù‚Ù…Ø±'] },
            { title: 'ğŸ‘ƒ Ø±Ø§Ø¦Ø­Ø©', options: ['Ø¯Ù…', 'Ø¹Ø·Ø±', 'Ø¯Ø®Ø§Ù†', 'Ø·Ø¹Ø§Ù…', 'ÙƒÙŠÙ…Ø§ÙˆÙŠØ§Øª', 'Ø²Ù‡ÙˆØ±', 'Ø¹ÙÙ†', 'Ù„Ø§ Ø´ÙŠØ¡'] }
        ];

        // =============== Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© ===============
        var gameState = {
            roomCode: null,
            oderId: null,
            playerName: null,
            isHost: false,
            players: [],
            maxPlayers: 4,
            gameStarted: false,
            role: null,
            murderWeapon: null,
            murderEvidence: null,
            murdererName: null,
            accompliceName: null,
            witnessName: null,
            forensicName: null,
            clues: [],
            votes: [],
            gamePhase: 'waiting',
            currentRound: 1,
            forensicClueCards: [],
            murdererReady: false
        };

        var selectedMurderWeapon = null;
        var selectedMurderEvidence = null;
        var selectedVotes = {};

        // =============== Session ===============
        function saveSession() {
            sessionStorage.setItem('detective', JSON.stringify({
                roomCode: gameState.roomCode,
                oderId: gameState.oderId,
                playerName: gameState.playerName,
                isHost: gameState.isHost
            }));
        }

        function loadSession() {
            try {
                var s = sessionStorage.getItem('detective');
                if (s) {
                    var d = JSON.parse(s);
                    if (d.roomCode && d.oderId) {
                        gameState.roomCode = d.roomCode;
                        gameState.oderId = d.oderId;
                        gameState.playerName = d.playerName;
                        gameState.isHost = d.isHost;
                        return true;
                    }
                }
            } catch(e) {}
            return false;
        }

        // =============== Ø£Ø¯ÙˆØ§Øª ===============
        function genId() { return Math.random().toString(36).substr(2, 9); }
        
        function genCode() {
            var c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789', r = '';
            for (var i = 0; i < 4; i++) r += c[Math.floor(Math.random() * c.length)];
            return r;
        }

        function shuffle(a) {
            var arr = a.slice();
            for (var i = arr.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var t = arr[i]; arr[i] = arr[j]; arr[j] = t;
            }
            return arr;
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
            document.getElementById(id).classList.add('active');
        }

        // =============== Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØºØ±Ù ===============
        function createRoom() {
            var name = document.getElementById('hostName').value.trim();
            var count = parseInt(document.getElementById('playerCount').value);
            
            if (!name) { alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ'); return; }

            gameState.roomCode = genCode();
            gameState.oderId = genId();
            gameState.playerName = name;
            gameState.isHost = true;
            gameState.maxPlayers = count;
            gameState.players = [{ id: gameState.oderId, name: name, isHost: true }];

            saveSession();
            db.ref('rooms/' + gameState.roomCode).set(gameState).then(function() {
                showScreen('lobbyScreen');
                updateLobby();
                document.getElementById('hostControls').classList.remove('hidden');
                listenToRoom();
            });
        }

        function joinRoom() {
            var name = document.getElementById('playerName').value.trim();
            var code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (!name || !code) { alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ±Ù…Ø² Ø§Ù„ØºØ±ÙØ©'); return; }

            db.ref('rooms/' + code).once('value').then(function(snap) {
                if (!snap.exists()) { alert('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }
                
                var data = snap.val();
                if (data.gameStarted) { alert('Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª'); return; }
                if (data.players && data.players.length >= data.maxPlayers) { alert('Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©'); return; }

                gameState.roomCode = code;
                gameState.oderId = genId();
                gameState.playerName = name;
                gameState.isHost = false;
                gameState.players = data.players || [];
                gameState.maxPlayers = data.maxPlayers;
                
                gameState.players.push({ id: gameState.oderId, name: name, isHost: false });
                
                saveSession();
                db.ref('rooms/' + code + '/players').set(gameState.players).then(function() {
                    showScreen('lobbyScreen');
                    updateLobby();
                    listenToRoom();
                });
            });
        }

        function updateLobby() {
            document.getElementById('displayRoomCode').textContent = gameState.roomCode;
            document.getElementById('playerCountDisplay').textContent = gameState.players.length;
            document.getElementById('maxPlayerDisplay').textContent = gameState.maxPlayers;

            var list = document.getElementById('lobbyPlayersList');
            list.innerHTML = '';
            
            gameState.players.forEach(function(p) {
                var div = document.createElement('div');
                div.className = 'lobby-player' + (p.isHost ? ' host' : '');
                div.innerHTML = '<span>' + p.name + '</span>' + (p.isHost ? '<span>ğŸ‘‘</span>' : '');
                list.appendChild(div);
            });

            var btn = document.getElementById('startBtn');
            if (btn) btn.disabled = gameState.players.length < 4;
        }

        // =============== Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ===============
        function startGame() {
            if (gameState.players.length < 4) { alert('ÙŠØ¬Ø¨ 4 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }

            var shuffled = shuffle(gameState.players);
            var roles = ['forensic', 'murderer', 'accomplice', 'witness'];
            for (var i = 4; i < shuffled.length; i++) roles.push('investigator');

            shuffled.forEach(function(p, i) {
                p.role = roles[i];
                if (p.role !== 'forensic') {
                    p.weapons = shuffle(WEAPONS).slice(0, 4);
                    p.evidence = shuffle(EVIDENCE).slice(0, 4);
                } else {
                    p.weapons = [];
                    p.evidence = [];
                }
            });

            var murderer = shuffled.find(function(p) { return p.role === 'murderer'; });
            var accomplice = shuffled.find(function(p) { return p.role === 'accomplice'; });
            var witness = shuffled.find(function(p) { return p.role === 'witness'; });
            var forensic = shuffled.find(function(p) { return p.role === 'forensic'; });

            gameState.players = shuffled;
            gameState.gameStarted = true;
            gameState.murdererName = murderer.name;
            gameState.accompliceName = accomplice.name;
            gameState.witnessName = witness.name;
            gameState.forensicName = forensic.name;
            gameState.murderWeapon = null;
            gameState.murderEvidence = null;
            gameState.murdererReady = false;
            gameState.clues = [];
            gameState.votes = [];
            gameState.gamePhase = 'murderer_choosing';
            gameState.currentRound = 1;
            gameState.forensicClueCards = shuffle(CLUE_CARDS).slice(0, 6);

            db.ref('rooms/' + gameState.roomCode).set(gameState);
        }

        // =============== Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø¹Ø¨Ø© ===============
        function showGame() {
            showScreen('gameScreen');
            
            var me = gameState.players.find(function(p) { return p.id === gameState.oderId; });
            if (!me) return;

            gameState.role = me.role;
            showRole(me);

            if (gameState.gamePhase === 'murderer_choosing') {
                if (me.role === 'murderer') {
                    showMurdererSelection(me);
                } else {
                    document.getElementById('waitingForMurderer').classList.remove('hidden');
                }
            } else if (gameState.gamePhase === 'playing') {
                showPlayingPhase(me);
            } else if (gameState.gamePhase === 'witness_guess') {
                showWitnessGuessPhase();
            } else if (gameState.gamePhase === 'ended') {
                showFinalResult();
            }
        }

        function showRole(player) {
            var card = document.getElementById('roleCard');
            var icon = document.getElementById('roleIcon');
            var title = document.getElementById('roleTitle');
            var desc = document.getElementById('roleDescription');

            var roles = {
                murderer: { i: 'ğŸ”ª', t: 'Ø§Ù„Ù‚Ø§ØªÙ„', d: 'Ø§Ø®ØªØ± Ø³Ù„Ø§Ø­Ùƒ ÙˆØ¯Ù„ÙŠÙ„Ùƒ ÙˆØ§Ø®ØªØ¨Ø¦!' },
                accomplice: { i: 'ğŸ¤', t: 'Ø§Ù„Ø´Ø±ÙŠÙƒ', d: 'Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø§ØªÙ„ ÙÙŠ Ø§Ù„Ø¥ÙÙ„Ø§Øª!' },
                witness: { i: 'ğŸ‘ï¸', t: 'Ø§Ù„Ø´Ø§Ù‡Ø¯', d: 'Ø£Ù†Øª ØªØ¹Ø±Ù Ø§Ù„Ù…ØªÙ‡Ù…ÙÙŠÙ†ØŒ Ø³Ø§Ø¹Ø¯ Ø¨Ø­Ø°Ø±!' },
                forensic: { i: 'ğŸ”¬', t: 'Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ', d: 'Ù‚Ø¯Ù… 6 Ø£Ø¯Ù„Ø© Ù„Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ†!' },
                investigator: { i: 'ğŸ”', t: 'Ù…Ø­Ù‚Ù‚', d: 'Ø§ÙƒØªØ´Ù Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆØ§Ù„Ø³Ù„Ø§Ø­ ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„!' }
            };

            var r = roles[player.role];
            card.className = 'role-card ' + player.role;
            icon.textContent = r.i;
            title.textContent = r.t;
            desc.textContent = r.d;

            // Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ©
            var secret = document.getElementById('secretInfo');
            var witnessInfo = document.getElementById('witnessInfo');
            secret.classList.add('hidden');
            witnessInfo.classList.add('hidden');

            if (player.role === 'murderer') {
                secret.classList.remove('hidden');
                secret.innerHTML = '<p>ğŸ¤ <strong>Ø´Ø±ÙŠÙƒÙƒ:</strong> ' + gameState.accompliceName + '</p>';
            } else if (player.role === 'accomplice') {
                secret.classList.remove('hidden');
                secret.innerHTML = '<p>ğŸ”ª <strong>Ø§Ù„Ù‚Ø§ØªÙ„:</strong> ' + gameState.murdererName + '</p>';
                if (gameState.murderWeapon) {
                    secret.innerHTML += '<p>âš”ï¸ <strong>Ø§Ù„Ø³Ù„Ø§Ø­:</strong> ' + gameState.murderWeapon + '</p>' +
                        '<p>ğŸ” <strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> ' + gameState.murderEvidence + '</p>';
                }
            } else if (player.role === 'witness') {
                witnessInfo.classList.remove('hidden');
                witnessInfo.innerHTML = '<h4>ğŸ‘ï¸ Ø£Ù†Øª ØªØ¹Ù„Ù… Ø£Ù† Ø§Ù„Ù…ØªÙ‡Ù…ÙÙŠÙ† Ù‡Ù…Ø§:</h4>' +
                    '<p style="font-size:1.2em;margin-top:10px;"><strong>' + gameState.murdererName + '</strong> Ùˆ <strong>' + gameState.accompliceName + '</strong></p>' +
                    '<p style="color:#f39c12;margin-top:10px;">âš ï¸ Ù„ÙƒÙ†Ùƒ Ù„Ø§ ØªØ¹Ø±Ù Ù…Ù† Ù…Ù†Ù‡Ù…Ø§ Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆÙ…Ù† Ø§Ù„Ø´Ø±ÙŠÙƒØŒ ÙˆÙ„Ø§ ØªØ¹Ø±Ù Ø§Ù„Ø³Ù„Ø§Ø­ ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„!</p>';
            }
        }

        function showMurdererSelection(player) {
            var section = document.getElementById('murdererSelection');
            section.classList.remove('hidden');

            var wDiv = document.getElementById('murdererWeapons');
            var eDiv = document.getElementById('murdererEvidence');
            wDiv.innerHTML = '';
            eDiv.innerHTML = '';

            player.weapons.forEach(function(w) {
                var btn = document.createElement('button');
                btn.className = 'selection-btn';
                btn.textContent = w;
                btn.onclick = function() { selectMurderItem('weapon', w, this); };
                wDiv.appendChild(btn);
            });

            player.evidence.forEach(function(e) {
                var btn = document.createElement('button');
                btn.className = 'selection-btn';
                btn.textContent = e;
                btn.onclick = function() { selectMurderItem('evidence', e, this); };
                eDiv.appendChild(btn);
            });
        }

        function selectMurderItem(type, value, btn) {
            var container = btn.parentElement;
            container.querySelectorAll('.selection-btn').forEach(function(b) { b.classList.remove('selected'); });
            btn.classList.add('selected');

            if (type === 'weapon') selectedMurderWeapon = value;
            else selectedMurderEvidence = value;

            document.getElementById('confirmMurderBtn').disabled = !(selectedMurderWeapon && selectedMurderEvidence);
        }

        function confirmMurderChoice() {
            if (!selectedMurderWeapon || !selectedMurderEvidence) return;

            gameState.murderWeapon = selectedMurderWeapon;
            gameState.murderEvidence = selectedMurderEvidence;
            gameState.murdererReady = true;
            gameState.gamePhase = 'playing';

            db.ref('rooms/' + gameState.roomCode).update({
                murderWeapon: gameState.murderWeapon,
                murderEvidence: gameState.murderEvidence,
                murdererReady: true,
                gamePhase: 'playing'
            });
        }

        function showPlayingPhase(me) {
            document.getElementById('murdererSelection').classList.add('hidden');
            document.getElementById('waitingForMurderer').classList.add('hidden');

            // Ø¹Ø±Ø¶ Ø£Ø¯ÙˆØ§ØªÙŠ (Ø¥Ù„Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ)
            if (me.role !== 'forensic') {
                document.getElementById('myItems').classList.remove('hidden');
                var wDiv = document.getElementById('myWeapons');
                var eDiv = document.getElementById('myEvidence');
                
                wDiv.innerHTML = '<strong>âš”ï¸ Ø£Ø³Ù„Ø­ØªÙŠ:</strong> ';
                me.weapons.forEach(function(w) { wDiv.innerHTML += '<span class="item-tag">' + w + '</span>'; });
                
                eDiv.innerHTML = '<strong>ğŸ” Ø£Ø¯Ù„ØªÙŠ:</strong> ';
                me.evidence.forEach(function(e) { eDiv.innerHTML += '<span class="item-tag">' + e + '</span>'; });
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ© Ù„Ù„Ø´Ø±ÙŠÙƒ
            if (me.role === 'accomplice') {
                var secret = document.getElementById('secretInfo');
                secret.classList.remove('hidden');
                secret.innerHTML = '<p>ğŸ”ª <strong>Ø§Ù„Ù‚Ø§ØªÙ„:</strong> ' + gameState.murdererName + '</p>' +
                    '<p>âš”ï¸ <strong>Ø§Ù„Ø³Ù„Ø§Ø­:</strong> ' + gameState.murderWeapon + '</p>' +
                    '<p>ğŸ” <strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> ' + gameState.murderEvidence + '</p>';
            }

            // Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
            document.getElementById('publicCluesSection').classList.remove('hidden');
            displayPublicClues();

            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
            document.getElementById('playersSection').classList.remove('hidden');
            renderPlayers();

            // Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ
            if (me.role === 'forensic') {
                showForensicPanel();
            }
        }

        // =============== Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ ===============
        function showForensicPanel() {
            var panel = document.getElementById('forensicPanel');
            panel.classList.remove('hidden');
            panel.classList.remove('minimized');

            document.getElementById('fMurderer').textContent = gameState.murdererName;
            document.getElementById('fAccomplice').textContent = gameState.accompliceName;
            document.getElementById('fWitness').textContent = gameState.witnessName;
            document.getElementById('fWeapon').textContent = gameState.murderWeapon || 'Ø§Ù†ØªØ¸Ø±...';
            document.getElementById('fEvidence').textContent = gameState.murderEvidence || 'Ø§Ù†ØªØ¸Ø±...';
            document.getElementById('currentRound').textContent = gameState.currentRound;

            renderForensicCards();
            updateRoundButton();
        }

        function toggleForensicPanel() {
            var panel = document.getElementById('forensicPanel');
            var btn = document.getElementById('panelToggleBtn');
            panel.classList.toggle('minimized');
            btn.textContent = panel.classList.contains('minimized') ? 'â–²' : 'â–¼';
        }

        function renderForensicCards() {
            var container = document.getElementById('forensicClueCards');
            container.innerHTML = '';

            gameState.forensicClueCards.forEach(function(card, idx) {
                var used = gameState.clues.some(function(c) { return c.cardIndex === idx; });
                
                var div = document.createElement('div');
                div.className = 'clue-card' + (used ? ' used' : '');

                var html = '<h4>' + card.title + '</h4><div class="clue-options">';
                card.options.forEach(function(opt) {
                    var sel = gameState.clues.some(function(c) { return c.cardIndex === idx && c.option === opt; });
                    html += '<button class="clue-opt-btn' + (sel ? ' selected' : '') + '" ' +
                        (used ? 'disabled' : 'onclick="selectClue(' + idx + ',\'' + opt + '\')"') + '>' + opt + '</button>';
                });
                html += '</div>';

                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        function selectClue(cardIdx, option) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªØ¬Ø§ÙˆØ² 6 Ø£Ø¯Ù„Ø©
            var cluesInRound = gameState.clues.filter(function(c) { return c.round === gameState.currentRound; }).length;
            if (cluesInRound >= 6 && !gameState.clues.some(function(c) { return c.cardIndex === cardIdx; })) {
                alert('Ù„Ù‚Ø¯ Ù‚Ø¯Ù…Øª 6 Ø£Ø¯Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©');
                return;
            }

            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† ÙˆØ¬Ø¯
            gameState.clues = gameState.clues.filter(function(c) { return c.cardIndex !== cardIdx; });

            gameState.clues.push({
                cardIndex: cardIdx,
                cardTitle: gameState.forensicClueCards[cardIdx].title,
                option: option,
                round: gameState.currentRound
            });

            db.ref('rooms/' + gameState.roomCode + '/clues').set(gameState.clues);
            renderForensicCards();
            updateRoundButton();
        }

        function updateRoundButton() {
            var btn = document.getElementById('nextRoundBtn');
            var status = document.getElementById('roundStatus');
            var cluesCount = gameState.clues.length;

            status.textContent = ' (' + cluesCount + '/6 Ø£Ø¯Ù„Ø©)';

            if (cluesCount >= 6 && gameState.currentRound < 3) {
                btn.style.display = 'block';
                btn.textContent = 'ğŸ”„ Ø§Ù„Ø¬ÙˆÙ„Ø© ' + (gameState.currentRound + 1) + ' (ØªØ¨Ø¯ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©)';
            } else {
                btn.style.display = 'none';
            }
        }

        function nextRound() {
            if (gameState.currentRound >= 3) return;

            gameState.currentRound++;
            
            // ØªØ¨Ø¯ÙŠÙ„ Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
            var usedIndices = gameState.clues.map(function(c) { return c.cardIndex; });
            var availableCards = CLUE_CARDS.filter(function(c) {
                return !gameState.forensicClueCards.includes(c);
            });

            if (availableCards.length > 0) {
                var randomIdx = usedIndices[Math.floor(Math.random() * usedIndices.length)];
                var newCard = availableCards[Math.floor(Math.random() * availableCards.length)];
                gameState.forensicClueCards[randomIdx] = newCard;
                
                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
                gameState.clues = gameState.clues.filter(function(c) { return c.cardIndex !== randomIdx; });
            }

            db.ref('rooms/' + gameState.roomCode).update({
                currentRound: gameState.currentRound,
                forensicClueCards: gameState.forensicClueCards,
                clues: gameState.clues
            });

            document.getElementById('currentRound').textContent = gameState.currentRound;
            renderForensicCards();
            updateRoundButton();
        }

        function displayPublicClues() {
            var container = document.getElementById('publicCluesList');
            
            if (!gameState.clues || gameState.clues.length === 0) {
                container.innerHTML = '<p style="color:#aaa;">Ø§Ù†ØªØ¸Ø± Ø£Ø¯Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ...</p>';
                return;
            }

            container.innerHTML = '';
            gameState.clues.forEach(function(clue) {
                var div = document.createElement('div');
                div.className = 'clue-item';
                div.innerHTML = '<strong>' + clue.cardTitle + ':</strong> ' + clue.option;
                container.appendChild(div);
            });
        }

        // =============== Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ§Ù„ØªØµÙˆÙŠØª ===============
        function renderPlayers() {
            var container = document.getElementById('playersVotingList');
            container.innerHTML = '';

            gameState.players.forEach(function(player) {
                // Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù†ÙØ³Ù‡
                if (player.id === gameState.oderId) return;

                var card = document.createElement('div');
                card.className = 'player-card';
                card.id = 'pcard_' + player.id;

                // Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ Ù…Ø¹Ø±ÙˆÙ Ù„Ù„Ø¬Ù…ÙŠØ¹
                if (player.role === 'forensic') {
                    card.classList.add('is-forensic');
                }

                var html = '<div class="player-header">';
                html += '<span class="player-name' + (player.role === 'forensic' ? ' forensic-badge' : '') + '">' + 
                    player.name + (player.role === 'forensic' ? ' ğŸ”¬' : '') + '</span>';
                html += '</div>';

                // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø¥Ù„Ø§ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ)
                if (player.role !== 'forensic') {
                    html += '<div class="player-items">';
                    
                    html += '<div style="width:100%;margin-bottom:5px;color:#e74c3c;font-weight:bold;">âš”ï¸ Ø§Ù„Ø£Ø³Ù„Ø­Ø©:</div>';
                    player.weapons.forEach(function(w) {
                        var sel = selectedVotes[player.id] && selectedVotes[player.id].weapon === w;
                        html += '<button class="item-btn weapon' + (sel ? ' selected' : '') + '" onclick="selectVoteItem(\'' + player.id + '\',\'weapon\',\'' + w + '\')">' + w + '</button>';
                    });

                    html += '<div style="width:100%;margin:10px 0 5px;color:#3498db;font-weight:bold;">ğŸ” Ø§Ù„Ø£Ø¯Ù„Ø©:</div>';
                    player.evidence.forEach(function(e) {
                        var sel = selectedVotes[player.id] && selectedVotes[player.id].evidence === e;
                        html += '<button class="item-btn evidence' + (sel ? ' selected' : '') + '" onclick="selectVoteItem(\'' + player.id + '\',\'evidence\',\'' + e + '\')">' + e + '</button>';
                    });

                    html += '</div>';

                    // Ù‚Ø³Ù… Ø§Ù„ØªØµÙˆÙŠØª
                    html += '<div class="vote-section" id="voteSec_' + player.id + '">';
                    html += '<button class="btn-danger btn-full" onclick="submitVote(\'' + player.id + '\',\'' + player.name + '\')">ğŸ—³ï¸ ØªØµÙˆÙŠØª Ø¹Ù„Ù‰ ' + player.name + '</button>';
                    html += '</div>';
                }

                // Ø¹Ø±Ø¶ Ø§Ù„ØªØµÙˆÙŠØªØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨
                var votesOnPlayer = gameState.votes.filter(function(v) { return v.suspectName === player.name; });
                if (votesOnPlayer.length > 0) {
                    html += '<div style="margin-top:10px;">';
                    votesOnPlayer.forEach(function(v) {
                        html += '<div class="vote-info">' +
                            '<strong>ğŸ—³ï¸ ' + v.voterName + ' ÙŠØªÙ‡Ù…:</strong><br>' +
                            'âš”ï¸ ' + v.weapon + ' | ğŸ” ' + v.evidence +
                            '</div>';
                    });
                    html += '</div>';
                }

                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        function selectVoteItem(playerId, type, value) {
            if (!selectedVotes[playerId]) selectedVotes[playerId] = {};
            selectedVotes[playerId][type] = value;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            var card = document.getElementById('pcard_' + playerId);
            card.querySelectorAll('.item-btn.' + type).forEach(function(btn) {
                btn.classList.remove('selected');
                if (btn.textContent === value) btn.classList.add('selected');
            });

            // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø²Ø± Ø§Ù„ØªØµÙˆÙŠØª
            var vote = selectedVotes[playerId];
            var sec = document.getElementById('voteSec_' + playerId);
            if (vote.weapon && vote.evidence) {
                card.classList.add('has-selection');
            } else {
                card.classList.remove('has-selection');
            }
        }

        function submitVote(playerId, playerName) {
            var vote = selectedVotes[playerId];
            if (!vote || !vote.weapon || !vote.evidence) {
                alert('Ø§Ø®ØªØ± Ø§Ù„Ø³Ù„Ø§Ø­ ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            var isCorrect = playerName === gameState.murdererName &&
                vote.weapon === gameState.murderWeapon &&
                vote.evidence === gameState.murderEvidence;

            var voteData = {
                oderId: gameState.oderId,
                voterName: gameState.playerName,
                suspectId: playerId,
                suspectName: playerName,
                weapon: vote.weapon,
                evidence: vote.evidence,
                isCorrect: isCorrect,
                time: Date.now()
            };

            if (!gameState.votes) gameState.votes = [];
            gameState.votes.push(voteData);

            if (isCorrect) {
                gameState.gamePhase = 'witness_guess';
                gameState.correctVoterName = gameState.playerName;
                db.ref('rooms/' + gameState.roomCode).update({
                    votes: gameState.votes,
                    gamePhase: 'witness_guess',
                    correctVoterName: gameState.playerName
                });
            } else {
                db.ref('rooms/' + gameState.roomCode + '/votes').set(gameState.votes);
            }

            // Ù…Ø³Ø­ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            delete selectedVotes[playerId];
            renderPlayers();
        }

        // =============== Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù„Ø¹Ø¨Ø© ===============
        function showWitnessGuessPhase() {
            var results = document.getElementById('gameResults');
            results.classList.remove('hidden');
            results.className = 'results-box';

            var html = '<div class="result-icon">ğŸ¯</div>' +
                '<div class="result-title">ØªÙ… ÙƒØ´Ù Ø§Ù„Ù‚Ø§ØªÙ„!</div>' +
                '<p><strong>' + (gameState.correctVoterName || 'Ø£Ø­Ø¯ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ†') + '</strong> Ø§ÙƒØªØ´Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©!</p>' +
                '<div class="truth-reveal">' +
                '<p>ğŸ”ª <strong>Ø§Ù„Ù‚Ø§ØªÙ„:</strong> ' + gameState.murdererName + '</p>' +
                '<p>âš”ï¸ <strong>Ø§Ù„Ø³Ù„Ø§Ø­:</strong> ' + gameState.murderWeapon + '</p>' +
                '<p>ğŸ” <strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> ' + gameState.murderEvidence + '</p>' +
                '</div>';

            if (gameState.role === 'murderer') {
                html += '<div class="alert alert-danger">' +
                    '<h3>âš ï¸ ØªÙ… Ø§ØµØ·ÙŠØ§Ø¯Ùƒ!</h3>' +
                    '<p>ÙØ±ØµØªÙƒ Ø§Ù„Ø£Ø®ÙŠØ±Ø©: Ø­Ø¯Ø¯ Ø§Ù„Ø´Ø§Ù‡Ø¯ Ù„Ù„ÙÙˆØ²!</p>' +
                    '</div>' +
                    '<select id="witnessGuess" style="margin:10px 0;">';
                
                gameState.players.forEach(function(p) {
                    if (p.role !== 'murderer' && p.role !== 'accomplice' && p.role !== 'forensic') {
                        html += '<option value="' + p.name + '">' + p.name + '</option>';
                    }
                });

                html += '</select>' +
                    '<button onclick="guessWitness()" class="btn-danger btn-full">ØªØ£ÙƒÙŠØ¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø§Ù‡Ø¯</button>';
            } else {
                html += '<div class="alert alert-info"><p>â³ Ø§Ù„Ù‚Ø§ØªÙ„ ÙŠØ­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø§Ù‡Ø¯...</p></div>';
            }

            results.innerHTML = html;

            // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            document.getElementById('playersSection').classList.add('hidden');
            document.getElementById('forensicPanel').classList.add('hidden');
        }

        function guessWitness() {
            var guess = document.getElementById('witnessGuess').value;
            
            gameState.witnessGuess = guess;
            gameState.gamePhase = (guess === gameState.witnessName) ? 'murderer_wins' : 'investigators_win';

            db.ref('rooms/' + gameState.roomCode).update({
                witnessGuess: guess,
                gamePhase: gameState.gamePhase
            });
        }

        function showFinalResult() {
            var results = document.getElementById('gameResults');
            results.classList.remove('hidden');

            var murdererWins = gameState.gamePhase === 'murderer_wins';
            results.className = 'results-box ' + (murdererWins ? 'lose' : 'win');

            var html = '<div class="result-icon">' + (murdererWins ? 'ğŸ”ª' : 'ğŸ‰') + '</div>' +
                '<div class="result-title">' + (murdererWins ? 'Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆØ§Ù„Ø´Ø±ÙŠÙƒ ÙŠÙÙˆØ²Ø§Ù†!' : 'Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ† ÙŠÙÙˆØ²ÙˆÙ†!') + '</div>';

            if (murdererWins) {
                html += '<p>Ø§Ù„Ù‚Ø§ØªÙ„ Ù†Ø¬Ø­ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø§Ù‡Ø¯!</p>';
            } else {
                html += '<p>Ø§Ù„Ù‚Ø§ØªÙ„ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø§Ù‡Ø¯!</p>';
            }

            html += '<div class="truth-reveal">' +
                '<p>ğŸ”ª <strong>Ø§Ù„Ù‚Ø§ØªÙ„:</strong> ' + gameState.murdererName + '</p>' +
                '<p>ğŸ¤ <strong>Ø§Ù„Ø´Ø±ÙŠÙƒ:</strong> ' + gameState.accompliceName + '</p>' +
                '<p>ğŸ‘ï¸ <strong>Ø§Ù„Ø´Ø§Ù‡Ø¯:</strong> ' + gameState.witnessName + '</p>' +
                '<p>ğŸ”¬ <strong>Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ:</strong> ' + gameState.forensicName + '</p>' +
                '<hr style="margin:10px 0;border-color:rgba(255,255,255,0.2);">' +
                '<p>âš”ï¸ <strong>Ø³Ù„Ø§Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©:</strong> ' + gameState.murderWeapon + '</p>' +
                '<p>ğŸ” <strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> ' + gameState.murderEvidence + '</p>';

            if (gameState.witnessGuess) {
                html += '<hr style="margin:10px 0;border-color:rgba(255,255,255,0.2);">' +
                    '<p>ğŸ¯ <strong>ØªØ®Ù…ÙŠÙ† Ø§Ù„Ù‚Ø§ØªÙ„:</strong> ' + gameState.witnessGuess + 
                    (gameState.witnessGuess === gameState.witnessName ? ' âœ…' : ' âŒ') + '</p>';
            }

            html += '</div>' +
                '<button onclick="location.reload()" class="btn-full btn-success" style="margin-top:20px;">ğŸ”„ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>';

            results.innerHTML = html;

            // Ø¥Ø®ÙØ§Ø¡ Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±
            document.getElementById('playersSection').classList.add('hidden');
            document.getElementById('forensicPanel').classList.add('hidden');
            document.getElementById('publicCluesSection').classList.add('hidden');
            document.getElementById('myItems').classList.add('hidden');
        }

        // =============== Firebase Listener ===============
        var roomRef = null;

        function listenToRoom() {
            if (roomRef) roomRef.off();
            roomRef = db.ref('rooms/' + gameState.roomCode);

            roomRef.on('value', function(snap) {
                if (!snap.exists()) return;
                var data = snap.val();

                gameState.players = data.players || [];
                gameState.maxPlayers = data.maxPlayers;

                if (!gameState.gameStarted && !data.gameStarted) {
                    updateLobby();
                    return;
                }

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                gameState.gameStarted = data.gameStarted;
                gameState.murderWeapon = data.murderWeapon;
                gameState.murderEvidence = data.murderEvidence;
                gameState.murdererName = data.murdererName;
                gameState.accompliceName = data.accompliceName;
                gameState.witnessName = data.witnessName;
                gameState.forensicName = data.forensicName;
                gameState.forensicClueCards = data.forensicClueCards || [];
                gameState.clues = data.clues || [];
                gameState.votes = data.votes || [];
                gameState.currentRound = data.currentRound || 1;
                gameState.murdererReady = data.murdererReady;
                gameState.correctVoterName = data.correctVoterName;
                gameState.witnessGuess = data.witnessGuess;

                var oldPhase = gameState.gamePhase;
                gameState.gamePhase = data.gamePhase || 'waiting';

                // Ø¹Ø±Ø¶ Ø§Ù„Ù„Ø¹Ø¨Ø©
                if (gameState.gameStarted) {
                    showGame();
                }
            });
        }

        // =============== ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ===============
        window.onload = function() {
            if (loadSession()) {
                db.ref('rooms/' + gameState.roomCode).once('value').then(function(snap) {
                    if (snap.exists()) {
                        var data = snap.val();
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù„Ø§Ø¹Ø¨
                        var found = data.players && data.players.some(function(p) { return p.id === gameState.oderId; });
                        
                        if (found) {
                            gameState.players = data.players;
                            gameState.maxPlayers = data.maxPlayers;
                            gameState.gameStarted = data.gameStarted;
                            gameState.murderWeapon = data.murderWeapon;
                            gameState.murderEvidence = data.murderEvidence;
                            gameState.murdererName = data.murdererName;
                            gameState.accompliceName = data.accompliceName;
                            gameState.witnessName = data.witnessName;
                            gameState.forensicName = data.forensicName;
                            gameState.forensicClueCards = data.forensicClueCards || [];
                            gameState.clues = data.clues || [];
                            gameState.votes = data.votes || [];
                            gameState.gamePhase = data.gamePhase || 'waiting';
                            gameState.currentRound = data.currentRound || 1;
                            gameState.correctVoterName = data.correctVoterName;
                            gameState.witnessGuess = data.witnessGuess;

                            if (data.gameStarted) {
                                showGame();
                            } else {
                                showScreen('lobbyScreen');
                                updateLobby();
                                if (gameState.isHost) {
                                    document.getElementById('hostControls').classList.remove('hidden');
                                }
                            }
                            
                            listenToRoom();
                        }
                    }
                });
            }
        };
    </script>
</body>
</html>
