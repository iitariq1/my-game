<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒÙ†Ø¨Ø©</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#F3EDE4;--card:#fff;--card2:#FAF6F0;--bdr:#E0D6C8;--gold:#C47F17;--goldL:#FFF6E0;--red:#C0392B;--redL:#FDEDED;--blue:#2471A3;--blueL:#EBF5FB;--grn:#1E8449;--grnL:#E8F8F0;--txt:#3B2F1E;--txtM:#6B5D4E;--txtD:#A09585;--org:#D4820A;--orgL:#FFF3E0;--sh:0 2px 10px rgba(60,40,10,.07);--R:14px;--r:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--txt);min-height:100dvh;display:flex;justify-content:center;padding:10px}
.app{width:100%;max-width:460px;display:flex;flex-direction:column;min-height:calc(100dvh - 20px)}
.scr{display:none;flex-direction:column;flex:1}.scr.on{display:flex}
.hdr{text-align:center;padding:14px 0 10px}.hdr h1{font-size:1.5em;font-weight:900}.hdr .sub{font-size:.8em;color:var(--txtD);margin-top:2px}
.card{background:var(--card);border:1px solid var(--bdr);border-radius:var(--R);padding:16px;margin-bottom:10px;box-shadow:var(--sh)}
.fld{margin-bottom:12px}.fld label{display:block;font-size:.85em;font-weight:700;margin-bottom:5px}
.fld input,.fld select{width:100%;padding:11px 14px;background:var(--card);border:1.5px solid var(--bdr);border-radius:var(--r);color:var(--txt);font-family:inherit;font-size:.95em;font-weight:500;outline:none}
.fld input:focus,.fld select:focus{border-color:var(--gold);box-shadow:0 0 0 3px rgba(196,127,23,.1)}
.fld input::placeholder{color:var(--txtD)}.fld select option{background:var(--card)}
.btn{width:100%;padding:13px;border:none;border-radius:var(--r);font-family:inherit;font-size:1em;font-weight:700;cursor:pointer;transition:all .15s;margin-top:6px}
.btn:active:not(:disabled){transform:scale(.97)}.btn:disabled{opacity:.4;cursor:not-allowed}
.bp{background:linear-gradient(135deg,#E8960F,#D47E08);color:#fff;box-shadow:0 3px 12px rgba(212,130,10,.25)}
.bo{background:var(--card);border:1.5px solid var(--bdr);color:var(--txtM)}
.bg{background:var(--grn);color:#fff}.br{background:var(--red);color:#fff}
.rcb{text-align:center;padding:14px;background:var(--goldL);border:1.5px solid #E8D5A0;border-radius:var(--R);margin-bottom:12px;box-shadow:var(--sh)}
.rcb .lb{font-size:.78em;color:var(--gold);font-weight:700}.rcb .code{font-size:2.4em;font-weight:900;color:var(--gold);letter-spacing:10px}
.chip{display:inline-flex;align-items:center;gap:5px;padding:5px 10px;background:var(--card2);border:1px solid var(--bdr);border-radius:20px;font-size:.82em;font-weight:600;margin:3px}
.dot{width:8px;height:8px;border-radius:50%}.dr{background:var(--red)}.db{background:var(--blue)}.dg{background:var(--gold)}
.tsg{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:8px 0}
.tsb{padding:14px 8px;border-radius:var(--R);font-family:inherit;font-size:.95em;font-weight:700;cursor:pointer;border:2px solid transparent;transition:all .2s;text-align:center}
.tsb.rt{background:var(--redL);color:var(--red);border-color:rgba(192,57,43,.15)}
.tsb.bt{background:var(--blueL);color:var(--blue);border-color:rgba(36,113,163,.15)}
.tsb.sel{border-color:var(--gold)!important;box-shadow:0 0 0 3px rgba(196,127,23,.15)}
.tsb:active{transform:scale(.96)}
.gtb{display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:6px;margin-bottom:8px}
.tsc{padding:8px;border-radius:var(--r);text-align:center;box-shadow:var(--sh)}
.tsc.r{background:var(--redL);border:1.5px solid rgba(192,57,43,.15)}
.tsc.b{background:var(--blueL);border:1.5px solid rgba(36,113,163,.15)}
.tsc .tn{font-size:.7em;font-weight:700;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.tsc.r .tn{color:var(--red)}.tsc.b .tn{color:var(--blue)}
.tsc .tv{font-size:1.4em;font-weight:900;line-height:1}.tsc.r .tv{color:var(--red)}.tsc.b .tv{color:var(--blue)}
.vb{font-size:.75em;font-weight:900;color:var(--txtD);padding:4px 8px;border-radius:20px;border:1px solid var(--bdr);background:var(--card)}
.mpl{display:flex;flex-wrap:wrap;gap:3px;justify-content:center;margin-top:3px}
.mp{font-size:.63em;padding:2px 5px;border-radius:8px;font-weight:600;background:rgba(0,0,0,.04);color:var(--txtD)}.mp.oc{opacity:.5;background:var(--goldL);color:var(--gold)}
.couch{background:var(--goldL);border:1.5px solid #E8D5A0;border-radius:var(--R);padding:12px;margin-bottom:8px;box-shadow:var(--sh)}
.couch .clb{text-align:center;font-size:.78em;font-weight:800;color:var(--gold);letter-spacing:2px;margin-bottom:8px}
.cseats{display:flex;justify-content:center;gap:8px;flex-wrap:wrap}
.cseat{display:inline-flex;align-items:center;justify-content:center;gap:4px;padding:5px 12px;border-radius:20px;font-size:.78em;font-weight:700}
.cseat.fr{background:var(--red);color:#fff}.cseat.fb{background:var(--blue);color:#fff}
.cseat.empty{width:36px;height:36px;border-radius:50%;border:2px dashed #D0C4B4;color:#C0B4A4;font-size:.7em;padding:0}
.cseat.me{box-shadow:0 0 0 3px rgba(196,127,23,.4)}
.qcard{background:var(--card);border:1.5px solid var(--bdr);border-radius:var(--R);padding:16px;margin-bottom:8px;text-align:center;box-shadow:var(--sh)}
.qcat{font-size:.72em;font-weight:700;color:var(--gold);letter-spacing:1px;margin-bottom:6px}
.qtxt{font-size:1.08em;font-weight:700;line-height:1.5}
.tbar{text-align:center;margin-bottom:8px}
.tc{display:inline-flex;align-items:center;justify-content:center;width:56px;height:56px;border-radius:50%;border:3px solid var(--gold);font-size:1.5em;font-weight:900;color:var(--gold);background:var(--card);box-shadow:var(--sh);transition:all .3s}
.tc.dng{border-color:var(--red);color:var(--red);animation:tp .5s infinite}
.tc.sm{width:44px;height:44px;font-size:1.2em;border-color:var(--org);color:var(--org)}
.tc.sm.dng{border-color:var(--red);color:var(--red)}
@keyframes tp{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
.buzzb{width:100%;padding:20px;border:none;border-radius:var(--R);font-family:inherit;font-size:1.25em;font-weight:800;cursor:pointer;background:linear-gradient(135deg,#F0A020,#E08810);color:#fff;box-shadow:0 4px 18px rgba(240,160,32,.3);transition:all .15s;margin-bottom:8px}
.buzzb:active:not(:disabled){transform:scale(.96)}
.buzzb:disabled{background:#E0D4C4;color:#B0A494;box-shadow:none;cursor:not-allowed}
.sts{padding:8px 12px;border-radius:var(--r);font-size:.85em;font-weight:700;text-align:center;margin-bottom:8px}
.sts.i{background:var(--blueL);color:var(--blue)}.sts.s{background:var(--grnL);color:var(--grn)}
.sts.e{background:var(--redL);color:var(--red)}.sts.w{background:var(--orgL);color:var(--org)}
.opts{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px}
.ob{padding:12px 8px;background:var(--card);border:1.5px solid var(--bdr);border-radius:var(--r);font-family:inherit;font-size:.9em;font-weight:700;color:var(--txt);cursor:pointer;transition:all .2s;text-align:center;min-height:50px;display:flex;align-items:center;justify-content:center;box-shadow:var(--sh)}
.ob:hover:not(:disabled){border-color:var(--gold);background:var(--goldL)}
.ob:active:not(:disabled){transform:scale(.96)}.ob:disabled{opacity:.35;cursor:not-allowed}
.aia{margin-bottom:8px}
.aia input{width:100%;padding:12px;background:var(--card);border:2px solid var(--gold);border-radius:var(--r);color:var(--txt);font-family:inherit;font-size:1em;font-weight:700;text-align:center;outline:none;margin-bottom:6px}
.aia input::placeholder{color:var(--txtD)}
.chg{display:grid;gap:8px;margin-bottom:8px}
.chb{padding:14px;border:none;border-radius:var(--r);font-family:inherit;font-size:.95em;font-weight:700;cursor:pointer;transition:all .2s}
.chb:active{transform:scale(.97)}.chb.sit{background:var(--grn);color:#fff}.chb.pull{background:var(--red);color:#fff}
.bzi{padding:6px 12px;border-radius:var(--r);background:var(--orgL);text-align:center;font-size:.82em;font-weight:700;color:var(--org);margin-bottom:8px}
.vic{display:none;text-align:center;padding:40px 16px;flex:1;justify-content:center;align-items:center;flex-direction:column}
.vic.on{display:flex}
.vic .tr{font-size:4em;margin-bottom:12px;animation:bnc 1.5s infinite}
@keyframes bnc{0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
.vic h2{font-size:1.6em;font-weight:900;color:var(--gold);margin-bottom:20px}
.spc{flex:1}.hid{display:none!important}
/* Replay team select overlay */
.rto{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:100;justify-content:center;align-items:center}
.rto.on{display:flex}
.rto .inner{background:var(--card);border-radius:var(--R);padding:24px;width:90%;max-width:380px;box-shadow:0 8px 30px rgba(0,0,0,.15)}
</style>
</head>
<body>
<div class="app">

<!-- WELCOME -->
<div class="scr on" id="scrWelcome">
<div style="flex:1;display:flex;flex-direction:column;justify-content:center">
<div class="hdr"><h1>ğŸ›‹ï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒÙ†Ø¨Ø©</h1><div class="sub">Ù…Ù† ÙŠÙ…Ù„Ø£ Ø§Ù„ÙƒÙ†Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹ ÙŠÙÙˆØ²!</div></div>
<div style="padding:0 10px">
<button class="btn bp" onclick="showScr('scrCreate')">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
<button class="btn bo" onclick="showScr('scrJoin')">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</button>
<button class="btn bo" onclick="window.location.href='index.html'">
Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨ â†©ï¸ </button>
</div></div></div>

<!-- CREATE -->
<div class="scr" id="scrCreate">
<div class="hdr"><h1>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h1></div>
<div class="card">
<div class="fld"><label>Ø§Ø³Ù…Ùƒ</label><input id="hostName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ"></div>
<div class="fld"><label>Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„</label><input id="t1n" value="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±"></div>
<div class="fld"><label>Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ</label><input id="t2n" value="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚"></div>
<div class="fld"><label>Ø¹Ø¯Ø¯ Ù„Ø§Ø¹Ø¨ÙŠ ÙƒÙ„ ÙØ±ÙŠÙ‚ (= Ø­Ø¬Ù… Ø§Ù„ÙƒÙ†Ø¨Ø©)</label><select id="tsz"><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select></div>
<button class="btn bp" onclick="createRoom()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©</button>
<button class="btn bo" onclick="showScr('scrWelcome')">Ø±Ø¬ÙˆØ¹</button>
</div></div>

<!-- JOIN -->
<div class="scr" id="scrJoin">
<div class="hdr"><h1>Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</h1></div>
<div class="card">
<div class="fld"><label>Ø§Ø³Ù…Ùƒ</label><input id="pName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ"></div>
<div class="fld"><label>ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©</label><input id="pCode" placeholder="0000" maxlength="4" inputmode="numeric"></div>
<button class="btn bp" onclick="joinRoom()">Ø§Ù†Ø¶Ù…</button>
<button class="btn bo" onclick="showScr('scrWelcome')">Ø±Ø¬ÙˆØ¹</button>
</div></div>

<!-- TEAM SELECT -->
<div class="scr" id="scrTeam">
<div class="hdr"><h1>Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h1><div class="sub">Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="wpn"></span></div></div>
<div class="card"><div class="tsg" id="tsBtns"></div></div></div>

<!-- LOBBY -->
<div class="scr" id="scrLobby">
<div class="hdr"><h1>ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h1></div>
<div class="rcb"><div class="lb">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©</div><div class="code" id="drc"></div></div>
<div class="card"><div style="font-size:.8em;font-weight:700;color:var(--txtD);margin-bottom:8px">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</div><div class="tsg" id="htBtns"></div></div>
<div class="card"><div style="font-size:.8em;font-weight:700;color:var(--txtD);margin-bottom:8px">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† (<span id="pc">0</span>)</div><div id="lpl" style="display:flex;flex-wrap:wrap;gap:4px"></div></div>
<div class="spc"></div>
<button class="btn bp" onclick="startGame()" id="sgBtn" disabled>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
</div>

<!-- WAITING -->
<div class="scr" id="scrWait">
<div class="hdr"><h1>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡</h1><div class="sub">Ø£Ù†Øª ÙÙŠ <span id="wtn" style="color:var(--gold);font-weight:700"></span></div></div>
<div class="card"><div style="font-size:.8em;font-weight:700;color:var(--txtD);margin-bottom:8px">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</div><div id="wpl" style="display:flex;flex-wrap:wrap;gap:4px"></div></div></div>

<!-- GAME -->
<div class="scr" id="scrGame">
<div id="gTop" class="gtb">
<div class="tsc r"><div class="tn" id="gt1n"></div><div class="tv" id="gt1s">0</div><div class="mpl" id="gt1p"></div></div>
<div class="vb">VS</div>
<div class="tsc b"><div class="tn" id="gt2n"></div><div class="tv" id="gt2s">0</div><div class="mpl" id="gt2p"></div></div>
</div>
<div class="couch" id="couchSec"><div class="clb">ğŸ›‹ï¸ ÙƒÙ†Ø¨Ø© Ø§Ù„ÙÙˆØ² (<span id="couchCnt">0</span>/<span id="couchMax">2</span>)</div><div class="cseats" id="couchSeats"></div></div>
<div id="gContent">
<div class="qcard hid" id="qCard"><div class="qcat" id="qCat"></div><div class="qtxt" id="qTxt"></div></div>
<div class="tbar hid" id="tBar"><div class="tc" id="tCirc">30</div></div>
<div class="bzi hid" id="bzInd"></div>
<div class="sts i" id="gSts">Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø³Ø¤Ø§Ù„...</div>
<button class="buzzb hid" id="bzBtn" onclick="buzzIn()" disabled>ğŸ”” Ø§Ø¶ØºØ· Ø§Ù„Ø¬Ø±Ø³!</button>
<div class="aia hid" id="aiArea"><div class="tbar"><div class="tc sm" id="atCirc">5</div></div><input id="tAns" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ..." autocomplete="off"><button class="btn bg" onclick="submitAns()">Ø¥Ø±Ø³Ø§Ù„</button></div>
<div class="opts hid" id="optsG"></div>
<div class="chg hid" id="chG"></div>
</div>
<div class="vic" id="vicOv"><div class="tr">ğŸ†</div><h2 id="vicMsg"></h2>
<button class="btn bp" onclick="askReplay()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨ ğŸ”„</button>
<button class="btn bo" onclick="window.location.href='index.html'">Ø§Ù„Ø®Ø±ÙˆØ¬ â†©ï¸</button>
</div>
<div class="spc"></div>
<div class="hid" id="hNext"><button class="btn bp" onclick="nextQ()">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â–¶ï¸</button></div>
</div>

<!-- REPLAY TEAM SELECT OVERLAY -->
<div class="rto" id="replayOv">
<div class="inner">
<div class="hdr"><h1>Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h1><div class="sub">ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ± ÙØ±ÙŠÙ‚Ùƒ Ù‚Ø¨Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div></div>
<div class="tsg" id="rpBtns"></div>
<button class="btn bp" id="rpStart" onclick="confirmReplay()" style="margin-top:10px">ØªØ£ÙƒÙŠØ¯ ÙˆØ¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© â–¶ï¸</button>
<div style="text-align:center;margin-top:8px;font-size:.75em;color:var(--txtD)" id="rpWait" class="hid">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¶ÙŠÙ...</div>
</div></div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script>
firebase.initializeApp({
  apiKey:"AIzaSyBUXlgxP463b18dg9_Og_8EcMDLfLIr76o",
  authDomain:"team-cc63c.firebaseapp.com",
  databaseURL:"https://team-cc63c-default-rtdb.europe-west1.firebasedatabase.app/",
  projectId:"team-cc63c",
  storageBucket:"team-cc63c.firebasestorage.app",
  messagingSenderId:"511582595742",
  appId:"1:511582595742:web:3e21273dcf49bf26d7298f"
});
const db = firebase.database();

/* â•â•â•â•â•â•â• QUESTIONS â•â•â•â•â•â•â• */
const ALL_Q = [
  {cat:"Ø¯ÙŠÙ†ÙŠØ©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø³ÙˆØ± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ",opts:["114 Ø³ÙˆØ±Ø©","110 Ø³ÙˆØ±Ø©","120 Ø³ÙˆØ±Ø©","100 Ø³ÙˆØ±Ø©"],c:0},
  {cat:"Ø¯ÙŠÙ†ÙŠØ©",q:"Ù…Ø§ Ù‡ÙŠ Ø£Ø·ÙˆÙ„ Ø³ÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ",opts:["Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ù‚Ø±Ø©","Ø³ÙˆØ±Ø© Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†","Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø³Ø§Ø¡","Ø³ÙˆØ±Ø© Ø§Ù„Ø£Ø¹Ø±Ø§Ù"],c:0},
  {cat:"Ø¯ÙŠÙ†ÙŠØ©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŸ",opts:["5","4","6","7"],c:0},
  {cat:"Ø¯ÙŠÙ†ÙŠØ©",q:"Ù…Ù† Ù‡Ùˆ Ø®Ø§ØªÙ… Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡ØŸ",opts:["Ù…Ø­Ù…Ø¯ ï·º","Ø¹ÙŠØ³Ù‰ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…","Ù…ÙˆØ³Ù‰ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…","Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…"],c:0},
  {cat:"Ø¯ÙŠÙ†ÙŠØ©",q:"ÙÙŠ Ø£ÙŠ Ø´Ù‡Ø± ÙÙØ±Ø¶ Ø§Ù„ØµÙŠØ§Ù…ØŸ",opts:["Ø±Ù…Ø¶Ø§Ù†","Ø´Ø¹Ø¨Ø§Ù†","Ø±Ø¬Ø¨","Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©"],c:0},
  {cat:"Ø¯ÙŠÙ†ÙŠØ©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥ÙŠÙ…Ø§Ù†ØŸ",opts:["6","5","7","4"],c:0},
  {cat:"Ø¯ÙŠÙ†ÙŠØ©",q:"Ù…Ø§ Ø£ÙˆÙ„ Ù…Ø§ Ù†Ø²Ù„ Ù…Ù† Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ",opts:["Ø§Ù‚Ø±Ø£","Ø§Ù„ÙØ§ØªØ­Ø©","Ø§Ù„Ù…Ø¯Ø«Ø±","Ø§Ù„Ø¨Ø³Ù…Ù„Ø©"],c:0},
  {cat:"Ø¯ÙŠÙ†ÙŠØ©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡ Ø§Ù„Ù…Ø°ÙƒÙˆØ±ÙŠÙ† ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ",opts:["25","24","26","30"],c:0},
  {cat:"Ø¯ÙŠÙ†ÙŠØ©",q:"Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø³ÙˆØ±Ø© Ø§Ù„ØªÙŠ ØªØ¹Ø¯Ù„ Ø«Ù„Ø« Ø§Ù„Ù‚Ø±Ø¢Ù†ØŸ",opts:["Ø§Ù„Ø¥Ø®Ù„Ø§Øµ","Ø§Ù„ÙØ§ØªØ­Ø©","Ø§Ù„Ø¨Ù‚Ø±Ø©","ÙŠØ³"],c:0},
  {cat:"Ø«Ù‚Ø§ÙÙŠØ©",q:"Ù…Ù† Ù‡Ùˆ Ù…Ø®ØªØ±Ø¹ Ø§Ù„Ù…ØµØ¨Ø§Ø­ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØŸ",opts:["ØªÙˆÙ…Ø§Ø³ Ø¥Ø¯ÙŠØ³ÙˆÙ†","Ù†ÙŠÙƒÙˆÙ„Ø§ ØªØ³Ù„Ø§","Ø¨Ù†Ø¬Ø§Ù…ÙŠÙ† ÙØ±Ø§Ù†ÙƒÙ„ÙŠÙ†","Ø£Ù„ÙƒØ³Ù†Ø¯Ø± Ø¨ÙŠÙ„"],c:0},
  {cat:"Ø«Ù‚Ø§ÙÙŠØ©",q:"Ù…Ø§ Ù‡ÙŠ Ø£ÙƒØ¨Ø± Ø¯ÙˆÙ„Ø© Ø¹Ø±Ø¨ÙŠØ© Ù…Ø³Ø§Ø­Ø©ØŸ",opts:["Ø§Ù„Ø¬Ø²Ø§Ø¦Ø±","Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©","Ø§Ù„Ø³ÙˆØ¯Ø§Ù†","Ù„ÙŠØ¨ÙŠØ§"],c:0},
  {cat:"Ø«Ù‚Ø§ÙÙŠØ©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ù‚Ø§Ø±Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ",opts:["7","6","5","8"],c:0},
  {cat:"Ø«Ù‚Ø§ÙÙŠØ©",q:"Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø£ÙƒØ«Ø± ØªØ­Ø¯Ø«Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ",opts:["Ø§Ù„ØµÙŠÙ†ÙŠØ©","Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©","Ø§Ù„Ø¥Ø³Ø¨Ø§Ù†ÙŠØ©","Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"],c:0},
  {cat:"Ø¬ØºØ±Ø§ÙÙŠØ©",q:"Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ØŸ",opts:["Ø·ÙˆÙƒÙŠÙˆ","ÙƒÙŠÙˆØªÙˆ","Ø£ÙˆØ³Ø§ÙƒØ§","ÙŠÙˆÙƒÙˆÙ‡Ø§Ù…Ø§"],c:0},
  {cat:"Ø¬ØºØ±Ø§ÙÙŠØ©",q:"Ù…Ø§ Ù‡Ùˆ Ø£Ø·ÙˆÙ„ Ù†Ù‡Ø± ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ",opts:["Ù†Ù‡Ø± Ø§Ù„Ù†ÙŠÙ„","Ù†Ù‡Ø± Ø§Ù„Ø£Ù…Ø§Ø²ÙˆÙ†","Ù†Ù‡Ø± Ø§Ù„Ù…Ø³ÙŠØ³ÙŠØ¨ÙŠ","Ù†Ù‡Ø± Ø§Ù„ÙŠØ§Ù†ØºØªØ³ÙŠ"],c:0},
  {cat:"Ø¬ØºØ±Ø§ÙÙŠØ©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø¯ÙˆÙ„ Ù…Ø¬Ù„Ø³ Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ø§Ù„Ø®Ù„ÙŠØ¬ÙŠØŸ",opts:["6","5","7","8"],c:0},
  {cat:"Ø¬ØºØ±Ø§ÙÙŠØ©",q:"Ù…Ø§ Ù‡ÙŠ Ø£ÙƒØ¨Ø± ØµØ­Ø±Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ",opts:["Ø§Ù„ØµØ­Ø±Ø§Ø¡ Ø§Ù„ÙƒØ¨Ø±Ù‰","Ø§Ù„Ø±Ø¨Ø¹ Ø§Ù„Ø®Ø§Ù„ÙŠ","ØºÙˆØ¨ÙŠ","ÙƒØ§Ù„Ø§Ù‡Ø§Ø±ÙŠ"],c:0},
  {cat:"Ø¬ØºØ±Ø§ÙÙŠØ©",q:"Ù…Ø§ Ù‡ÙŠ Ø£ØµØºØ± Ø¯ÙˆÙ„Ø© ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ",opts:["Ø§Ù„ÙØ§ØªÙŠÙƒØ§Ù†","Ù…ÙˆÙ†Ø§ÙƒÙˆ","Ø³Ø§Ù† Ù…Ø§Ø±ÙŠÙ†Ùˆ","Ù„ÙŠØ®ØªÙ†Ø´ØªØ§ÙŠÙ†"],c:0},
  {cat:"Ø±ÙŠØ§Ø¶ÙŠØ©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ù„Ø§Ø¹Ø¨ÙŠ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù… ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ØŸ",opts:["11","10","12","9"],c:0},
  {cat:"Ø±ÙŠØ§Ø¶ÙŠØ©",q:"ÙÙŠ Ø£ÙŠ Ø¹Ø§Ù… Ø£Ù‚ÙŠÙ…Øª Ø£ÙˆÙ„ Ø¨Ø·ÙˆÙ„Ø© ÙƒØ£Ø³ Ø¹Ø§Ù„Ù…ØŸ",opts:["1930","1928","1934","1926"],c:0},
  {cat:"Ø±ÙŠØ§Ø¶ÙŠØ©",q:"ÙƒÙ… Ù…Ø¯Ø© Ø§Ù„Ø´ÙˆØ· Ø§Ù„ÙˆØ§Ø­Ø¯ ÙÙŠ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù…ØŸ",opts:["45 Ø¯Ù‚ÙŠÙ‚Ø©","40 Ø¯Ù‚ÙŠÙ‚Ø©","50 Ø¯Ù‚ÙŠÙ‚Ø©","30 Ø¯Ù‚ÙŠÙ‚Ø©"],c:0},
  {cat:"Ø¹Ù„Ù…ÙŠØ©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ ÙƒÙˆØ§ÙƒØ¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©ØŸ",opts:["8","9","7","10"],c:0},
  {cat:"Ø¹Ù„Ù…ÙŠØ©",q:"Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ÙƒØ«Ø± ÙˆÙØ±Ø© ÙÙŠ Ø§Ù„ÙƒÙˆÙ†ØŸ",opts:["Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆØ¬ÙŠÙ†","Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†","Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†","Ø§Ù„Ù‡ÙŠÙ„ÙŠÙˆÙ…"],c:0},
  {cat:"Ø¹Ù„Ù…ÙŠØ©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø¹Ø¸Ø§Ù… Ø¬Ø³Ù… Ø§Ù„Ø¥Ù†Ø³Ø§Ù† Ø§Ù„Ø¨Ø§Ù„ØºØŸ",opts:["206","205","208","200"],c:0},
  {cat:"Ø¹Ù„Ù…ÙŠØ©",q:"Ù…Ø§ Ù‡Ùˆ Ø£ØµÙ„Ø¨ Ù…Ø¹Ø¯Ù† Ø¹Ù„Ù‰ ÙˆØ¬Ù‡ Ø§Ù„Ø£Ø±Ø¶ØŸ",opts:["Ø§Ù„Ø£Ù„Ù…Ø§Ø³","Ø§Ù„Ø­Ø¯ÙŠØ¯","Ø§Ù„ØªÙŠØªØ§Ù†ÙŠÙˆÙ…","Ø§Ù„Ø°Ù‡Ø¨"],c:0},
  {cat:"Ø¹Ø§Ù…Ø©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ù„ÙˆØ§Ù† Ù‚ÙˆØ³ Ù‚Ø²Ø­ØŸ",opts:["7","6","8","5"],c:0},
  {cat:"Ø¹Ø§Ù…Ø©",q:"Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø© Ø§Ù„Ø±Ø³Ù…ÙŠØ© Ù„Ù„ÙŠØ§Ø¨Ø§Ù†ØŸ",opts:["Ø§Ù„ÙŠÙ†","Ø§Ù„ÙˆÙˆÙ†","Ø§Ù„ÙŠÙˆØ§Ù†","Ø§Ù„Ø¯ÙˆÙ„Ø§Ø±"],c:0},
  {cat:"Ø¹Ø§Ù…Ø©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø­Ø±ÙˆÙ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŸ",opts:["28","26","30","27"],c:0},
  {cat:"Ø¹Ø§Ù…Ø©",q:"Ù…Ø§ Ù‡Ùˆ Ø§Ù„Ø­ÙŠÙˆØ§Ù† Ø§Ù„Ø£Ø³Ø±Ø¹ ÙÙŠ Ø§Ù„Ø¹Ø§Ù„Ù…ØŸ",opts:["Ø§Ù„ÙÙ‡Ø¯","Ø§Ù„Ø£Ø³Ø¯","Ø§Ù„Ø­ØµØ§Ù†","Ø§Ù„Ù†Ø³Ø±"],c:0},
  {cat:"Ø¹Ø§Ù…Ø©",q:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ù†Ø© Ø§Ù„ÙƒØ¨ÙŠØ³Ø©ØŸ",opts:["366","365","364","367"],c:0},
];

/* â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â• */
let RC=null, PID=null, PN=null, isH=false, myT=null, RD=null;
let tmrHost=null, tmrDisp=null, tmrAns=null, rl=null;

/* â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â• */
function showScr(id){document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));document.getElementById(id).classList.add('on')}
function clearT(){clearInterval(tmrHost);clearInterval(tmrDisp);clearInterval(tmrAns);tmrHost=tmrDisp=tmrAns=null}
function saveS(){if(RC&&PID)sessionStorage.setItem('gs',JSON.stringify({rc:RC,pid:PID,pn:PN,h:isH,t:myT}))}
function clearS(){sessionStorage.removeItem('gs')}
function restoreS(){
  const s=sessionStorage.getItem('gs');if(!s)return false;
  try{const d=JSON.parse(s);
    db.ref('rooms/'+d.rc).once('value',snap=>{
      if(!snap.exists()||!snap.val().players||!snap.val().players[d.pid]){clearS();showScr('scrWelcome');return}
      RC=d.rc;PID=d.pid;PN=d.pn;isH=d.h;myT=d.t;saveS();listen()});return true}
  catch(e){clearS();return false}
}

/* â•â•â•â•â•â•â• CREATE / JOIN â•â•â•â•â•â•â• */
function createRoom(){
  const n=document.getElementById('hostName').value.trim();if(!n){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ');return}
  const t1=document.getElementById('t1n').value.trim()||'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±';
  const t2=document.getElementById('t2n').value.trim()||'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚';
  const sz=parseInt(document.getElementById('tsz').value);
  RC=Math.floor(1000+Math.random()*9000).toString();PID='h-'+Date.now();PN=n;isH=true;
  db.ref('rooms/'+RC).set({oneShotOpts:false,code:RC,host:PID,t1Name:t1,t2Name:t2,tSize:sz,
    players:{[PID]:{name:n,isHost:true,team:''}},state:'lobby',
    curQ:'',usedQ:[],couch:[],buzzP:'',showOpts:false,banTeam:'',
    corAns:'',selAns:'',waitChoice:false,choiceP:'',waitText:false,qStart:'',buzzTime:''});
  saveS();listen();showLobby()}

function joinRoom(){
  const n=document.getElementById('pName').value.trim();const c=document.getElementById('pCode').value.trim();
  if(!n){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ');return}if(!c||c.length!==4){alert('Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (4 Ø£Ø±Ù‚Ø§Ù…)');return}
  db.ref('rooms/'+c).once('value',snap=>{
    if(!snap.exists()){alert('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');return}
    RC=c;PID='p-'+Date.now();PN=n;isH=false;
    db.ref('rooms/'+RC+'/players/'+PID).set({name:n,isHost:false,team:''});
    saveS();listen();showScr('scrTeam');document.getElementById('wpn').textContent=n})}

/* â•â•â•â•â•â•â• LISTEN â•â•â•â•â•â•â• */
function listen(){
  if(rl)db.ref('rooms/'+RC).off('value',rl);
  rl=db.ref('rooms/'+RC).on('value',snap=>{
    if(!snap.exists()){clearS();showScr('scrWelcome');return}
    RD=snap.val();if(!RD.players||!RD.players[PID])return;
    const me=RD.players[PID];if(me.team&&me.team!=='')myT=me.team;
    updateUI()})}

/* â•â•â•â•â•â•â• LOBBY â•â•â•â•â•â•â• */
function showLobby(){showScr('scrLobby');document.getElementById('drc').textContent=RC}
function pickTeam(t){myT=t;db.ref('rooms/'+RC+'/players/'+PID).update({team:t});saveS()}
function pickTeamJoin(t){myT=t;db.ref('rooms/'+RC+'/players/'+PID).update({team:t});saveS();
  RD&&RD.state==='playing'?showScr('scrGame'):showScr('scrWait')}

function renderPlayers(cid){
  const c=document.getElementById(cid);c.innerHTML='';
  Object.entries(RD.players||{}).forEach(([id,p])=>{
    const d=document.createElement('div');d.className='chip';
    let dc='dg';if(p.team==='team1')dc='dr';if(p.team==='team2')dc='db';
    d.innerHTML=`<span class="dot ${dc}"></span>${p.name}${p.isHost?' ğŸ‘‘':''}`;c.appendChild(d)})}

function updateLobby(){
  const cnt=Object.keys(RD.players||{}).length;
  document.getElementById('pc').textContent=cnt;renderPlayers('lpl');
  if(!RD)return;
  document.getElementById('htBtns').innerHTML=
    `<button class="tsb rt ${myT==='team1'?'sel':''}" onclick="pickTeam('team1')">ğŸ”´ ${RD.t1Name}</button>`+
    `<button class="tsb bt ${myT==='team2'?'sel':''}" onclick="pickTeam('team2')">ğŸ”µ ${RD.t2Name}</button>`;
  const b=document.getElementById('sgBtn');
  if(!myT||myT===''){b.disabled=true;b.textContent='Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ Ø£ÙˆÙ„Ø§Ù‹'}
  else{b.disabled=false;b.textContent='Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© â–¶ï¸'}}

function updateWait(){
  document.getElementById('wtn').textContent=myT==='team1'?RD.t1Name:RD.t2Name;renderPlayers('wpl')}

function startGame(){if(!myT){alert('Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ');return}db.ref('rooms/'+RC).update({state:'playing'})}

/* â•â•â•â•â•â•â• UPDATE UI â•â•â•â•â•â•â• */
function updateUI(){
  if(!RD)return;
  // Check for replay team-select state
  if(RD.state==='teamSelect'){document.getElementById('replayOv').classList.add('on');renderReplayTeams();return}
  else{document.getElementById('replayOv').classList.remove('on')}

  if(RD.state==='lobby'){
    if(isH){if(!document.getElementById('scrLobby').classList.contains('on'))showLobby();updateLobby()}
    else if(!myT||myT===''){if(!document.getElementById('scrTeam').classList.contains('on')){showScr('scrTeam');document.getElementById('wpn').textContent=PN}
      if(RD){document.getElementById('tsBtns').innerHTML=
        `<button class="tsb rt" onclick="pickTeamJoin('team1')">ğŸ”´ ${RD.t1Name}</button>`+
        `<button class="tsb bt" onclick="pickTeamJoin('team2')">ğŸ”µ ${RD.t2Name}</button>`}}
    else{if(!document.getElementById('scrWait').classList.contains('on'))showScr('scrWait');updateWait()}
  } else if(RD.state==='playing'){
    if(!myT||myT===''){showScr('scrTeam');document.getElementById('wpn').textContent=PN;
      if(RD){document.getElementById('tsBtns').innerHTML=
        `<button class="tsb rt" onclick="pickTeamJoin('team1')">ğŸ”´ ${RD.t1Name}</button>`+
        `<button class="tsb bt" onclick="pickTeamJoin('team2')">ğŸ”µ ${RD.t2Name}</button>`}}
    else{if(!document.getElementById('scrGame').classList.contains('on'))showScr('scrGame');updateGame()}
  }
}

/* â•â•â•â•â•â•â• GAME â•â•â•â•â•â•â• */
function updateGame(){
  if(!RD)return;const sz=RD.tSize||2;const couch=RD.couch||[];

  // Victory: couch full AND all same team
  let t1c=0,t2c=0;
  couch.forEach(pid=>{const p=RD.players[pid];if(p){if(p.team==='team1')t1c++;else t2c++}});
  if(couch.length>=sz && (t1c===sz||t2c===sz)){showVic();return}
  document.getElementById('vicOv').classList.remove('on');

  // Top bar
  document.getElementById('gt1n').textContent=RD.t1Name;document.getElementById('gt2n').textContent=RD.t2Name;
  document.getElementById('gt1s').textContent=t1c;document.getElementById('gt2s').textContent=t2c;
  renderTP('gt1p','team1');renderTP('gt2p','team2');

  // Couch
  document.getElementById('couchCnt').textContent=couch.length;document.getElementById('couchMax').textContent=sz;
  const cs=document.getElementById('couchSeats');cs.innerHTML='';
  for(let i=0;i<sz;i++){
    const d=document.createElement('div');
    if(couch[i]){const p=RD.players[couch[i]];
      if(p){d.className='cseat '+(p.team==='team1'?'fr':'fb')+(couch[i]===PID?' me':'');d.textContent='ğŸ† '+p.name}
      else{d.className='cseat empty';d.textContent='â€”'}}
    else{d.className='cseat empty';d.textContent='â€”'}
    cs.appendChild(d)}

  // ALL players see questions - even on couch
  document.getElementById('gContent').style.display='block';
  renderGC();
  document.getElementById('hNext').classList.toggle('hid',!isH);
  document.getElementById('gTop').style.display='';document.getElementById('couchSec').style.display=''}

function renderTP(cid,team){
  const c=document.getElementById(cid);c.innerHTML='';const couch=RD.couch||[];
  Object.entries(RD.players||{}).forEach(([id,p])=>{if(p.team===team){
    const s=document.createElement('span');s.className='mp'+(couch.includes(id)?' oc':'');
    s.textContent=p.name;c.appendChild(s)}})}

/* â•â•â•â•â•â•â• ANSWER MATCHING â•â•â•â•â•â•â• */
function hasAns(){return RD.corAns===true||RD.corAns===false}
function norm(s){return s.toLowerCase().replace(/[\u064B-\u065F\u0670]/g,'').replace(/Ø©/g,'Ù‡').replace(/Ù‰/g,'ÙŠ').replace(/[Ø£Ø¥Ø¢Ù±]/g,'Ø§').replace(/Ø¤/g,'Ùˆ').replace(/Ø¦/g,'ÙŠ').replace(/\s+/g,' ').trim()}

const AR_N={'ÙˆØ§Ø­Ø¯':1,'Ø§Ø«Ù†ÙŠÙ†':2,'Ø§Ø«Ù†Ø§Ù†':2,'Ø«Ù„Ø§Ø«Ø©':3,'Ø«Ù„Ø§Ø«':3,'Ø§Ø±Ø¨Ø¹Ø©':4,'Ø§Ø±Ø¨Ø¹':4,'Ø®Ù…Ø³Ø©':5,'Ø®Ù…Ø³':5,
'Ø³ØªØ©':6,'Ø³Øª':6,'Ø³Ø¨Ø¹Ø©':7,'Ø³Ø¨Ø¹':7,'Ø«Ù…Ø§Ù†ÙŠØ©':8,'Ø«Ù…Ø§Ù†ÙŠ':8,'Ø«Ù…Ø§Ù†':8,'ØªØ³Ø¹Ø©':9,'ØªØ³Ø¹':9,
'Ø¹Ø´Ø±Ø©':10,'Ø¹Ø´Ø±':10,'Ø§Ø­Ø¯ Ø¹Ø´Ø±':11,'Ø§Ø«Ù†Ø§ Ø¹Ø´Ø±':12,'Ù…Ø¦Ø©':100,'Ù…Ø§Ø¦Ø©':100,'Ù…Ø¦ØªÙŠÙ†':200,
'Ø«Ù„Ø§Ø«Ù…Ø¦Ø©':300,'Ø§Ø±Ø¨Ø¹Ù…Ø¦Ø©':400,'Ø®Ù…Ø³Ù…Ø¦Ø©':500,'Ø§Ù„Ù':1000};

function getNums(s){const m=s.match(/\d+/g);const r=m?m.map(Number):[];
const n=norm(s);for(const[w,v]of Object.entries(AR_N))if(n.includes(norm(w)))r.push(v);return[...new Set(r)]}

function checkAns(u,c){
  const un=norm(u),cn=norm(c);if(un===cn)return true;
  const uN=getNums(u),cN=getNums(c);
  if(uN.length&&cN.length){for(const a of uN)for(const b of cN)if(a===b)return true}
  if(un.length>=3&&cn.includes(un))return true;if(cn.length>=3&&un.includes(cn))return true;
  const uw=un.split(' ').filter(w=>w.length>2),cw=cn.split(' ').filter(w=>w.length>2);
  for(const a of uw)for(const b of cw){if(a===b)return true;if(a.length>=3&&b.includes(a))return true;if(b.length>=3&&a.includes(b))return true}
  return false}

/* â•â•â•â•â•â•â• RENDER GAME â•â•â•â•â•â•â• */
function renderGC(){
  ['qCard','tBar','bzInd','bzBtn','aiArea','optsG','chG'].forEach(id=>document.getElementById(id).classList.add('hid'));
  document.getElementById('bzBtn').disabled=true;
  const st=document.getElementById('gSts');st.classList.remove('hid');

  // Choice
  if(RD.waitChoice&&RD.choiceP===PID){showQ();st.textContent='âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ø§Ø®ØªØ±:';st.className='sts s';renderChoice();return}
  if(RD.waitChoice){const p=RD.players[RD.choiceP];showQ();st.textContent=(p?.name||'')+' ÙŠØ®ØªØ§Ø±...';st.className='sts i';return}

  // No Q
  if(!RD.curQ||RD.curQ===''){st.textContent='â³ Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø³Ø¤Ø§Ù„...';st.className='sts i';return}
  showQ();

  // I'm typing
  if(RD.waitText&&RD.buzzP===PID&&!hasAns()){
    st.textContent='âŒ¨ï¸ Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ!';st.className='sts w';
    document.getElementById('aiArea').classList.remove('hid');showMainTimer();startAnsTimer();return}

  // Someone typing
  if(RD.waitText&&RD.buzzP&&RD.buzzP!==PID&&!hasAns()){
    const p=RD.players[RD.buzzP];const bi=document.getElementById('bzInd');bi.classList.remove('hid');
    bi.textContent=`ğŸ”” ${p?.name||''} ÙŠÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©...`;st.textContent='Ø§Ù†ØªØ¸Ø±...';st.className='sts i';showMainTimer();return}

  // Options
  if(RD.showOpts&&!hasAns()){
    const og=document.getElementById('optsG');og.classList.remove('hid');og.innerHTML='';
    const banned=RD.banTeam&&RD.banTeam===myT;
    RD.curQ.opts.forEach((o,i)=>{const b=document.createElement('button');b.className='ob';b.textContent=o;
      if(banned)b.disabled=true;else b.onclick=()=>selAns(i);og.appendChild(b)});
    if(banned){st.textContent='â›” ÙØ±ÙŠÙ‚Ùƒ Ù…Ù…Ù†ÙˆØ¹ - ÙØ±ØµØ© Ø§Ù„Ø®ØµÙ…';st.className='sts e'}
    else if(RD.banTeam){st.textContent='ğŸ¯ ÙØ±ØµØªÙƒ! Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©';st.className='sts s'}
    else{st.textContent='Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©';st.className='sts i'}
    return}

  // Result
  if(hasAns()){st.textContent=RD.corAns?'âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!':'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!';st.className=RD.corAns?'sts s':'sts e';return}

  // Active Q
  if(!RD.buzzP&&!RD.showOpts){showMainTimer();const bb=document.getElementById('bzBtn');bb.classList.remove('hid');bb.disabled=false;
    st.textContent='ğŸ“– Ø§Ù‚Ø±Ø£ ÙˆØ§Ø¶ØºØ· Ø§Ù„Ø¬Ø±Ø³!';st.className='sts i';return}

  // Someone buzzed
  if(RD.buzzP&&RD.buzzP!==PID){const p=RD.players[RD.buzzP];
    st.textContent=(p?.name||'')+' ÙŠØ¬ÙŠØ¨...';st.className='sts w';showMainTimer()}}

function showQ(){if(!RD.curQ||RD.curQ==='')return;document.getElementById('qCard').classList.remove('hid');
  document.getElementById('qCat').textContent=RD.curQ.cat||'';document.getElementById('qTxt').textContent=RD.curQ.q}

/* â•â•â•â•â•â•â• TIMERS â•â•â•â•â•â•â• */
function showMainTimer(){
  if(!RD.qStart)return;document.getElementById('tBar').classList.remove('hid');updTimerDisp();
  if(!tmrDisp)tmrDisp=setInterval(()=>{if(!RD||!RD.qStart){clearInterval(tmrDisp);tmrDisp=null;return}updTimerDisp()},500);
  if(isH&&!tmrHost)tmrHost=setInterval(()=>{if(!RD||!RD.qStart){clearInterval(tmrHost);tmrHost=null;return}
    const tl=Math.max(0,30-Math.floor((Date.now()-RD.qStart)/1000));
    if(tl<=0){clearInterval(tmrHost);tmrHost=null;
      if(!hasAns()&&!RD.showOpts){const u={showOpts:true,waitText:false};
        if(RD.buzzP)u.banTeam=RD.players[RD.buzzP]?.team||'';db.ref('rooms/'+RC).update(u)}}},500)}

function updTimerDisp(){const tl=Math.max(0,30-Math.floor((Date.now()-RD.qStart)/1000));
  const c=document.getElementById('tCirc');if(c){c.textContent=tl;c.classList.toggle('dng',tl<=5)}}

function startAnsTimer(){if(!RD.buzzTime)return;clearInterval(tmrAns);const ci=document.getElementById('atCirc');
  tmrAns=setInterval(()=>{if(!RD||!RD.buzzTime){clearInterval(tmrAns);tmrAns=null;return}
    const tl=Math.max(0,5-Math.floor((Date.now()-RD.buzzTime)/1000));
    ci.textContent=tl;ci.classList.toggle('dng',tl<=2);
    if(RD.buzzP===PID && !hasAns()){
  db.ref('rooms/'+RC).update({
    corAns:'',
    waitText:false,
    showOpts:true,
    banTeam: RD.players[PID]?.team || '',
    oneShotOpts:true,       // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø®ØµÙ…
    buzzTime:''
  });
}}}


/* â•â•â•â•â•â•â• BUZZER â•â•â•â•â•â•â• */
function buzzIn(){if(!RD.curQ||RD.curQ===''||RD.buzzP||RD.showOpts)return;
  db.ref('rooms/'+RC).update({buzzP:PID,waitText:true,buzzTime:Date.now()})}

/* â•â•â•â•â•â•â• SUBMIT TEXT â•â•â•â•â•â•â• */
function submitAns(){const inp=document.getElementById('tAns');const v=inp.value.trim();
  if(!v){alert('Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨Ø©!');return}clearInterval(tmrAns);tmrAns=null;
  const ok=checkAns(v,RD.curQ.opts[RD.curQ.c]);const ref=db.ref('rooms/'+RC);
  if(ok){ref.update({corAns:true,waitText:false});handleCorrect()}
  else{
  ref.update({
    corAns:'',                 // Ù„Ø§ Ù†Ù†Ù‡ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§
    waitText:false,
    showOpts:true,             // Ø§ÙØªØ­ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
    banTeam: RD.players[PID]?.team || '', // Ø§Ù…Ù†Ø¹ ÙØ±ÙŠÙ‚ Ø§Ù„Ù„ÙŠ Ø¶ØºØ· Ø§Ù„Ø¬Ø±Ø³
    oneShotOpts:true,          // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© Ù„Ù„Ø®ØµÙ…
    buzzTime:''
  });
}
                    }

/* â•â•â•â•â•â•â• SELECT OPTION â•â•â•â•â•â•â• */
function selAns(i){
  // âœ… Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ù„ÙŠ Ø¹Ù„Ù‰ ÙƒÙ†Ø¨Ø© Ø§Ù„ÙÙˆØ² ÙŠØ¬Ø§ÙˆØ¨
  if((RD.couch || []).includes(PID)) return;

  const ok = i === RD.curQ.c;
  clearT();

  const ref = db.ref('rooms/'+RC);
  const myTeam = RD.players[PID]?.team || '';
  const disabled = RD.disabledOpts || [];

  // âœ… Ù„Ø§ ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø®ÙŠØ§Ø± Ù…Ù‚ÙÙ‘Ù„
  if(disabled.includes(i)) return;

  if(ok){
    // âœ… ØµØ­ÙŠØ­: Ø§Ù†Ù‡Ù Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙˆÙƒÙ…Ù‘Ù„ Ù…Ù†Ø·Ù‚ Ø§Ù„ÙƒÙ†Ø¨Ø©
    ref.update({
      selAns: i,
      corAns: true,
      showOpts: false,
      buzzP: RD.buzzP || PID,
      oneShotOpts: false,
      banTeam: '',
      disabledOpts: []
    });
    handleCorrect();
    return;
  }

  // âŒ Ø®Ø·Ø£
  if(RD.oneShotOpts){
    // âœ… Ù‡Ø°Ø§ Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ "Ø¨Ø¹Ø¯ ÙØ´Ù„ Ø§Ù„Ø¬Ø±Ø³": Ø§Ù„Ø®ØµÙ… Ù„Ù‡ Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    // Ù„Ùˆ ØºÙ„Ø· => ØªÙ†ØªÙ‡ÙŠ ÙØ±ØµØ© Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ† ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† ÙƒØ´Ù Ø§Ù„Ø¬ÙˆØ§Ø¨
    ref.update({
      selAns: i,
      corAns: false,      // ÙŠÙ†Ù‡ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ø·Ø±ÙÙŠÙ†
      showOpts: false,    // ÙŠÙ‚ÙÙ„ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª
      oneShotOpts: false,
      banTeam: '',
      waitText: false,
      buzzTime: ''
    });
    return;
  }

  // âœ… ÙˆØ¶Ø¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ (Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©):
  // Ø§Ù‚ÙÙ„ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù„ÙŠ Ø§Ø®ØªØ§Ø±Ù‡ + Ø§Ù…Ù†Ø¹ ÙØ±ÙŠÙ‚Ù‡ ÙˆØ®Ù„ÙŠ Ø§Ù„ÙØ±ØµØ© Ù„Ù„Ø®ØµÙ…
  ref.update({
    selAns: i,
    corAns: '', // Ù„Ø§ Ù†Ù†Ù‡ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„
    showOpts: true,
    banTeam: myTeam, // ÙØ±ÙŠÙ‚Ù‡ Ù…Ù…Ù†ÙˆØ¹
    disabledOpts: [...new Set([...disabled, i])],
    waitText: false,
    buzzTime: ''
  });
}


/* â•â•â•â•â•â•â• CORRECT ANSWER â•â•â•â•â•â•â• */
function handleCorrect(){
  const sz=RD.tSize||2;const couch=RD.couch||[];const ref=db.ref('rooms/'+RC);
  const opps=couch.filter(pid=>{const p=RD.players[pid];return p&&p.team!==myT});

  if(couch.length>=sz){
    // Couch FULL â†’ can only pull (NO auto-sit)
    if(opps.length>0)ref.update({waitChoice:true,choiceP:PID});
  } else {
    // Space available
    if(opps.length>0)ref.update({waitChoice:true,choiceP:PID}); // sit or pull
    else addToCouch(); // just sit
  }}

/* â•â•â•â•â•â•â• CHOICE â•â•â•â•â•â•â• */
function renderChoice(){
  const cg=document.getElementById('chG');cg.classList.remove('hid');cg.innerHTML='';
  const sz=RD.tSize||2;const couch=RD.couch||[];
  const opps=couch.filter(pid=>{const p=RD.players[pid];return p&&p.team!==myT});
  const full=couch.length>=sz;

  if(full){
    // ONLY pull - no auto sit
    if(opps.length>0){const b=document.createElement('button');b.className='chb pull';
      b.textContent='ğŸ¯ Ø§Ø³Ø­Ø¨ Ù„Ø§Ø¹Ø¨ Ø®ØµÙ… Ù…Ù† Ø§Ù„ÙƒÙ†Ø¨Ø©';b.onclick=()=>doSteal();cg.appendChild(b)}
  } else {
    const sb=document.createElement('button');sb.className='chb sit';
    sb.textContent='ğŸ›‹ï¸ Ø§Ø¬Ù„Ø³ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ†Ø¨Ø©';sb.onclick=()=>doSit();cg.appendChild(sb);
    if(opps.length>0){const pb=document.createElement('button');pb.className='chb pull';
      pb.textContent='ğŸ¯ Ø§Ø³Ø­Ø¨ Ù„Ø§Ø¹Ø¨ Ø®ØµÙ… Ù…Ù† Ø§Ù„ÙƒÙ†Ø¨Ø©';pb.onclick=()=>doSteal();cg.appendChild(pb)}}}

function doSit(){addToCouch()}

function doSteal(){
  const couch=[...(RD.couch||[])];
  let idx=-1;for(let i=couch.length-1;i>=0;i--){const p=RD.players[couch[i]];if(p&&p.team!==myT){idx=i;break}}
  if(idx===-1){db.ref('rooms/'+RC).update({waitChoice:false,choiceP:''});return}
  couch.splice(idx,1);
  // Pull ONLY - do NOT auto-sit. Player needs another correct answer to sit.
  db.ref('rooms/'+RC).update({couch:couch,waitChoice:false,choiceP:''})}

function addToCouch(){
  const couch=[...(RD.couch||[])];const sz=RD.tSize||2;
  if(couch.length>=sz){db.ref('rooms/'+RC).update({waitChoice:false,choiceP:''});return}
  if(!couch.includes(PID))couch.push(PID);
  db.ref('rooms/'+RC).update({couch:couch,waitChoice:false,choiceP:''})}

/* â•â•â•â•â•â•â• NEXT QUESTION â•â•â•â•â•â•â• */
function nextQ(){clearT();
  const used=RD.usedQ||[];let avail=ALL_Q.filter(q=>!used.includes(q.q));
  if(avail.length===0){avail=[...ALL_Q];used.length=0}
  for(let i=avail.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[avail[i],avail[j]]=[avail[j],avail[i]]}
  const q=avail[0];used.push(q.q);
  db.ref('rooms/'+RC).update({oneShotOpts:false,curQ:{cat:q.cat,q:q.q,opts:q.opts,c:q.c},usedQ:used,
    buzzP:'',showOpts:false,banTeam:'',corAns:'',selAns:'',
    waitChoice:false,choiceP:'',qStart:Date.now(),waitText:false,buzzTime:''})}

/* â•â•â•â•â•â•â• VICTORY â•â•â•â•â•â•â• */
function showVic(){clearT();const couch=RD.couch||[];
  let t1c=0,t2c=0;couch.forEach(pid=>{const p=RD.players[pid];if(p){if(p.team==='team1')t1c++;else t2c++}});
  const w=t1c>t2c?RD.t1Name:RD.t2Name;
  document.getElementById('vicOv').classList.add('on');document.getElementById('vicMsg').textContent='ğŸ‰ '+w+' ÙØ§Ø²! ğŸ‰';
  document.getElementById('gContent').style.display='none';
  document.getElementById('hNext').classList.add('hid');
  document.getElementById('gTop').style.display='none';document.getElementById('couchSec').style.display='none'}

/* â•â•â•â•â•â•â• REPLAY WITH TEAM CHANGE â•â•â•â•â•â•â• */
function askReplay(){
  // Go to team selection state so all players can change
  db.ref('rooms/'+RC).update({state:'teamSelect'})}

function renderReplayTeams(){
  if(!RD)return;
  document.getElementById('rpBtns').innerHTML=
    `<button class="tsb rt ${myT==='team1'?'sel':''}" onclick="rpPick('team1')">ğŸ”´ ${RD.t1Name}</button>`+
    `<button class="tsb bt ${myT==='team2'?'sel':''}" onclick="rpPick('team2')">ğŸ”µ ${RD.t2Name}</button>`;
  // Only host sees start button
  if(isH){document.getElementById('rpStart').classList.remove('hid');document.getElementById('rpWait').classList.add('hid')}
  else{document.getElementById('rpStart').classList.add('hid');document.getElementById('rpWait').classList.remove('hid')}}

function rpPick(t){myT=t;db.ref('rooms/'+RC+'/players/'+PID).update({team:t});saveS();renderReplayTeams()}

function confirmReplay(){
  db.ref('rooms/'+RC).update({state:'playing',curQ:'',usedQ:[],couch:[],
    buzzP:'',showOpts:false,banTeam:'',corAns:'',selAns:'',
    waitChoice:false,choiceP:'',waitText:false,qStart:'',buzzTime:''});
  document.getElementById('replayOv').classList.remove('on');
  document.getElementById('gTop').style.display='';document.getElementById('couchSec').style.display='';
  document.getElementById('gContent').style.display='';document.getElementById('vicOv').classList.remove('on')}

/* â•â•â•â•â•â•â• INPUT â•â•â•â•â•â•â• */
document.getElementById('pCode')?.addEventListener('input',function(){this.value=this.value.replace(/[^0-9]/g,'')});
document.getElementById('tAns')?.addEventListener('keypress',function(e){if(e.key==='Enter')submitAns()});

/* â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â• */
if(!restoreS())showScr('scrWelcome');
</script>
</body>
</html>
