<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø®Ø§Ø¯Ø¹</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: #0a1a3a;
            min-height: 100vh;
            padding: 10px;
            padding-bottom: 80px;
            direction: rtl;
            color: #fff;
            position: relative;
        }

        /* Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ */
        .stars-bg {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        .stars-bg .sd {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twk var(--d) ease-in-out infinite;
            animation-delay: var(--dl);
        }
        @keyframes twk {
            0%, 100% { opacity: 0.15; }
            50% { opacity: 0.8; }
        }

        .container { max-width: 900px; margin: 0 auto; position: relative; z-index: 1; }

        .screen { display: none; }
        .screen.active { display: block; }

        .header {
            text-align: center;
            padding: 15px;
            background: rgba(10, 26, 58, 0.7);
            border-radius: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .header h1 { font-size: 1.4em; color: #0a1a3a; background: linear-gradient(135deg, #d4af37, #f5e6a3); padding: 6px 20px; border-radius: 10px; display: inline-block; }

        .card {
            background: rgba(12, 28, 60, 0.85);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(212, 175, 55, 0.15);
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #d4af37 0%, #b8941e 100%);
            color: #0a1a3a;
            font-weight: 700;
            margin: 3px;
            transition: all 0.2s;
        }

        button:hover { opacity: 0.9; }
        button:disabled { opacity: 0.4; cursor: not-allowed; }
        button:active { transform: scale(0.98); }

        .btn-full { width: 100%; margin: 5px 0; }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .btn-success { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .btn-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .btn-secondary { background: #6c757d; }
        .btn-small { padding: 6px 10px; font-size: 12px; }

        /* Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .player-card {
            background: #808080;
            color: #fff;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .player-card.forensic-card {
            background: linear-gradient(135deg, #2980b9, #3498db);
            border: 2px solid #d4af37;
        }

        .player-card.selected-suspect {
            border: 3px solid #e74c3c;
            box-shadow: 0 0 15px rgba(231,76,60,0.5);
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.1em;
            background: #fff;
            color: #000;
            padding: 6px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .player-name:hover { transform: scale(1.05); }

        .player-card.selected-suspect .player-name {
            background: #e74c3c;
            color: #fff;
        }

        .forensic-badge {
            background: #3498db !important;
            color: #fff !important;
            cursor: default !important;
        }

        .player-items { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }

        .item-btn {
            padding: 5px 8px;
            font-size: 11px;
            background: rgba(255,255,255,0.2);
            color: #fff;
            border-radius: 5px;
            cursor: pointer;
        }

        .item-btn:hover { background: rgba(255,255,255,0.3); }
        .item-btn.weapon { border-right: 3px solid #e74c3c; }
        .item-btn.evidence { border-right: 3px solid #3498db; }
        .item-btn.selected { background: #e74c3c !important; }

        .vote-btn {
            display: none;
            margin-top: 10px;
            width: 100%;
        }

        .player-card.ready-vote .vote-btn { display: block; }

        .vote-info {
            background: rgba(0,0,0,0.3);
            padding: 8px;
            border-radius: 6px;
            margin-top: 8px;
            font-size: 0.85em;
            border-right: 3px solid #d4af37;
        }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯ÙˆØ± */
        .role-card {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .role-card.murderer { background: rgba(12, 28, 60, 0.85); border: 2px solid #e74c3c; }
        .role-card.accomplice { background: rgba(12, 28, 60, 0.85); border: 2px solid #9b59b6; }
        .role-card.witness { background: rgba(12, 28, 60, 0.85); border: 2px solid #e67e22; }
        .role-card.forensic { background: rgba(12, 28, 60, 0.85); border: 2px solid #3498db; }
        .role-card.investigator { background: rgba(12, 28, 60, 0.85); border: 2px solid #2ecc71; }

        .role-icon { font-size: 2.5em; }
        .role-title {
            font-size: 1.3em;
            margin: 8px auto;
            display: inline-block;
            padding: 6px 25px;
            border-radius: 10px;
            font-weight: 700;
        }
        .role-card.murderer .role-title { background: linear-gradient(135deg, #c0392b, #e74c3c); color: #fff; }
        .role-card.accomplice .role-title { background: linear-gradient(135deg, #8e44ad, #9b59b6); color: #fff; }
        .role-card.witness .role-title { background: linear-gradient(135deg, #f39c12, #e67e22); color: #fff; }
        .role-card.forensic .role-title { background: linear-gradient(135deg, #2980b9, #3498db); color: #fff; }
        .role-card.investigator .role-title { background: linear-gradient(135deg, #27ae60, #2ecc71); color: #fff; }
        .role-card.murderer .role-desc { color: #e74c3c; }
        .role-card.accomplice .role-desc { color: #9b59b6; }
        .role-card.witness .role-desc { color: #e67e22; }
        .role-card.forensic .role-desc { color: #3498db; }
        .role-card.investigator .role-desc { color: #2ecc71; }
        .role-desc { font-size: 0.9em; opacity: 0.9; }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø³ÙÙ„ÙŠ */
        .clues-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(30, 80, 50, 0.95);
            padding: 8px 15px;
            z-index: 1000;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
            border-top: 3px solid #2ecc71;
        }

        /* Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„ */
        .replace-modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .replace-modal-overlay.active { display: flex; }
        .replace-modal {
            background: linear-gradient(135deg, #1a3a2a, #0d2818);
            border: 2px solid #2ecc71;
            border-radius: 18px;
            padding: 25px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            animation: modalIn 0.25s ease-out;
        }
        @keyframes modalIn {
            from { transform: scale(0.85); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .replace-modal h3 { color: #2ecc71; margin-bottom: 15px; font-size: 1.1em; }
        .replace-modal .modal-btns { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .replace-modal .modal-opt {
            padding: 14px;
            border-radius: 10px;
            border: 2px solid transparent;
            font-size: 14px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            transition: all 0.2s;
        }
        .replace-modal .modal-opt.opt-card {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            border-color: rgba(231, 76, 60, 0.4);
        }
        .replace-modal .modal-opt.opt-option {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
            border-color: rgba(52, 152, 219, 0.4);
        }
        .replace-modal .modal-opt.selected-mode {
            border-color: #2ecc71 !important;
            box-shadow: 0 0 12px rgba(46, 204, 113, 0.4);
        }
        .replace-modal .modal-desc {
            font-size: 0.85em;
            color: #aaa;
            margin-bottom: 15px;
            min-height: 2em;
        }
        .replace-modal .modal-actions { display: flex; gap: 10px; }
        .replace-modal .modal-actions button { flex: 1; padding: 12px; font-size: 14px; border-radius: 10px; border: none; cursor: pointer; font-family: 'Cairo', sans-serif; font-weight: 700; }
        .replace-modal .btn-confirm { background: #27ae60; color: #fff; }
        .replace-modal .btn-confirm:disabled { opacity: 0.4; cursor: not-allowed; }
        .replace-modal .btn-cancel { background: rgba(255,255,255,0.15); color: #fff; }

        .clues-bar.expanded {
            max-height: 70vh;
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .clues-bar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .clues-bar-header h4 { font-size: 0.95em; }

        .clues-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .clue-tag {
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }

        .clues-bar.expanded .clues-summary { display: none; }

        .clues-full { display: none; margin-top: 15px; }
        .clues-bar.expanded .clues-full { display: block; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„Ø© */
        .forensic-full-panel {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .forensic-secret {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .forensic-secret p { margin: 4px 0; }

        .clue-card {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .clue-card.used { opacity: 0.5; }
        .clue-card h5 { margin-bottom: 8px; font-size: 0.9em; }

        .clue-options { display: flex; flex-wrap: wrap; gap: 4px; }

        .clue-opt {
            padding: 4px 8px;
            font-size: 10px;
            background: rgba(255,255,255,0.15);
            border-radius: 4px;
        }

        .clue-opt.selected { background: #2ecc71; color: #000; }

        .round-info {
            text-align: center;
            padding: 10px;
            background: rgba(46, 204, 113, 0.2);
            border-radius: 8px;
            margin: 10px 0;
        }

        /* Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§ØªÙ„ */
        .murderer-selection {
            background: rgba(192, 57, 43, 0.2);
            border: 2px solid #c0392b;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .selection-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 10px;
        }

        .sel-btn {
            padding: 8px 12px;
            font-size: 12px;
            background: rgba(255,255,255,0.1);
        }

        .sel-btn.selected { background: #c0392b; border: 2px solid #d4af37; }

        /* Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        .results-box {
            background: rgba(0,0,0,0.85);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            margin-top: 20px;
        }

        .result-icon { font-size: 3.5em; }
        .result-title { font-size: 1.5em; margin: 15px 0; }

        .truth-reveal {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: right;
        }

        .truth-reveal p { margin: 6px 0; }

        .room-code {
            font-size: 2.2em;
            font-weight: bold;
            color: #0a1a3a;
            letter-spacing: 6px;
            background: linear-gradient(135deg, #d4af37, #f5e6a3);
            padding: 5px 20px;
            border-radius: 10px;
            display: inline-block;
        }

        .lobby-player {
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 6px 0;
            display: flex;
            justify-content: space-between;
        }

        .lobby-player.host { border-right: 3px solid #d4af37; }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .alert-info { background: rgba(52, 152, 219, 0.3); }
        .alert-warning { background: rgba(241, 196, 15, 0.3); }
        .alert-danger { background: rgba(231, 76, 60, 0.3); }

        .hidden { display: none !important; }

        .secret-info {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
        }

        .my-items {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
        }

        .my-items h4 { font-size: 0.9em; color: #d4af37; margin-bottom: 6px; }
        
        .item-tag {
            display: inline-block;
            background: rgba(255,255,255,0.15);
            padding: 3px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 0.8em;
        }

        .suspects-info {
            background: rgba(241, 196, 15, 0.15);
            border: 2px solid #f1c40f;
            border-radius: 10px;
            padding: 12px;
            margin: 10px 0;
        }

        .toggle-icon {
            font-size: 1.2em;
            transition: transform 0.3s;
        }

        .clues-bar.expanded .toggle-icon { transform: rotate(180deg); }

        /* ========== Chat System ========== */
        .chat-fab {
            position: fixed;
            bottom: 90px;
            left: 15px;
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            z-index: 1500;
            box-shadow: 0 4px 20px rgba(108, 92, 231, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .chat-fab:hover { transform: scale(1.1); box-shadow: 0 6px 25px rgba(108, 92, 231, 0.7); }
        .chat-fab:active { transform: scale(0.95); }
        .chat-fab.has-unread { animation: chatFabBounce 0.6s ease; }
        @keyframes chatFabBounce {
            0%, 100% { transform: scale(1); }
            30% { transform: scale(1.25); }
            60% { transform: scale(0.95); }
        }
        .chat-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: #e74c3c;
            color: #fff;
            font-size: 11px;
            font-weight: 700;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            font-family: 'Cairo', sans-serif;
            box-shadow: 0 2px 8px rgba(231, 76, 60, 0.5);
        }
        .chat-badge.visible { display: flex; }

        .chat-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0;
            background: rgba(8, 15, 35, 0.98);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 2500;
            display: flex;
            flex-direction: column;
            transition: height 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            border-top: 2px solid rgba(108, 92, 231, 0.4);
            border-radius: 20px 20px 0 0;
        }
        .chat-panel.open {
            height: 55vh;
            min-height: 320px;
            max-height: 500px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 18px;
            background: linear-gradient(135deg, rgba(108, 92, 231, 0.2), rgba(162, 155, 254, 0.1));
            border-bottom: 1px solid rgba(108, 92, 231, 0.2);
            flex-shrink: 0;
        }
        .chat-header h4 {
            color: #a29bfe;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }
        .chat-header h4 span { font-size: 1.2em; }
        .chat-close-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
            margin: 0;
        }
        .chat-close-btn:hover { background: rgba(255,255,255,0.2); }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px 15px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            scroll-behavior: smooth;
        }
        .chat-messages::-webkit-scrollbar { width: 4px; }
        .chat-messages::-webkit-scrollbar-track { background: transparent; }
        .chat-messages::-webkit-scrollbar-thumb { background: rgba(108, 92, 231, 0.3); border-radius: 2px; }

        .chat-msg {
            max-width: 82%;
            padding: 8px 12px;
            border-radius: 14px;
            font-size: 0.88em;
            line-height: 1.5;
            animation: chatMsgIn 0.25s ease-out;
            word-wrap: break-word;
            word-break: break-word;
        }
        @keyframes chatMsgIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .chat-msg.me {
            align-self: flex-start;
            background: linear-gradient(135deg, #6c5ce7, #7c6cf0);
            color: #fff;
            border-bottom-right-radius: 4px;
        }
        .chat-msg.other {
            align-self: flex-end;
            background: rgba(255, 255, 255, 0.1);
            color: #eee;
            border-bottom-left-radius: 4px;
        }
        .chat-msg .msg-sender {
            font-size: 0.75em;
            font-weight: 700;
            margin-bottom: 2px;
        }
        .chat-msg.me .msg-sender { color: #d4c8ff; }
        .chat-msg.other .msg-sender { color: #a29bfe; }
        .chat-msg .msg-text { direction: rtl; }
        .chat-msg .msg-time {
            font-size: 0.65em;
            opacity: 0.45;
            margin-top: 3px;
            text-align: left;
        }
        .chat-msg.system-msg {
            align-self: center;
            max-width: 90%;
            background: rgba(212, 175, 55, 0.15);
            color: #d4af37;
            text-align: center;
            font-size: 0.8em;
            padding: 6px 14px;
            border-radius: 20px;
        }

        .chat-input-area {
            display: flex;
            gap: 8px;
            padding: 10px 15px 14px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(108, 92, 231, 0.15);
            flex-shrink: 0;
            align-items: center;
        }
        .chat-input-area input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid rgba(108, 92, 231, 0.3);
            border-radius: 22px;
            background: rgba(255,255,255,0.08);
            color: #fff;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
            outline: none;
            transition: border-color 0.2s;
            margin: 0;
        }
        .chat-input-area input:focus {
            border-color: rgba(108, 92, 231, 0.7);
            background: rgba(255,255,255,0.12);
        }
        .chat-input-area input::placeholder { color: rgba(255,255,255,0.35); }
        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            border: none;
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
            padding: 0;
            margin: 0;
        }
        .chat-send-btn:hover { transform: scale(1.1); }
        .chat-send-btn:active { transform: scale(0.9); }

        .chat-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255,255,255,0.25);
            font-size: 0.9em;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>

    <!-- Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ -->
    <div class="stars-bg" id="starsBg"></div>

    
    <div class="container">
        <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div id="homeScreen" class="screen active">
            <div class="header">
                <p style="color:#d4af37;font-size:0.9em;margin-bottom:8px;">â˜ª Ø±Ù…Ø¶Ø§Ù† ÙƒØ±ÙŠÙ… â˜ª</p>
                <h1>ğŸ” Ø§Ù„Ù…Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø®Ø§Ø¯Ø¹ ğŸ”ª</h1>
            </div>
            <div class="card">
                <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:10px;margin-bottom:20px;border-right:4px solid #d4af37;">
                    <p style="text-align:right;font-size:0.85em;line-height:1.8;color:#fff;">
                        <strong style="color:#d4af37;">ğŸ“– ÙƒÙŠÙ ØªÙ„Ø¹Ø¨:</strong><br><br>
                        Ø­Ø¯Ø«Øª Ø¬Ø±ÙŠÙ…Ø© Ù‚ØªÙ„ØŒ ÙˆÙ‡Ù†Ø§Ùƒ Ù‚Ø§ØªÙ„ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ†. ÙŠØ­ØªØ§Ø¬ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ† Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠÙˆÙ† Ø¥Ù„Ù‰ Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆØ£Ø¯Ø§Ø© Ø§Ù„Ø¬Ø±ÙŠÙ…Ø© ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„. 
                        ÙŠÙ…ÙƒÙ† Ø§Ù„ØªÙ‚Ø¯Ù… ÙÙŠ Ø§Ù„ØªØ­Ù‚ÙŠÙ‚ Ø¹Ù† Ø·Ø±ÙŠÙ‚ Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ ÙƒØ´Ù Ø§Ù„Ù‚Ø§ØªÙ„.<br><br>
                        ÙŠÙˆØ¬Ø¯ Ø´Ø§Ù‡Ø¯ ÙŠØ¹Ø±Ù Ø§Ù„Ù‚Ø§ØªÙ„ØŒ ÙˆÙ…Ù‡Ù…ØªÙ‡ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ† ÙÙŠ Ù„ÙØª Ø§Ù„Ø§Ù†ØªØ¨Ø§Ù‡ Ù„Ù„Ù‚Ø§ØªÙ„ Ù…Ù† Ø®Ù„Ø§Ù„ ØªØ­Ø±ÙŠØ§ØªÙ‡ Ø­ÙˆÙ„ Ø£Ø¯Ø§Ø© Ø§Ù„Ø¬Ø±ÙŠÙ…Ø© ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„.<br><br>
                        <strong style="color:#3498db;">ğŸ‘¥ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† 7 Ø£Ùˆ Ø£ÙƒØ«Ø±ØŒ ÙŠÙØ¶Ø§Ù Ø¯ÙˆØ± Ø§Ù„Ø´Ø±ÙŠÙƒ Ø§Ù„Ø°ÙŠ ÙŠØ³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø§ØªÙ„!<br><br>
                        <strong style="color:#e74c3c;">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡:</strong> ÙÙŠ Ø­Ø§Ù„ Ø§ÙƒØªØ´Ù Ø§Ù„Ù‚Ø§ØªÙ„ Ù‡ÙˆÙŠØ© Ø§Ù„Ø´Ø§Ù‡Ø¯ØŒ ÙŠÙ†ØªØµØ± Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆÙŠØ®Ø³Ø± Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ†!
                    </p>
                </div>
                <button onclick="showScreen('createRoomScreen')" class="btn-full">ğŸ  Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
                <button onclick="showScreen('joinRoomScreen')" class="btn-full btn-secondary">ğŸšª Ø§Ù†Ø¶Ù…Ø§Ù…</button>
                <button class="btn-full btn-secondary" onclick="window.location.href='../index.html'"> ğŸšª Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù„Ø¹Ø§Ø¨ </button>
            </div>
        </div>

        <!-- Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© -->
        <div id="createRoomScreen" class="screen">
            <div class="header"><h1>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h1></div>
            <div class="card">
                <input type="text" id="hostName" placeholder="Ø§Ø³Ù…Ùƒ" maxlength="12">
                <select id="playerCount">
                    <option value="4">4 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="5">5 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="6">6 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="7">7 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="8">8 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="9">9 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="10">10 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="11">11 Ù„Ø§Ø¹Ø¨</option>
                    <option value="12">12 Ù„Ø§Ø¹Ø¨</option>
                </select>
                <button onclick="createRoom()" class="btn-full btn-success">Ø¥Ù†Ø´Ø§Ø¡</button>
                <button onclick="showScreen('homeScreen')" class="btn-full btn-secondary">Ø±Ø¬ÙˆØ¹</button>
            </div>
        </div>

        <!-- Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… -->
        <div id="joinRoomScreen" class="screen">
            <div class="header"><h1>Ø§Ù†Ø¶Ù…Ø§Ù…</h1></div>
            <div class="card">
                <input type="text" id="playerName" placeholder="Ø§Ø³Ù…Ùƒ" maxlength="12">
                <input type="text" id="roomCodeInput" placeholder="Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©" maxlength="4" style="text-transform:uppercase;text-align:center;font-size:1.5em;letter-spacing:5px;">
                <button onclick="joinRoom()" class="btn-full btn-success">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
                <button onclick="showScreen('homeScreen')" class="btn-full btn-secondary">Ø±Ø¬ÙˆØ¹</button>
            </div>
        </div>

        <!-- ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± -->
        <div id="lobbyScreen" class="screen">
            <div class="header">
                <h1>ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h1>
                <div class="room-code" id="displayRoomCode">----</div>
            </div>
            <div class="card">
                <h3>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† (<span id="playerCountDisplay">0</span>/<span id="maxPlayerDisplay">4</span>)</h3>
                <div id="lobbyPlayersList"></div>
            </div>
            <div id="hostControls" class="hidden">
                <button onclick="startGame()" class="btn-full btn-success" id="startBtn">ğŸ® Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>
            <button onclick="leaveRoom()" class="btn-full" style="margin-top:10px;background:#e74c3c;">ğŸšª Ù…ØºØ§Ø¯Ø±Ø© Ø§Ù„ØºØ±ÙØ©</button>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div id="gameScreen" class="screen">
            <div id="roleCard" class="role-card">
                <div class="role-icon" id="roleIcon">ğŸ”</div>
                <div class="role-title" id="roleTitle">Ø¯ÙˆØ±Ùƒ</div>
                <div class="role-desc" id="roleDesc"></div>
            </div>

            <div id="secretInfo" class="secret-info hidden"></div>
            <div id="witnessInfo" class="suspects-info hidden"></div>

            <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø§ØªÙ„ -->
            <div id="murdererSelection" class="murderer-selection hidden">
                <h3>ğŸ”ª Ø£Ù†Øª Ø§Ù„Ù‚Ø§ØªÙ„! Ø§Ø®ØªØ± Ø³Ù„Ø§Ø­ ÙˆØ¯Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©</h3>
                <div id="allPlayersItems" style="background:rgba(0,0,0,0.3);padding:10px;border-radius:8px;margin:15px 0;max-height:200px;overflow-y:auto;"></div>
                <div class="alert alert-danger" style="margin-bottom:10px;padding:8px;">
                    <p style="font-size:0.9em;"><strong>âš ï¸ Ø§Ø®ØªØ± Ù…Ù† Ø¨Ø·Ø§Ù‚Ø§ØªÙƒ Ø£Ù†Øª ÙÙ‚Ø·:</strong></p>
                </div>
                <h4 style="margin-top:10px;">âš”ï¸ Ø§Ù„Ø³Ù„Ø§Ø­:</h4>
                <div id="murdererWeapons" class="selection-grid"></div>
                <h4 style="margin-top:15px;">ğŸ” Ø§Ù„Ø¯Ù„ÙŠÙ„:</h4>
                <div id="murdererEvidence" class="selection-grid"></div>
                <button onclick="confirmMurderChoice()" class="btn-full btn-danger" style="margin-top:20px;" id="confirmMurderBtn" disabled>âœ“ ØªØ£ÙƒÙŠØ¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©</button>
            </div>

            <div id="waitingMurderer" class="alert alert-warning hidden">
                <p style="font-size:1.05em;margin-bottom:10px;">â³ Ø§Ù„Ù‚Ø§ØªÙ„ ÙŠØ®ØªØ§Ø± Ø³Ù„Ø§Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©...</p>
                <p style="font-size:0.9em;color:#f39c12;"><strong>ğŸ‘€ Ø®Ù„ Ø¹ÙŠÙ†Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„ Ù„Ù…Ø§ ÙŠØ®Ù„Øµ Ø§Ù„Ù‚Ø§ØªÙ„ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø³Ù„Ø§Ø­ ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„</strong></p>
            </div>

            <div id="myItems" class="my-items hidden"></div>

            <div id="playersSection" class="card hidden">
                <h3 style="margin-bottom:10px;">ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</h3>
                <div id="playersList"></div>
            </div>

            <div id="gameResults" class="hidden"></div>
        </div>
    </div>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø³ÙÙ„ÙŠ (Ù„Ù„Ø¬Ù…ÙŠØ¹) -->
    <div id="cluesBar" class="clues-bar hidden">
        <div class="clues-bar-header" onclick="toggleCluesBar()">
            <h4 style="color:#2ecc71;">ğŸ“‹ Ø£Ø¯Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ (<span id="cluesCount">0</span>/6)</h4>
            <div style="display:flex;align-items:center;gap:8px;">
                <span style="font-size:0.75em;color:#aaa;">Ø§Ø¶ØºØ· Ø§Ù„Ø³Ù‡Ù… Ù„Ø¥Ø¸Ù‡Ø§Ø± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø¯Ù„Ø©</span>
                <span class="toggle-icon">â–²</span>
            </div>
        </div>
        <div class="clues-summary" id="cluesSummary"></div>
        <div class="clues-full" id="cluesFull">
            <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„Ø© -->
            <div id="forensicPanel" class="forensic-full-panel hidden">
                <div class="forensic-secret">
                    <p>ğŸ”ª Ø§Ù„Ù‚Ø§ØªÙ„: <strong id="fMurderer">-</strong></p>
                    <p id="fAccompliceRow">ğŸ¤ Ø§Ù„Ø´Ø±ÙŠÙƒ: <strong id="fAccomplice">-</strong></p>
                    <p>ğŸ‘ï¸ Ø§Ù„Ø´Ø§Ù‡Ø¯: <strong id="fWitness">-</strong></p>
                    <p>âš”ï¸ Ø§Ù„Ø³Ù„Ø§Ø­: <strong id="fWeapon">-</strong></p>
                    <p>ğŸ” Ø§Ù„Ø¯Ù„ÙŠÙ„: <strong id="fEvidence">-</strong></p>
                </div>
                <div class="round-info">
                    Ø§Ù„Ø¬ÙˆÙ„Ø© <span id="currentRound">1</span>/3 | 
                    <span id="cluesInRound">0</span>/6 Ø£Ø¯Ù„Ø©
                </div>
                <div id="forensicCards"></div>
                <button onclick="nextRound()" class="btn-full btn-warning" id="nextRoundBtn" style="display:none;">
                    ğŸ”„ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
                </button>
            </div>
            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯Ù„Ø© Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† -->
            <div id="cluesListFull"></div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© -->
    <div class="replace-modal-overlay" id="replaceModal">
        <div class="replace-modal">
            <h3>ğŸ”„ Ø§Ø³ØªØ¨Ø¯Ø§Ù„: <span id="replaceCardTitle">-</span></h3>
            <div class="modal-btns">
                <button class="modal-opt opt-card" id="modeCardBtn" onclick="setReplaceMode('card')">
                    ğŸ”„ ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙƒØ§Ù…Ù„Ø©
                </button>
                <button class="modal-opt opt-option" id="modeOptionBtn" onclick="setReplaceMode('option')">
                    âœï¸ ØªØ¨Ø¯ÙŠÙ„ Ø®ÙŠØ§Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø·
                </button>
            </div>
            <div class="modal-desc" id="replaceDesc">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„</div>
            <div class="modal-actions">
                <button class="btn-confirm" id="replaceConfirmBtn" onclick="confirmReplace()" disabled>âœ“ ØªØ£ÙƒÙŠØ¯</button>
                <button class="btn-cancel" onclick="cancelReplace()">âœ– Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        // ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù†Ø¬ÙˆÙ… Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡
        (function() {
            var c = document.getElementById('starsBg');
            for (var i = 0; i < 70; i++) {
                var s = document.createElement('div');
                s.className = 'sd';
                var sz = Math.random() * 2.5 + 1;
                s.style.width = sz + 'px';
                s.style.height = sz + 'px';
                s.style.left = Math.random() * 100 + '%';
                s.style.top = Math.random() * 100 + '%';
                s.style.setProperty('--d', (Math.random() * 3 + 2) + 's');
                s.style.setProperty('--dl', (Math.random() * 3) + 's');
                c.appendChild(s);
            }
        })();
    </script>

    <script>
        // ========== Firebase ==========
        try {
            firebase.initializeApp({
                apiKey: "AIzaSyB88NCDQzsUzHZgH07B63e4Dpxc3LfXSyY",
                authDomain: "detective-game-df960.firebaseapp.com",
                databaseURL: "https://detective-game-df960-default-rtdb.europe-west1.firebasedatabase.app",
                projectId: "detective-game-df960"
            });
            var db = firebase.database();
            console.log('Firebase initialized successfully');
        } catch (error) {
            console.error('Firebase initialization error:', error);
            alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
        }

        var WEAPONS = ['ğŸ”« Ù…Ø³Ø¯Ø³','ğŸ”ª Ø³ÙƒÙŠÙ†','ğŸª“ ÙØ£Ø³','ğŸ”¨ Ù…Ø·Ø±Ù‚Ø©','ğŸª¢ Ø­Ø¨Ù„','â˜ ï¸ Ø³Ù…','ğŸ’‰ Ø­Ù‚Ù†Ø©','âš¡ ØµØ§Ø¹Ù‚ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ','ğŸ”¥ Ù†Ø§Ø±','ğŸ§Š Ø«Ù„Ø¬ Ø­Ø§Ø¯','âš”ï¸ Ø³ÙŠÙ','ğŸ—¡ï¸ Ø®Ù†Ø¬Ø±','ğŸ¹ Ù‚ÙˆØ³ ÙˆØ³Ù‡Ù…','â›“ï¸ Ø³Ù„Ø³Ù„Ø© Ø­Ø¯ÙŠØ¯','ğŸ”§ Ù…ÙØªØ§Ø­ Ø±Ø¨Ø·','ğŸª› Ù…ÙÙƒ Ø¨Ø±Ø§ØºÙŠ','ğŸ”© Ù‚Ø¶ÙŠØ¨ Ù…Ø¹Ø¯Ù†ÙŠ','ğŸª¨ Ø­Ø¬Ø± ØµÙ„Ø¨','ğŸ³ Ù…Ù‚Ù„Ø§Ø©','ğŸ Ø¹ØµØ§ Ø®Ø´Ø¨ÙŠØ©','âš¾ Ù…Ø¶Ø±Ø¨ Ø¨ÙŠØ³Ø¨ÙˆÙ„','âœ‚ï¸ Ù…Ù‚Øµ','ğŸªš Ù…Ù†Ø´Ø§Ø±','ğŸ§¯ Ù…Ø·ÙØ£Ø© Ø­Ø±ÙŠÙ‚','ğŸª  Ø´ÙØ§Ø·','ğŸª Ø®Ø·Ø§Ù','ğŸ› ï¸ Ø£Ø¯Ø§Ø© Ø­Ø§Ø¯Ø©','ğŸªœ Ø³Ù„Ù… Ù…Ø¹Ø¯Ù†ÙŠ','ğŸª‘ ÙƒØ±Ø³ÙŠ','ğŸ›ï¸ Ù„ÙˆØ­ Ø³Ø±ÙŠØ±','ğŸ§± Ø·ÙˆØ¨Ø©','ğŸ§¨ Ù…ØªÙØ¬Ø±Ø§Øª','ğŸ’£ Ù‚Ù†Ø¨Ù„Ø©','ğŸª“ Ø¨Ù„Ø·Ø©','ğŸ—œï¸ Ù…Ù„Ø²Ù…Ø©','ğŸ”— Ù‚ÙŠØ¯ Ø­Ø¯ÙŠØ¯ÙŠ','ğŸ“ Ù…Ø´Ø¨Ùƒ Ù…Ø¹Ø¯Ù†ÙŠ','ğŸ§² Ù…ØºÙ†Ø§Ø·ÙŠØ³ Ù‚ÙˆÙŠ','ğŸª Ù…Ø±Ø¢Ø© Ù…ÙƒØ³ÙˆØ±Ø©','ğŸ§¹ Ø¹ØµØ§ Ù…ÙƒÙ†Ø³Ø©','ğŸª¥ ÙØ±Ø´Ø§Ø© Ø­Ø§Ø¯Ø©','ğŸª’ Ù…ÙˆØ³ Ø­Ù„Ø§Ù‚Ø©','ğŸª« Ø¨Ø·Ø§Ø±ÙŠØ© Ù…Ø­ØªØ±Ù‚Ø©','ğŸ“Œ Ø¯Ø¨ÙˆØ³ ÙƒØ¨ÙŠØ±','ğŸ–Šï¸ Ù‚Ù„Ù… Ù…Ø¹Ø¯Ù†ÙŠ','ğŸ–‹ï¸ Ù‚Ù„Ù… Ø­Ø¨Ø± Ø«Ù‚ÙŠÙ„','ğŸ§´ Ø²Ø¬Ø§Ø¬Ø© ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©','ğŸª” Ù…ØµØ¨Ø§Ø­ Ø²ÙŠØª','ğŸ§‚ Ù…Ù„Ø­ Ø³Ø§Ù…','ğŸ¾ Ø²Ø¬Ø§Ø¬Ø© Ù…ÙƒØ³ÙˆØ±Ø©','ğŸ¥„ Ù…Ù„Ø¹Ù‚Ø© Ø­Ø¯ÙŠØ¯','ğŸ´ Ø´ÙˆÙƒØ© Ø­Ø§Ø¯Ø©','ğŸ«™ Ù…Ø±Ø·Ø¨Ø§Ù† Ø²Ø¬Ø§Ø¬','ğŸ“ Ù…Ø³Ø·Ø±Ø© Ù…Ø¹Ø¯Ù†ÙŠØ©','ğŸ“ Ø²Ø§ÙˆÙŠØ© Ø­Ø¯ÙŠØ¯','ğŸªª Ø¨Ø·Ø§Ù‚Ø© Ù…Ø¹Ø¯Ù†ÙŠØ©','ğŸ“€ Ù‚Ø±Øµ Ø­Ø§Ø¯','ğŸ’¿ Ù‚Ø±Øµ Ù…Ø¯Ù…Ø¬','ğŸ§  Ø¬Ù‡Ø§Ø² Ù†ÙØ³ÙŠ','ğŸ©¸ Ù…Ø§Ø¯Ø© Ø¨ÙŠÙˆÙ„ÙˆØ¬ÙŠØ©','ğŸªŸ Ø²Ø¬Ø§Ø¬ Ù†Ø§ÙØ°Ø©','ğŸ§³ Ø­Ù‚ÙŠØ¨Ø© Ø«Ù‚ÙŠÙ„Ø©','ğŸª™ Ø¹Ù…Ù„Ø© Ù…Ø¹Ø¯Ù†ÙŠØ©','ğŸ›ï¸ Ø¬Ø±Ø³ Ù…Ø¹Ø¯Ù†ÙŠ','ğŸª“ ÙØ£Ø³ Ø¬Ù„ÙŠØ¯','ğŸ› ï¸ ÙƒÙ…Ø§Ø´Ø©','ğŸª Ø³Ù†Ø§Ø±Ø©','ğŸ§· Ø¯Ø¨ÙˆØ³ Ø£Ù…Ø§Ù†','ğŸ“¡ Ø¬Ù‡Ø§Ø² ØµØ¹Ù‚','ğŸ”‹ Ø¨Ø·Ø§Ø±ÙŠØ© Ù…ØªÙØ¬Ø±Ø©','ğŸª« Ø´Ø§Ø­Ù† ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ','ğŸ“¦ ØµÙ†Ø¯ÙˆÙ‚ Ø­Ø¯ÙŠØ¯','ğŸªµ Ù„ÙˆØ­ Ø®Ø´Ø¨ÙŠ','ğŸ§¯ ØºØ§Ø² Ø®Ø§Ù†Ù‚','ğŸª¬ Ø­Ø¬Ø± ØºØ§Ù…Ø¶','ğŸ§¿ Ø®Ø±Ø²Ø© Ø²Ø±Ù‚Ø§Ø¡ ØµÙ„Ø¨Ø©','ğŸ§¼ Ù‚Ø§Ù„Ø¨ ØµÙ„Ø¨','ğŸª¶ Ø±ÙŠØ´Ø© Ù…Ø³Ù…ÙˆÙ…Ø©','ğŸ§µ Ø®ÙŠØ· ÙÙˆÙ„Ø§Ø°','ğŸª¡ Ø¥Ø¨Ø±Ø© Ø®ÙŠØ§Ø·Ø©','ğŸ›¢ï¸ Ø¨Ø±Ù…ÙŠÙ„ Ø²ÙŠØª','ğŸª¤ ÙØ® Ø­Ø¯ÙŠØ¯ÙŠ','ğŸ›‘ Ø­Ø§Ø¬Ø² Ù…Ø¹Ø¯Ù†ÙŠ','ğŸ“¦ Ø·Ø±Ø¯ Ù…Ø´Ø¨ÙˆÙ‡','ğŸ§ª Ù…Ø§Ø¯Ø© Ù…Ø®ØªØ¨Ø±ÙŠØ©','ğŸ©º Ø£Ø¯Ø§Ø© Ø·Ø¨ÙŠØ©','ğŸ§  Ø¬Ù‡Ø§Ø² ØµØ¯Ù…Ø§Øª','ğŸª  Ø£Ø¯Ø§Ø© Ø¶ØºØ·','ğŸ§± Ø¨Ù„Ø§Ø·Ø© Ø¥Ø³Ù…Ù†Øª','ğŸ› ï¸ Ø£Ø¯Ø§Ø© ØµÙ†Ø§Ø¹ÙŠØ©','ğŸ•â€ğŸ¦º ÙƒÙ„Ø¨ Ù…Ø³Ø¹ÙˆØ±','ğŸ Ù†Ø­Ù„Ø© Ù‚Ø§ØªÙ„Ø©','ğŸ… Ù…Ø®Ù„Ø¨ Ù†Ù…Ø±'];
        var EVIDENCE = ['ğŸ‘£ Ø£Ø«Ø± Ø£Ù‚Ø¯Ø§Ù…','ğŸ©¸ Ø¨Ù‚Ø¹Ø© Ø¯Ù…','ğŸ’‡ Ø´Ø¹Ø±Ø©','ğŸ‘† Ø¨ØµÙ…Ø© Ø¥ØµØ¨Ø¹','ğŸ§µ Ù‚Ø·Ø¹Ø© Ù‚Ù…Ø§Ø´','ğŸ“± Ù‡Ø§ØªÙ Ù…Ø­Ù…ÙˆÙ„','ğŸ”‘ Ù…ÙØªØ§Ø­','ğŸ’ Ø®Ø§ØªÙ…','ğŸ« ØªØ°ÙƒØ±Ø©','ğŸ“ Ø±Ø³Ø§Ù„Ø© Ù…ÙƒØªÙˆØ¨Ø©','ğŸ§¤ Ù‚ÙØ§Ø²','ğŸ‘“ Ù†Ø¸Ø§Ø±Ø©','âŒš Ø³Ø§Ø¹Ø© ÙŠØ¯','ğŸ­ Ù‚Ù†Ø§Ø¹','ğŸ§ª Ø¹ÙŠÙ†Ø© ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©','ğŸ“· ØµÙˆØ±Ø© ÙÙˆØªÙˆØºØ±Ø§ÙÙŠØ©','ğŸ’³ Ø¨Ø·Ø§Ù‚Ø© Ø¨Ù†ÙƒÙŠØ©','ğŸ—ï¸ Ù…ÙØªØ§Ø­ Ù‚Ø¯ÙŠÙ…','ğŸ“œ ÙˆØ«ÙŠÙ‚Ø© Ø±Ø³Ù…ÙŠØ©','ğŸ’Š Ø­Ø¨ÙˆØ¨ Ø¯ÙˆØ§Ø¡','ğŸµ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ','ğŸ“§ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ','ğŸ–Šï¸ Ù‚Ù„Ù…','ğŸ‘Ÿ Ø­Ø°Ø§Ø¡','ğŸ§¢ Ù‚Ø¨Ø¹Ø©','ğŸ‘• Ù‚Ù…ÙŠØµ','ğŸ‘– Ø¨Ù†Ø·Ø§Ù„','ğŸ‘” Ø±Ø¨Ø·Ø© Ø¹Ù†Ù‚','ğŸ‘— ÙØ³ØªØ§Ù†','ğŸ‘ Ø­Ø°Ø§Ø¡ Ø±Ø³Ù…ÙŠ','ğŸ§¦ Ø¬ÙˆØ±Ø¨','ğŸ’ Ø­Ù‚ÙŠØ¨Ø© Ø¸Ù‡Ø±','ğŸ‘œ Ø­Ù‚ÙŠØ¨Ø© ÙŠØ¯','ğŸ§³ Ø­Ù‚ÙŠØ¨Ø© Ø³ÙØ±','ğŸ“¦ ØµÙ†Ø¯ÙˆÙ‚','ğŸ“‚ Ù…Ù„Ù','ğŸ“ Ù…Ø¬Ù„Ø¯','ğŸ“ Ù…Ø´Ø¨Ùƒ ÙˆØ±Ù‚','ğŸ§· Ø¯Ø¨ÙˆØ³ Ø£Ù…Ø§Ù†','ğŸ“Œ Ø¯Ø¨ÙˆØ³','ğŸªª Ø¨Ø·Ø§Ù‚Ø© Ù‡ÙˆÙŠØ©','ğŸ“„ Ø¹Ù‚Ø¯','ğŸ“‘ Ù…Ø³ØªÙ†Ø¯ Ù…Ù…Ø²Ù‚','ğŸ—’ï¸ Ù…Ù„Ø§Ø­Ø¸Ø©','ğŸ§¾ Ø¥ÙŠØµØ§Ù„','ğŸ“Š ØªÙ‚Ø±ÙŠØ±','ğŸ“ˆ Ø³Ø¬Ù„ Ø¨ÙŠØ§Ù†Ø§Øª','ğŸ“‰ ÙƒØ´Ù Ø­Ø³Ø§Ø¨','ğŸ–¼ï¸ Ù„ÙˆØ­Ø©','ğŸª Ù…Ø±Ø¢Ø©','ğŸªŸ Ø²Ø¬Ø§Ø¬ Ù…ÙƒØ³ÙˆØ±','ğŸšª Ù…Ù‚Ø¨Ø¶ Ø¨Ø§Ø¨','ğŸª‘ ÙƒØ±Ø³ÙŠ','ğŸ›‹ï¸ Ø£Ø±ÙŠÙƒØ©','ğŸ›ï¸ Ø³Ø±ÙŠØ±','ğŸ§¸ Ø¯Ù…ÙŠØ©','ğŸª€ Ù„Ø¹Ø¨Ø©','ğŸ® Ø¬Ù‡Ø§Ø² Ø£Ù„Ø¹Ø§Ø¨','ğŸ“€ Ù‚Ø±Øµ Ù…Ø¯Ù…Ø¬','ğŸ’¿ Ù‚Ø±Øµ Ø¨ÙŠØ§Ù†Ø§Øª','ğŸ“¼ Ø´Ø±ÙŠØ· ÙÙŠØ¯ÙŠÙˆ','ğŸ“¡ Ø¬Ù‡Ø§Ø² Ø¥Ø±Ø³Ø§Ù„','ğŸ”Œ Ù‚Ø§Ø¨Ø³ ÙƒÙ‡Ø±Ø¨Ø§Ø¡','ğŸ”‹ Ø¨Ø·Ø§Ø±ÙŠØ©','ğŸ’¡ Ù…ØµØ¨Ø§Ø­','ğŸ•¯ï¸ Ø´Ù…Ø¹Ø©','ğŸª” Ù…ØµØ¨Ø§Ø­ Ø²ÙŠØªÙŠ','ğŸ§´ Ø²Ø¬Ø§Ø¬Ø©','ğŸ§‚ Ù…Ù„Ø­','ğŸ¾ Ø²Ø¬Ø§Ø¬Ø© Ù…ÙƒØ³ÙˆØ±Ø©','ğŸ¥ƒ ÙƒØ£Ø³','â˜• ÙÙ†Ø¬Ø§Ù† Ù‚Ù‡ÙˆØ©','ğŸ½ï¸ Ø·Ø¨Ù‚','ğŸ¥„ Ù…Ù„Ø¹Ù‚Ø©','ğŸ´ Ø´ÙˆÙƒØ©','ğŸ”ª Ø³ÙƒÙŠÙ† Ù…Ø·Ø¨Ø®','ğŸ§  ØªÙ‚Ø±ÙŠØ± Ù†ÙØ³ÙŠ','ğŸ©º ØªÙ‚Ø±ÙŠØ± Ø·Ø¨ÙŠ','ğŸ“‹ Ø³Ø¬Ù„ Ù…Ù„Ø§Ø­Ø¸Ø§Øª','ğŸ§­ Ø¨ÙˆØµÙ„Ø©','ğŸ—ºï¸ Ø®Ø±ÙŠØ·Ø©','ğŸ“ Ø¯Ø¨ÙˆØ³ Ù…ÙˆÙ‚Ø¹','â±ï¸ Ù…Ø¤Ù‚Øª','â° Ù…Ù†Ø¨Ù‡','ğŸ“¹ ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ','ğŸ§ª Ø£Ù†Ø¨ÙˆØ¨ Ø§Ø®ØªØ¨Ø§Ø±','ğŸ§« Ø¹ÙŠÙ†Ø© Ø¨ÙŠÙˆÙ„ÙˆØ¬ÙŠØ©','ğŸ§¬ Ø­Ù…Ø¶ Ù†ÙˆÙˆÙŠ','ğŸª™ Ø¹Ù…Ù„Ø© Ù…Ø¹Ø¯Ù†ÙŠØ©','ğŸ›ï¸ Ø¬Ø±Ø³','ğŸ”” Ù…Ù†Ø¨Ù‡ ÙŠØ¯ÙˆÙŠ','ğŸ§¿ Ø®Ø±Ø²Ø©','ğŸª¬ ØªÙ…ÙŠÙ…Ø©','ğŸŒ² Ø§ØºØµÙ† Ø´Ø¬Ø±Ø©','ğŸƒ Ø£ÙˆØ±Ø§Ù‚ Ø´Ø¬Ø± Ø¹Ø§Ù„Ù‚Ø©','ğŸªµ Ù‚Ø·Ø¹Ø© Ø®Ø´Ø¨ Ù…ÙƒØ³ÙˆØ±Ø©'];

        var CLUE_CARDS = [
            { title: 'ğŸ’€ Ø³Ø¨Ø¨ Ø§Ù„ÙˆÙØ§Ø©', options: ['Ø§Ø®ØªÙ†Ø§Ù‚', 'Ø¥ØµØ§Ø¨Ø© Ø¨Ø§Ù„ØºØ©', 'Ù†Ø²ÙŠÙ', 'Ù…Ø±Ø¶', 'ØªØ³Ù…Ù…', 'Ø­Ø§Ø¯Ø«'], fixed: true },
            { title: 'ğŸ• Ø§Ù„ÙˆÙ‚Øª', options: ['ÙØ¬Ø±', 'ØµØ¨Ø§Ø­', 'Ø¸Ù‡Ø±', 'Ø¹ØµØ±', 'Ù…ØºØ±Ø¨', 'Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„'] },
            { title: 'ğŸ• Ù…Ø¯Ø© Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©', options: ['ÙÙˆØ±ÙŠØ©', 'ÙˆØ¬ÙŠØ²Ø©', 'ØªØ¯Ø±ÙŠØ¬ÙŠØ©', 'Ø·ÙˆÙŠÙ„Ø©', 'Ø¨Ø¶Ø¹Ø© Ø£ÙŠØ§Ù…', 'ØºÙŠØ± ÙˆØ§Ø¶Ø­Ø©'] },
            { title: 'ğŸ” Ø¯Ù„ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ø³Ù…', options: ['Ø§Ù„Ø±Ø£Ø³', 'Ø§Ù„ØµØ¯Ø±', 'Ø§Ù„ÙŠØ¯', 'Ø§Ù„Ø±Ø¬Ù„', 'Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¬Ø«Ø©', 'Ø§Ù„Ø¬Ø«Ø© Ø¨Ø£ÙƒÙ…Ù„Ù‡Ø§'] },
            { title: 'ğŸ˜µ Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ø­ÙŠØ©', options: ['Ù†Ø§Ø¦Ù…', 'Ø¬Ø§Ù„Ø³', 'ÙˆØ§Ù‚Ù', 'ÙŠØ±ÙƒØ¶', 'ÙŠØ£ÙƒÙ„', 'ÙŠØªØ­Ø¯Ø«'] },
            { title: 'ğŸ’­ Ø§Ù„Ø¯Ø§ÙØ¹', options: ['Ù…Ø§Ù„', 'Ø§Ù†ØªÙ‚Ø§Ù…', 'ØºÙŠØ±Ø©', 'Ø³Ù„Ø·Ø©', 'Ø³Ø±', 'Ø­Ø¨'] },
            { title: 'ğŸŒ¤ï¸ Ø§Ù„Ø·Ù‚Ø³', options: ['Ù…Ø´Ù…Ø³', 'ØºØ§Ø¦Ù…', 'Ù…Ù…Ø·Ø±', 'Ø¹Ø§ØµÙ', 'Ø«Ù„Ø¬ÙŠ', 'Ø¶Ø¨Ø§Ø¨ÙŠ'] },
            { title: 'ğŸ‘” Ù…Ù„Ø§Ø¨Ø³ Ø§Ù„Ø¶Ø­ÙŠØ©', options: ['Ø£Ù†ÙŠÙ‚Ø©', 'Ù…Ø¨Ù„Ù„Ù‡', 'Ù…ØªÙ‚Ø·Ø¹Ø©', 'Ø¹Ø§Ø±ÙŠØ©', 'Ù†Ø¸ÙŠÙØ©', 'ØºØ±ÙŠØ¨Ø©'] },
            { title: 'ğŸ­ Ø´Ø®ØµÙŠØ© Ø§Ù„Ù‚Ø§ØªÙ„', options: ['Ù‡Ø§Ø¯Ø¦', 'Ø¹ØµØ¨ÙŠ', 'Ù…Ø§ÙƒØ±', 'Ù…ØªÙ‡ÙˆØ±', 'Ø¨Ø§Ø±Ø¯', 'Ù…Ø­ØªØ±Ù'] },
            { title: 'ğŸ”Š Ø§Ø¯Ù„Ø§Ø¡ Ø´Ø§Ù‡Ø¯', options: ['ØµÙˆØª Ù…ÙØ§Ø¬Ø¦', 'ØµÙˆØª Ù…Ø·ÙˆÙ‘Ù„', 'Ø±Ø§Ø¦Ø­Ø©', 'Ø´ÙŠ Ù…Ø±Ø¦ÙŠ', 'Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡', 'Ù„Ø§Ø´ÙŠØ¡'] },
            { title: 'ğŸ’¡ Ø¥Ø¶Ø§Ø¡Ø©', options: ['Ù…Ø¸Ù„Ù…', 'Ø®Ø§ÙØª', 'Ø³Ø§Ø·Ø¹', 'Ø´Ù…ÙˆØ¹', 'Ø·Ø¨ÙŠØ¹ÙŠ', 'Ù‚Ù…Ø±'] },
            { title: 'ğŸ’¡ Ø­Ø§Ù„Ø© Ù…Ø³Ø±Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©', options: ['Ø­Ø·Ø§Ù…', 'Ø±Ù…Ø§Ø¯', 'Ø¨Ù‚Ø¹Ø© Ù…Ø§Ø¡', 'Ù…Ø´Ù‚Ù‚', 'ÙÙˆØ¶Ù‰ Ø¹Ø§Ø±Ù…Ø©', 'Ù…Ø±ØªØ¨'] },
            { title: 'ğŸ” Ø§Ù„Ø§Ø¯Ù„Ø© Ø§Ù„Ù…ØªØ±ÙˆÙƒØ©', options: ['Ø·Ø¨ÙŠØ¹ÙŠØ©', 'ÙÙ†ÙŠØ©', 'Ù…ÙƒØªÙˆØ¨Ø©', 'Ø§ØµØ·Ù†Ø§Ø¹ÙŠØ©', 'Ø´Ø®ØµÙŠØ©', 'Ù„Ø§Ø¹Ù„Ø§Ù‚Ø© Ù„Ù‡Ø§ Ø¨Ø§Ù„Ø¬Ø«Ø©'] },
            { title: 'ğŸ’ Ø£Ø¯Ø§Ø© Ù…Ø³Ø§Ø¹Ø¯Ø©', options: ['Ø­Ù‚ÙŠØ¨Ø©', 'Ø³ÙŠØ§Ø±Ø©', 'Ù‚ÙØ§Ø²Ø§Øª', 'Ù‚Ù†Ø§Ø¹', 'Ù‡Ø§ØªÙ', 'Ù…ÙØªØ§Ø­'] }
        ];

        var LOCATION_CARDS = [
            { title: 'ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©', options: ['ØºØ±ÙØ© Ù†ÙˆÙ…', 'Ù…Ø·Ø¨Ø®', 'Ø­Ù…Ø§Ù…', 'ØºØ±ÙØ© Ø¬Ù„ÙˆØ³', 'Ø´Ø±ÙÙ‡', 'ØºØ±ÙØ© ØªØ®Ø²ÙŠÙ†'], isLocation: true },
            { title: 'ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©', options: ['Ù…Ù„Ø¹Ø¨', 'ØµÙ', 'Ù…Ù‡Ø¬Ø¹', 'ÙƒØ§ÙØªÙŠØ±ÙŠØ§', 'Ù…ØµØ¹Ø¯', 'Ù…Ø±Ø­Ø§Ø¶'], isLocation: true },
            { title: 'ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©', options: ['Ø­Ø¯ÙŠÙ‚Ø©', 'Ø¨ÙŠØª Ø§Ù„Ø¹Ø·Ù„Ø©', 'Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª', 'ØºØ§Ø¨Ø©', 'Ù…Ø¯Ø±Ø³Ø©', 'Ø¨Ù†Ùƒ'], isLocation: true },
            { title: 'ğŸ“ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©', options: ['Ø­Ø§Ù†Ø©', 'ÙÙ†Ø¯Ù‚', 'Ù…ÙƒØªØ¨Ø©', 'Ù…Ø³ØªØ´ÙÙ‰', 'ÙˆØ±Ø´Ø© Ø¨Ù†Ø§Ø¡', 'ÙÙ†Ø¯Ù‚'], isLocation: true }
        ];

        // ========== State ==========
        var game = {
            roomCode: null,
            oderId: null,
            name: null,
            isHost: false,
            players: [],
            maxPlayers: 4,
            started: false,
            role: null,
            weapon: null,
            evidence: null,
            murderer: null,
            accomplice: null,
            witness: null,
            forensic: null,
            clues: [],
            votes: [],
            phase: 'waiting',
            round: 1,
            cards: [],
            ready: false,
            locationChanged: false,
            replacedInRound: {}
        };

        game.hasAccomplice = true;

        var selectedWeapon = null;
        var selectedEvidence = null;
        var selectedSuspect = null;
        var selectedSuspectWeapon = null;
        var selectedSuspectEvidence = null;
        var hasVoted = false;
        var selectedCardToReplace = null;

        // ========== Session ==========
        function saveSession() {
            try {
                sessionStorage.setItem('dg', JSON.stringify({
                    roomCode: game.roomCode,
                    oderId: game.oderId,
                    name: game.name,
                    isHost: game.isHost
                }));
            } catch (e) {
                console.error('Session save error:', e);
            }
        }

        function loadSession() {
            try {
                var s = JSON.parse(sessionStorage.getItem('dg'));
                if (s && s.roomCode && s.oderId) {
                    game.roomCode = s.roomCode;
                    game.oderId = s.oderId;
                    game.name = s.name;
                    game.isHost = s.isHost;
                    return true;
                }
            } catch(e) {
                console.error('Session load error:', e);
            }
            return false;
        }

        // ========== Utils ==========
        function genId() { return Math.random().toString(36).substr(2, 8); }
        function genCode() {
            var c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789', r = '';
            for (var i = 0; i < 4; i++) r += c[Math.floor(Math.random() * c.length)];
            return r;
        }
        function shuffle(a) {
            var arr = a.slice();
            for (var i = arr.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var t = arr[i]; arr[i] = arr[j]; arr[j] = t;
            }
            return arr;
        }
        function sortByName(players) {
            return players.slice().sort(function(a, b) {
                return a.name.localeCompare(b.name, 'ar');
            });
        }
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
            var screen = document.getElementById(id);
            if (screen) {
                screen.classList.add('active');
            }
        }

        // ========== Room ==========
        function createRoom() {
            var name = document.getElementById('hostName').value.trim();
            if (!name) { alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ'); return; }

            game.roomCode = genCode();
            game.oderId = genId();
            game.name = name;
            game.isHost = true;
            game.maxPlayers = parseInt(document.getElementById('playerCount').value);
            game.players = [{ id: game.oderId, name: name, isHost: true }];

            saveSession();
            db.ref('rooms/' + game.roomCode).set(game).then(function() {
                showScreen('lobbyScreen');
                updateLobby();
                document.getElementById('hostControls').classList.remove('hidden');
                listen();
                initChat();
            }).catch(function(err) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                console.error(err);
            });
        }

        function joinRoom() {
            var name = document.getElementById('playerName').value.trim();
            var code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            if (!name || !code) { alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ±Ù…Ø² Ø§Ù„ØºØ±ÙØ©'); return; }

            db.ref('rooms/' + code).once('value').then(function(snap) {
                if (!snap.exists()) { alert('ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }
                var d = snap.val();
                if (d.started) { alert('Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª'); return; }
                if (d.players && d.players.length >= d.maxPlayers) { alert('Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©'); return; }

                game.roomCode = code;
                game.oderId = genId();
                game.name = name;
                game.isHost = false;
                game.players = d.players || [];
                game.maxPlayers = d.maxPlayers;
                game.players.push({ id: game.oderId, name: name, isHost: false });

                saveSession();
                db.ref('rooms/' + code + '/players').set(game.players).then(function() {
                    showScreen('lobbyScreen');
                    updateLobby();
                    listen();
                    initChat();
                }).catch(function(err) {
                    alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                    console.error(err);
                });
            }).catch(function(err) {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.');
                console.error(err);
            });
        }

        function updateLobby() {
            document.getElementById('displayRoomCode').textContent = game.roomCode;
            document.getElementById('playerCountDisplay').textContent = game.players.length;
            document.getElementById('maxPlayerDisplay').textContent = game.maxPlayers;

            var list = document.getElementById('lobbyPlayersList');
            list.innerHTML = '';
            game.players.forEach(function(p) {
                var div = document.createElement('div');
                div.className = 'lobby-player' + (p.isHost ? ' host' : '');
                var html = '<span>' + p.name + '</span>';
                if (p.isHost) {
                    html += '<span>ğŸ‘‘</span>';
                } else if (game.isHost) {
                    html += '<button onclick="kickPlayer(\'' + p.id + '\')" class="btn-small btn-danger" style="padding:3px 8px;font-size:10px;">Ø·Ø±Ø¯</button>';
                }
                div.innerHTML = html;
                list.appendChild(div);
            });

            var btn = document.getElementById('startBtn');
            if (btn) btn.disabled = game.players.length < 4;
        }

        // ========== Start Game ==========
        function startGame() {
            if (game.players.length < 4) { alert('ÙŠØ¬Ø¨ 4 Ù„Ø§Ø¹Ø¨ÙŠÙ†'); return; }

            var shuffled = shuffle(game.players);
            var hasAccomplice = shuffled.length > 6;
            var roles = hasAccomplice ? ['forensic', 'murderer', 'accomplice', 'witness'] : ['forensic', 'murderer', 'witness'];
            var startIdx = hasAccomplice ? 4 : 3;
            for (var i = startIdx; i < shuffled.length; i++) roles.push('investigator');

            var allWeapons = shuffle(WEAPONS.slice());
            var allEvidence = shuffle(EVIDENCE.slice());
            var weaponIndex = 0;
            var evidenceIndex = 0;

            shuffled.forEach(function(p, i) {
                p.role = roles[i];
                if (p.role !== 'forensic') {
                    p.weapons = allWeapons.slice(weaponIndex, weaponIndex + 4);
                    p.evidence = allEvidence.slice(evidenceIndex, evidenceIndex + 4);
                    weaponIndex += 4;
                    evidenceIndex += 4;
                } else {
                    p.weapons = [];
                    p.evidence = [];
                }
            });

            var murderer = shuffled.find(function(p) { return p.role === 'murderer'; });
            var accomplice = shuffled.find(function(p) { return p.role === 'accomplice'; });
            var witness = shuffled.find(function(p) { return p.role === 'witness'; });
            var forensic = shuffled.find(function(p) { return p.role === 'forensic'; });

            game.players = shuffled;
            game.started = true;
            game.murderer = murderer.name;
            game.accomplice = accomplice ? accomplice.name : null;
            game.witness = witness.name;
            game.forensic = forensic.name;
            game.hasAccomplice = hasAccomplice;
            game.weapon = null;
            game.evidence = null;
            game.ready = false;
            game.clues = [];
            game.votes = [];
            game.phase = 'choosing';
            game.round = 1;
            
            var causeOfDeath = CLUE_CARDS[0];
            var randomLocation = LOCATION_CARDS[Math.floor(Math.random() * LOCATION_CARDS.length)];
            var randomCards = shuffle(CLUE_CARDS.slice(1)).slice(0, 4);
            game.cards = [causeOfDeath, randomLocation].concat(randomCards);
            game.locationChanged = false;
            game.replacedInRound = {};

            db.ref('rooms/' + game.roomCode).set(game);
        }

        function restartGame() {
            if (!game.isHost) {
                alert('ÙÙ‚Ø· Ø§Ù„Ù…Ø¶ÙŠÙ ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù„Ø¹Ø¨Ø©');
                return;
            }

            var resetPlayers = game.players.map(function(p) {
                return {
                    id: p.id,
                    name: p.name,
                    isHost: p.isHost,
                    role: null,
                    weapons: [],
                    evidence: []
                };
            });

            var resetGame = {
                roomCode: game.roomCode,
                maxPlayers: game.maxPlayers,
                players: resetPlayers,
                started: false,
                weapon: null,
                evidence: null,
                murderer: null,
                accomplice: null,
                witness: null,
                forensic: null,
                clues: [],
                votes: [],
                phase: 'waiting',
                round: 1,
                cards: [],
                ready: false,
                locationChanged: false,
                replacedInRound: {},
                correctVoter: null,
                witnessGuess: null
            };

            db.ref('rooms/' + game.roomCode).set(resetGame);
            // Clear chat for new game
            db.ref('rooms/' + game.roomCode + '/chat').remove();
            if (chatInitialized) {
                document.getElementById('chatMessages').innerHTML = '<div class="chat-empty" id="chatEmpty"><div>ğŸ’¬<br>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</div></div>';
            }
        }

        function kickPlayer(playerId) {
            if (!game.isHost) return;
            if (game.started) {
                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø·Ø±Ø¯ Ù„Ø§Ø¹Ø¨ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©');
                return;
            }
            game.players = game.players.filter(function(p) { return p.id !== playerId; });
            db.ref('rooms/' + game.roomCode + '/players').set(game.players);
        }

        function leaveRoom() {
            if (game.started) {
                alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©');
                return;
            }

            destroyChat();

            if (game.isHost) {
                if (confirm('Ø£Ù†Øª Ø§Ù„Ù…Ø¶ÙŠÙ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØºØ±ÙØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ')) {
                    db.ref('rooms/' + game.roomCode).remove();
                    sessionStorage.clear();
                    location.reload();
                }
            } else {
                game.players = game.players.filter(function(p) { return p.id !== game.oderId; });
                db.ref('rooms/' + game.roomCode + '/players').set(game.players).then(function() {
                    sessionStorage.clear();
                    location.reload();
                });
            }
        }

        // ========== Show Game ==========
        function showGame() {
            showScreen('gameScreen');
            
            var me = game.players.find(function(p) { return p.id === game.oderId; });
            if (!me) return;
            game.role = me.role;

            showRole(me);
            
            if (game.phase === 'choosing') {
                if (me.role === 'murderer') {
                    showMurdererSelection(me);
                } else {
                    document.getElementById('waitingMurderer').classList.remove('hidden');
                    showMyItemsWhileWaiting(me);
                }
            } else if (game.phase === 'playing') {
                showPlaying(me);
            } else if (game.phase === 'witness_guess') {
                showWitnessGuess();
            } else if (game.phase === 'ended' || game.phase === 'murderer_wins' || game.phase === 'investigators_win' || game.phase === 'murderer_wins_all_wrong') {
                showResult();
            }
        }

        function showMyItemsWhileWaiting(me) {
            if (me.role === 'forensic') return;
            
            var itemsDiv = document.getElementById('myItems');
            itemsDiv.classList.remove('hidden');
            
            var html = '<h4 style="color:#f39c12;margin-bottom:12px;">ğŸ‘ï¸ Ø£Ø³Ù„Ø­Ø© ÙˆØ£Ø¯Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</h4>';
            
            sortByName(game.players).forEach(function(player) {
                if (player.role === 'forensic') return;
                
                var isMe = player.id === game.oderId;
                html += '<div style="margin-bottom:10px;padding:10px;background:' + (isMe ? 'rgba(231,76,60,0.2)' : 'rgba(255,255,255,0.08)') + ';border-radius:8px;' + (isMe ? 'border:2px solid #e74c3c;' : 'border:1px solid rgba(255,255,255,0.1);') + '">';
                html += '<strong style="color:' + (isMe ? '#e74c3c' : '#d4af37') + ';font-size:0.95em;display:block;margin-bottom:6px;">' + player.name + (isMe ? ' (Ø£Ù†Øª)' : '') + '</strong>';
                
                html += '<div style="margin-bottom:6px;">';
                html += '<span style="color:#e74c3c;font-size:0.8em;">âš”ï¸ Ø§Ù„Ø£Ø³Ù„Ø­Ø©: </span>';
                player.weapons.forEach(function(w) {
                    html += '<span class="item-tag" style="background:rgba(231,76,60,0.25);font-size:0.75em;">' + w + '</span>';
                });
                html += '</div>';
                
                html += '<div>';
                html += '<span style="color:#3498db;font-size:0.8em;">ğŸ” Ø§Ù„Ø£Ø¯Ù„Ø©: </span>';
                player.evidence.forEach(function(e) {
                    html += '<span class="item-tag" style="background:rgba(52,152,219,0.25);font-size:0.75em;">' + e + '</span>';
                });
                html += '</div>';
                
                html += '</div>';
            });
            
            itemsDiv.innerHTML = html;
        }

        function showRole(p) {
            var card = document.getElementById('roleCard');
            var icon = document.getElementById('roleIcon');
            var title = document.getElementById('roleTitle');
            var desc = document.getElementById('roleDesc');

            var r = {
                murderer: { i: 'ğŸ”ª', t: 'Ø§Ù„Ù‚Ø§ØªÙ„', d: 'Ø§Ø®ØªØ± Ø³Ù„Ø§Ø­Ùƒ ÙˆØ¯Ù„ÙŠÙ„Ùƒ!' },
                accomplice: { i: 'ğŸ¤', t: 'Ø§Ù„Ø´Ø±ÙŠÙƒ', d: 'Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø§ØªÙ„!' },
                witness: { i: 'ğŸ‘ï¸', t: 'Ø§Ù„Ø´Ø§Ù‡Ø¯', d: 'ØªØ¹Ø±Ù Ø§Ù„Ù…ØªÙ‡Ù…ÙÙŠÙ†!' },
                forensic: { i: 'ğŸ”¬', t: 'Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ', d: 'Ù‚Ø¯Ù… Ø§Ù„Ø£Ø¯Ù„Ø©!' },
                investigator: { i: 'ğŸ”', t: 'Ù…Ø­Ù‚Ù‚', d: 'Ø§ÙƒØ´Ù Ø§Ù„Ù‚Ø§ØªÙ„!' }
            }[p.role];

            card.className = 'role-card ' + p.role;
            icon.textContent = r.i;
            title.textContent = r.t;
            desc.textContent = r.d;

            var sec = document.getElementById('secretInfo');
            var wit = document.getElementById('witnessInfo');
            sec.classList.add('hidden');
            wit.classList.add('hidden');

            if (p.role === 'murderer') {
                sec.classList.remove('hidden');
                if (game.accomplice) {
                    sec.innerHTML = '<p>ğŸ¤ Ø´Ø±ÙŠÙƒÙƒ: <strong>' + game.accomplice + '</strong></p>';
                } else {
                    sec.innerHTML = '<p>âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø±ÙŠÙƒ - Ø£Ù†Øª ÙˆØ­Ø¯Ùƒ!</p>';
                }
            } else if (p.role === 'accomplice') {
                sec.classList.remove('hidden');
                var html = '<p>ğŸ”ª Ø§Ù„Ù‚Ø§ØªÙ„: <strong>' + game.murderer + '</strong></p>';
                if (game.weapon) {
                    html += '<p>âš”ï¸ Ø§Ù„Ø³Ù„Ø§Ø­: <strong>' + game.weapon + '</strong></p>';
                    html += '<p>ğŸ” Ø§Ù„Ø¯Ù„ÙŠÙ„: <strong>' + game.evidence + '</strong></p>';
                }
                sec.innerHTML = html;
            } else if (p.role === 'witness') {
                wit.classList.remove('hidden');
                if (game.accomplice) {
                    wit.innerHTML = '<h4>ğŸ‘ï¸ Ø§Ù„Ù…ØªÙ‡Ù…Ø§Ù†:</h4><p style="font-size:1.1em;margin-top:8px;"><strong>' + 
                        game.murderer + '</strong> Ùˆ <strong>' + game.accomplice + '</strong></p>' +
                        '<p style="color:#f39c12;font-size:0.85em;margin-top:8px;">âš ï¸ Ù„Ø§ ØªØ¹Ø±Ù Ù…Ù† Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆÙ…Ù† Ø§Ù„Ø´Ø±ÙŠÙƒ!</p>';
                } else {
                    wit.innerHTML = '<h4>ğŸ‘ï¸ Ø§Ù„Ù…ØªÙ‡Ù…:</h4><p style="font-size:1.1em;margin-top:8px;"><strong>' + 
                        game.murderer + '</strong> Ù‡Ùˆ Ø§Ù„Ù‚Ø§ØªÙ„!</p>' +
                        '<p style="color:#f39c12;font-size:0.85em;margin-top:8px;">âš ï¸ Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ† Ø¨Ø¯ÙˆÙ† Ø£Ù† ÙŠÙƒØ´ÙÙƒ Ø§Ù„Ù‚Ø§ØªÙ„!</p>';
                }
            }
        }

        function showMurdererSelection(p) {
            var sec = document.getElementById('murdererSelection');
            sec.classList.remove('hidden');

            var allDiv = document.getElementById('allPlayersItems');
            allDiv.innerHTML = '<h4 style="margin-bottom:10px;color:#f39c12;">ğŸ‘ï¸ Ø£Ø³Ù„Ø­Ø© ÙˆØ£Ø¯Ù„Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</h4>';
            
            sortByName(game.players).forEach(function(player) {
                if (player.role === 'forensic') return;
                
                var isMe = player.id === game.oderId;
                var itemHtml = '<div style="margin-bottom:8px;padding:6px;background:rgba(255,255,255,0.1);border-radius:5px;' + (isMe ? 'border:2px solid #e74c3c;' : '') + '">';
                itemHtml += '<strong style="color:' + (isMe ? '#e74c3c' : '#fff') + ';font-size:0.9em;">' + player.name + (isMe ? ' (Ø£Ù†Øª)' : '') + '</strong><br>';
                itemHtml += '<span style="font-size:0.8em;color:#e74c3c;">âš”ï¸ ' + player.weapons.join(' | ') + '</span><br>';
                itemHtml += '<span style="font-size:0.8em;color:#3498db;">ğŸ” ' + player.evidence.join(' | ') + '</span>';
                itemHtml += '</div>';
                allDiv.innerHTML += itemHtml;
            });

            var wDiv = document.getElementById('murdererWeapons');
            var eDiv = document.getElementById('murdererEvidence');
            wDiv.innerHTML = '';
            eDiv.innerHTML = '';

            p.weapons.forEach(function(w) {
                var btn = document.createElement('button');
                btn.className = 'sel-btn';
                btn.textContent = w;
                btn.onclick = function() { selectMurder('w', w, btn); };
                wDiv.appendChild(btn);
            });

            p.evidence.forEach(function(e) {
                var btn = document.createElement('button');
                btn.className = 'sel-btn';
                btn.textContent = e;
                btn.onclick = function() { selectMurder('e', e, btn); };
                eDiv.appendChild(btn);
            });
        }

        function selectMurder(type, val, btn) {
            var container = btn.parentElement;
            container.querySelectorAll('.sel-btn').forEach(function(b) { b.classList.remove('selected'); });
            btn.classList.add('selected');

            if (type === 'w') selectedWeapon = val;
            else selectedEvidence = val;

            document.getElementById('confirmMurderBtn').disabled = !(selectedWeapon && selectedEvidence);
        }

        function confirmMurderChoice() {
            if (!selectedWeapon || !selectedEvidence) return;

            game.weapon = selectedWeapon;
            game.evidence = selectedEvidence;
            game.ready = true;
            game.phase = 'playing';

            db.ref('rooms/' + game.roomCode).update({
                weapon: game.weapon,
                evidence: game.evidence,
                ready: true,
                phase: 'playing'
            });
        }

        function showPlaying(me) {
            document.getElementById('murdererSelection').classList.add('hidden');
            document.getElementById('waitingMurderer').classList.add('hidden');

            if (me.role !== 'forensic') {
                var items = document.getElementById('myItems');
                items.classList.remove('hidden');
                var html = '<h4>ğŸ’ Ø£Ø¯ÙˆØ§ØªÙŠ:</h4>';
                html += '<div>âš”ï¸ ';
                me.weapons.forEach(function(w) { html += '<span class="item-tag">' + w + '</span>'; });
                html += '</div><div style="margin-top:5px;">ğŸ” ';
                me.evidence.forEach(function(e) { html += '<span class="item-tag">' + e + '</span>'; });
                html += '</div>';
                items.innerHTML = html;
            }

            if (me.role === 'accomplice') {
                var sec = document.getElementById('secretInfo');
                sec.classList.remove('hidden');
                sec.innerHTML = '<p>ğŸ”ª Ø§Ù„Ù‚Ø§ØªÙ„: <strong>' + game.murderer + '</strong></p>' +
                    '<p>âš”ï¸ Ø§Ù„Ø³Ù„Ø§Ø­: <strong>' + game.weapon + '</strong></p>' +
                    '<p>ğŸ” Ø§Ù„Ø¯Ù„ÙŠÙ„: <strong>' + game.evidence + '</strong></p>';
            }

            document.getElementById('playersSection').classList.remove('hidden');
            renderPlayers();

            document.getElementById('cluesBar').classList.remove('hidden');
            updateCluesBar();

            if (me.role === 'forensic') {
                document.getElementById('forensicPanel').classList.remove('hidden');
                document.getElementById('fMurderer').textContent = game.murderer;
                if (game.accomplice) {
                    document.getElementById('fAccomplice').textContent = game.accomplice;
                    document.getElementById('fAccompliceRow').style.display = '';
                } else {
                    document.getElementById('fAccompliceRow').style.display = 'none';
                }
                document.getElementById('fWitness').textContent = game.witness;
                document.getElementById('fWeapon').textContent = game.weapon;
                document.getElementById('fEvidence').textContent = game.evidence;
                renderForensicCards();
            }
        }

        // ========== Clues Bar ==========
        function toggleCluesBar() {
            document.getElementById('cluesBar').classList.toggle('expanded');
        }

        function updateCluesBar() {
            document.getElementById('cluesCount').textContent = game.clues.length;
            
            var summary = document.getElementById('cluesSummary');
            var full = document.getElementById('cluesListFull');
            
            if (game.clues.length === 0) {
                summary.innerHTML = '<span class="clue-tag">Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ...</span>';
                full.innerHTML = '<p style="text-align:center;padding:20px;opacity:0.7;">Ù„Ù… ÙŠØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø£Ø¯Ù„Ø© Ø¨Ø¹Ø¯</p>';
            } else {
                summary.innerHTML = '';
                full.innerHTML = '';
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù„Ø®Øµ
                game.clues.forEach(function(c) {
                    summary.innerHTML += '<span class="clue-tag">' + c.option + '</span>';
                });
                
                // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„
                game.cards.forEach(function(card, idx) {
                    var selectedClue = game.clues.find(function(c) { return c.cardIndex === idx; });
                    
                    full.innerHTML += '<div class="clue-card" style="background:rgba(255,255,255,0.15);border-radius:10px;padding:12px;margin-bottom:12px;">';
                    full.innerHTML += '<strong style="color:#2ecc71;display:block;margin-bottom:8px;">' + card.title + '</strong>';
                    full.innerHTML += '<div style="display:flex;flex-wrap:wrap;gap:6px;">';
                    
                    card.options.forEach(function(opt) {
                        var isSelected = selectedClue && selectedClue.option === opt;
                        full.innerHTML += '<span class="clue-tag" style="' + 
                            (isSelected ? 'background:#2ecc71;color:#000;font-weight:bold;font-size:0.9em;padding:6px 12px;border:2px solid #fff;box-shadow:0 0 10px rgba(46,204,113,0.5);' : 'background:rgba(255,255,255,0.2);opacity:0.7;') + 
                            '">' + opt + (isSelected ? ' âœ“' : '') + '</span>';
                    });
                    
                    full.innerHTML += '</div></div>';
                });
            }

            if (game.role === 'forensic') {
                document.getElementById('currentRound').textContent = game.round;
                document.getElementById('cluesInRound').textContent = game.clues.length;
                
                var btn = document.getElementById('nextRoundBtn');
                if (btn) {
                    if (game.clues.length >= 6 && game.round < 3) {
                        btn.style.display = 'block';
                    } else {
                        btn.style.display = 'none';
                    }
                }
            }
        }

        function renderForensicCards() {
            var container = document.getElementById('forensicCards');
            if (!container) return;
            container.innerHTML = '';

            var alreadyReplacedThisRound = game.replacedInRound && game.replacedInRound[game.round];

            game.cards.forEach(function(card, idx) {
                var used = game.clues.some(function(c) { return c.cardIndex === idx; });
                var div = document.createElement('div');
                div.className = 'clue-card' + (used ? ' used' : '');
                
                var canReplace = false;
                if (game.round > 1 && !alreadyReplacedThisRound && used) {
                    if (card.fixed) {
                        canReplace = false;
                    } else if (card.isLocation) {
                        canReplace = !game.locationChanged;
                    } else {
                        canReplace = true;
                    }
                }

                var cardLabel = card.title;
                if (card.fixed) cardLabel += ' <span style="color:#e74c3c;font-size:0.7em;">(Ø«Ø§Ø¨Øª)</span>';
                if (card.isLocation && game.locationChanged) cardLabel += ' <span style="color:#f39c12;font-size:0.7em;">(ØªÙ… ØªØºÙŠÙŠØ±Ù‡)</span>';

                var html = '<h5>' + cardLabel;
                if (canReplace) {
                    html += ' <button onclick="selectForReplace(' + idx + ')" class="btn-small" style="margin-right:10px;background:#e67e22;font-size:10px;">ğŸ”„</button>';
                }
                html += '</h5><div class="clue-options">';
                
                card.options.forEach(function(opt) {
                    var sel = game.clues.some(function(c) { return c.cardIndex === idx && c.option === opt; });
                    html += '<button class="clue-opt' + (sel ? ' selected' : '') + '" ' +
                        (used ? 'disabled' : 'onclick="selectClue(' + idx + ',\'' + opt + '\')"') + '>' + opt + '</button>';
                });
                html += '</div>';

                div.innerHTML = html;
                container.appendChild(div);
            });
        }

        function selectForReplace(idx) {
            selectedCardToReplace = idx;
            replaceMode = null;
            var modal = document.getElementById('replaceModal');
            document.getElementById('replaceCardTitle').textContent = game.cards[idx].title;
            document.getElementById('replaceDesc').textContent = 'Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„';
            document.getElementById('replaceConfirmBtn').disabled = true;
            document.getElementById('modeCardBtn').classList.remove('selected-mode');
            document.getElementById('modeOptionBtn').classList.remove('selected-mode');
            modal.classList.add('active');
        }

        var replaceMode = null;

        function setReplaceMode(mode) {
            replaceMode = mode;
            var cardBtn = document.getElementById('modeCardBtn');
            var optBtn = document.getElementById('modeOptionBtn');
            var desc = document.getElementById('replaceDesc');
            var confirmBtn = document.getElementById('replaceConfirmBtn');
            
            cardBtn.classList.remove('selected-mode');
            optBtn.classList.remove('selected-mode');
            
            if (mode === 'card') {
                cardBtn.classList.add('selected-mode');
                desc.textContent = 'ğŸ”„ Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙƒØ§Ù…Ù„Ø© Ø¨Ø¨Ø·Ø§Ù‚Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ø£Ø®Ø±Ù‰';
            } else {
                optBtn.classList.add('selected-mode');
                desc.textContent = 'âœï¸ Ø³ÙŠØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø®ÙŠØ§Ø± Ø¢Ø®Ø± Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©';
            }
            confirmBtn.disabled = false;
        }

        function cancelReplace() {
            selectedCardToReplace = null;
            replaceMode = null;
            document.getElementById('replaceModal').classList.remove('active');
        }

        function confirmReplace() {
            if (selectedCardToReplace === null || !replaceMode) return;

            var idx = selectedCardToReplace;
            var currentCard = game.cards[idx];
            
            if (replaceMode === 'card') {
                // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙƒØ§Ù…Ù„Ø©
                var newCard = null;
                
                if (currentCard.isLocation) {
                    var availableLocations = LOCATION_CARDS.filter(function(c) {
                        return c.options.join() !== currentCard.options.join();
                    });
                    if (availableLocations.length > 0) {
                        newCard = availableLocations[Math.floor(Math.random() * availableLocations.length)];
                        game.locationChanged = true;
                    }
                } else {
                    var usedTitles = game.cards.map(function(c) { return c.title; });
                    var available = CLUE_CARDS.filter(function(c) { 
                        return !usedTitles.includes(c.title) && !c.fixed && !c.isLocation; 
                    });
                    if (available.length > 0) {
                        newCard = available[Math.floor(Math.random() * available.length)];
                    }
                }

                if (newCard) {
                    game.cards[idx] = newCard;
                    game.clues = game.clues.filter(function(c) { return c.cardIndex !== idx; });
                }
            } else {
                // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø®ÙŠØ§Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· - Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø­ØªÙ‰ ÙŠØ®ØªØ§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯
                game.clues = game.clues.filter(function(c) { return c.cardIndex !== idx; });
            }
            
            if (!game.replacedInRound) game.replacedInRound = {};
            game.replacedInRound[game.round] = true;

            db.ref('rooms/' + game.roomCode).update({
                cards: game.cards,
                clues: game.clues,
                locationChanged: game.locationChanged,
                replacedInRound: game.replacedInRound
            });

            selectedCardToReplace = null;
            replaceMode = null;
            document.getElementById('replaceModal').classList.remove('active');
            renderForensicCards();
            updateCluesBar();
        }

        function selectClue(idx, opt) {
            game.clues = game.clues.filter(function(c) { return c.cardIndex !== idx; });
            game.clues.push({
                cardIndex: idx,
                title: game.cards[idx].title,
                option: opt,
                round: game.round
            });

            db.ref('rooms/' + game.roomCode + '/clues').set(game.clues);
            renderForensicCards();
            updateCluesBar();
        }

        function nextRound() {
            if (game.round >= 3) return;
            game.round++;
            
            db.ref('rooms/' + game.roomCode).update({
                round: game.round
            });

            document.getElementById('currentRound').textContent = game.round;
            renderForensicCards();
            updateCluesBar();
        }

        // ========== Players & Voting ==========
        function renderPlayers() {
            var container = document.getElementById('playersList');
            if (!container) return;
            container.innerHTML = '';

            var myVote = game.votes.find(function(v) { return v.oderId === game.oderId; });
            if (myVote) hasVoted = true;

            var votesOnMe = game.votes.filter(function(v) { return v.suspect === game.name; });

            checkAllVotedWrong();

            if (votesOnMe.length > 0) {
                var alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger';
                alertDiv.style.marginBottom = '15px';
                var alertHtml = '<h4>âš ï¸ ØªÙ… Ø§Ù„ØªØµÙˆÙŠØª Ø¹Ù„ÙŠÙƒ!</h4>';
                votesOnMe.forEach(function(v) {
                    alertHtml += '<p>ğŸ—³ï¸ <strong>' + v.voter + '</strong> ÙŠØªÙ‡Ù…Ùƒ Ø¨Ù€: ' + v.weapon + ' Ùˆ ' + v.evidence + '</p>';
                });
                alertDiv.innerHTML = alertHtml;
                container.appendChild(alertDiv);
            }

            sortByName(game.players).forEach(function(p) {
                if (p.id === game.oderId) return;

                var card = document.createElement('div');
                card.className = 'player-card';
                card.id = 'pc_' + p.id;

                if (p.role === 'forensic') {
                    card.classList.add('forensic-card');
                    card.innerHTML = '<div class="player-header"><span class="player-name forensic-badge">ğŸ”¬ ' + p.name + ' (Ø·Ø¨ÙŠØ¨ Ø´Ø±Ø¹ÙŠ)</span></div>';
                    container.appendChild(card);
                    return;
                }

                if (selectedSuspect === p.id) {
                    card.classList.add('selected-suspect');
                }

                if (selectedSuspect === p.id && selectedSuspectWeapon && selectedSuspectEvidence && !hasVoted && game.role !== 'forensic') {
                    card.classList.add('ready-vote');
                }

                var html = '<div class="player-header">';
                if (!hasVoted && game.role !== 'forensic') {
                    html += '<span class="player-name" onclick="toggleSuspect(\'' + p.id + '\')">' + p.name + '</span>';
                } else {
                    html += '<span class="player-name" style="cursor:default;">' + p.name + '</span>';
                }
                html += '</div>';

                html += '<div class="player-items">';
                html += '<span style="width:100%;font-size:0.8em;color:#e74c3c;margin-bottom:3px;">âš”ï¸ Ø§Ù„Ø£Ø³Ù„Ø­Ø©:</span>';
                p.weapons.forEach(function(w) {
                    var sel = selectedSuspect === p.id && selectedSuspectWeapon === w;
                    if (!hasVoted && game.role !== 'forensic' && selectedSuspect === p.id) {
                        html += '<button class="item-btn weapon' + (sel ? ' selected' : '') + '" onclick="selectVoteItem(\'' + p.id + '\',\'w\',\'' + w + '\')">' + w + '</button>';
                    } else {
                        html += '<span class="item-btn weapon" style="cursor:default;' + (selectedSuspect !== p.id ? 'opacity:0.7;' : '') + '">' + w + '</span>';
                    }
                });
                html += '</div>';

                html += '<div class="player-items">';
                html += '<span style="width:100%;font-size:0.8em;color:#3498db;margin-bottom:3px;">ğŸ” Ø§Ù„Ø£Ø¯Ù„Ø©:</span>';
                p.evidence.forEach(function(e) {
                    var sel = selectedSuspect === p.id && selectedSuspectEvidence === e;
                    if (!hasVoted && game.role !== 'forensic' && selectedSuspect === p.id) {
                        html += '<button class="item-btn evidence' + (sel ? ' selected' : '') + '" onclick="selectVoteItem(\'' + p.id + '\',\'e\',\'' + e + '\')">' + e + '</button>';
                    } else {
                        html += '<span class="item-btn evidence" style="cursor:default;' + (selectedSuspect !== p.id ? 'opacity:0.7;' : '') + '">' + e + '</span>';
                    }
                });
                html += '</div>';

                if (selectedSuspect === p.id && !hasVoted && game.role !== 'forensic') {
                    html += '<button class="vote-btn btn-danger" onclick="submitVote(\'' + p.id + '\',\'' + p.name + '\')">ğŸ—³ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙˆÙŠØª</button>';
                } else if (!hasVoted && game.role !== 'forensic') {
                    html += '<button class="vote-btn btn-secondary" onclick="toggleSuspect(\'' + p.id + '\')">ğŸ‘† Ø§Ø¶ØºØ· Ù„Ù„Ø§ØªÙ‡Ø§Ù…</button>';
                }

                if (hasVoted && myVote && game.role !== 'forensic') {
                    html += '<div class="alert alert-info" style="margin-top:10px;padding:8px;font-size:0.85em;">âœ… Ù„Ù‚Ø¯ ØµÙˆÙ‘Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹</div>';
                }

                var votesOn = game.votes.filter(function(v) { return v.suspect === p.name; });
                if (votesOn.length > 0) {
                    votesOn.forEach(function(v) {
                        html += '<div class="vote-info">ğŸ—³ï¸ <strong>' + v.voter + '</strong> ÙŠØªÙ‡Ù… Ø¨Ù€: ' + v.weapon + ' Ùˆ ' + v.evidence + '</div>';
                    });
                }

                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        function checkAllVotedWrong() {
            var investigators = game.players.filter(function(p) {
                return p.role !== 'forensic';
            });

            if (game.votes.length >= investigators.length) {
                var anyCorrect = game.votes.some(function(v) { return v.correct; });
                
                if (!anyCorrect && game.phase === 'playing') {
                    game.phase = 'murderer_wins_all_wrong';
                    db.ref('rooms/' + game.roomCode + '/phase').set('murderer_wins_all_wrong');
                }
            }
        }

        function toggleSuspect(id) {
            if (game.role === 'forensic' || hasVoted) return;
            
            if (selectedSuspect === id) {
                selectedSuspect = null;
                selectedSuspectWeapon = null;
                selectedSuspectEvidence = null;
            } else {
                selectedSuspect = id;
                selectedSuspectWeapon = null;
                selectedSuspectEvidence = null;
            }
            renderPlayers();
        }

        function selectVoteItem(playerId, type, val) {
            if (game.role === 'forensic' || hasVoted) return;
            
            if (selectedSuspect !== playerId) {
                selectedSuspect = playerId;
                selectedSuspectWeapon = null;
                selectedSuspectEvidence = null;
            }

            if (type === 'w') {
                selectedSuspectWeapon = selectedSuspectWeapon === val ? null : val;
            } else {
                selectedSuspectEvidence = selectedSuspectEvidence === val ? null : val;
            }

            renderPlayers();
        }

        function submitVote(playerId, playerName) {
            if (hasVoted) {
                alert('Ù„Ù‚Ø¯ ØµÙˆÙ‘Øª Ù…Ø³Ø¨Ù‚Ø§Ù‹!');
                return;
            }
            
            if (!selectedSuspectWeapon || !selectedSuspectEvidence) {
                alert('Ø§Ø®ØªØ± Ø§Ù„Ø³Ù„Ø§Ø­ ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„');
                return;
            }

            var correct = playerName === game.murderer &&
                selectedSuspectWeapon === game.weapon &&
                selectedSuspectEvidence === game.evidence;

            var vote = {
                oderId: game.oderId,
                voter: game.name,
                suspectId: playerId,
                suspect: playerName,
                weapon: selectedSuspectWeapon,
                evidence: selectedSuspectEvidence,
                correct: correct,
                time: Date.now()
            };

            game.votes.push(vote);
            hasVoted = true;

            if (correct) {
                game.phase = 'witness_guess';
                game.correctVoter = game.name;
                db.ref('rooms/' + game.roomCode).update({
                    votes: game.votes,
                    phase: 'witness_guess',
                    correctVoter: game.name
                });
            } else {
                db.ref('rooms/' + game.roomCode + '/votes').set(game.votes);
            }

            selectedSuspect = null;
            selectedSuspectWeapon = null;
            selectedSuspectEvidence = null;
            renderPlayers();
        }

        // ========== End Game ==========
        function showWitnessGuess() {
            document.getElementById('playersSection').classList.add('hidden');
            document.getElementById('cluesBar').classList.add('hidden');
            document.getElementById('myItems').classList.add('hidden');
            document.getElementById('secretInfo').classList.add('hidden');
            document.getElementById('witnessInfo').classList.add('hidden');
            document.getElementById('roleCard').classList.add('hidden');

            var res = document.getElementById('gameResults');
            res.classList.remove('hidden');
            res.innerHTML = '';

            var box = document.createElement('div');
            box.className = 'results-box';

            var html = '<div class="result-icon">ğŸ¯</div>';
            html += '<div class="result-title">ØªÙ… ÙƒØ´Ù Ø§Ù„Ù‚Ø§ØªÙ„!</div>';
            html += '<p><strong>' + (game.correctVoter || 'Ù…Ø­Ù‚Ù‚') + '</strong> Ø§ÙƒØªØ´Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©!</p>';
            html += '<div class="truth-reveal">';
            html += '<p>ğŸ”ª Ø§Ù„Ù‚Ø§ØªÙ„: <strong>' + game.murderer + '</strong></p>';
            html += '<p>âš”ï¸ Ø§Ù„Ø³Ù„Ø§Ø­: <strong>' + game.weapon + '</strong></p>';
            html += '<p>ğŸ” Ø§Ù„Ø¯Ù„ÙŠÙ„: <strong>' + game.evidence + '</strong></p>';
            html += '</div>';

            box.innerHTML = html;
            res.appendChild(box);

            if (game.role === 'murderer') {
                var alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger';
                alertDiv.innerHTML = '<h3>âš ï¸ ØªÙ… Ø§ØµØ·ÙŠØ§Ø¯Ùƒ!</h3><p>Ø­Ø¯Ø¯ Ø§Ù„Ø´Ø§Ù‡Ø¯ Ù„Ù„ÙÙˆØ²!</p>';
                box.appendChild(alertDiv);

                var selectEl = document.createElement('select');
                selectEl.id = 'witnessGuessSelect';
                selectEl.style.cssText = 'width:100%;padding:15px;margin:15px 0;font-size:18px;border-radius:10px;border:2px solid #e74c3c;';
                
                game.players.forEach(function(p) {
                    if (p.role !== 'murderer' && p.role !== 'accomplice' && p.role !== 'forensic') {
                        var opt = document.createElement('option');
                        opt.value = p.name;
                        opt.textContent = p.name;
                        selectEl.appendChild(opt);
                    }
                });
                box.appendChild(selectEl);

                var confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn-full btn-danger';
                confirmBtn.style.cssText = 'padding:18px;font-size:18px;margin-top:10px;';
                confirmBtn.textContent = 'âœ“ ØªØ£ÙƒÙŠØ¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø´Ø§Ù‡Ø¯';
                confirmBtn.onclick = function() {
                    var sel = document.getElementById('witnessGuessSelect');
                    if (sel && sel.value) {
                        var guess = sel.value;
                        game.witnessGuess = guess;
                        game.phase = (guess === game.witness) ? 'murderer_wins' : 'investigators_win';
                        db.ref('rooms/' + game.roomCode).update({
                            witnessGuess: guess,
                            phase: game.phase
                        });
                    }
                };
                box.appendChild(confirmBtn);
            } else {
                var waitDiv = document.createElement('div');
                waitDiv.className = 'alert alert-info';
                waitDiv.innerHTML = '<p>â³ Ø§Ù„Ù‚Ø§ØªÙ„ ÙŠØ­Ø¯Ø¯ Ø§Ù„Ø´Ø§Ù‡Ø¯...</p>';
                box.appendChild(waitDiv);
            }
        }

        function showResult() {
            document.getElementById('playersSection').classList.add('hidden');
            document.getElementById('cluesBar').classList.add('hidden');
            document.getElementById('myItems').classList.add('hidden');
            document.getElementById('secretInfo').classList.add('hidden');
            document.getElementById('witnessInfo').classList.add('hidden');
            document.getElementById('roleCard').classList.add('hidden');

            var res = document.getElementById('gameResults');
            res.classList.remove('hidden');

            var win = game.phase === 'murderer_wins' || game.phase === 'murderer_wins_all_wrong';

            var html = '<div class="results-box">';
            html += '<div class="result-icon">' + (win ? 'ğŸ”ª' : 'ğŸ‰') + '</div>';
            html += '<div class="result-title">' + (win ? (game.accomplice ? 'Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆØ§Ù„Ø´Ø±ÙŠÙƒ ÙŠÙÙˆØ²Ø§Ù†!' : 'Ø§Ù„Ù‚Ø§ØªÙ„ ÙŠÙÙˆØ²!') : 'Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ† ÙŠÙÙˆØ²ÙˆÙ†!') + '</div>';
            
            if (game.phase === 'murderer_wins_all_wrong') {
                html += '<p>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ† Ø£Ø®Ø·Ø£ÙˆØ§ ÙÙŠ Ø§Ù„ØªØµÙˆÙŠØª!</p>';
            } else if (win) {
                html += '<p>Ø§Ù„Ù‚Ø§ØªÙ„ Ø­Ø¯Ø¯ Ø§Ù„Ø´Ø§Ù‡Ø¯ Ø¨Ù†Ø¬Ø§Ø­!</p>';
            } else {
                html += '<p>Ø§Ù„Ù‚Ø§ØªÙ„ ÙØ´Ù„ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø§Ù‡Ø¯!</p>';
            }
            
            html += '<div class="truth-reveal">';
            html += '<p>ğŸ”ª Ø§Ù„Ù‚Ø§ØªÙ„: <strong>' + game.murderer + '</strong></p>';
            if (game.accomplice) {
                html += '<p>ğŸ¤ Ø§Ù„Ø´Ø±ÙŠÙƒ: <strong>' + game.accomplice + '</strong></p>';
            }
            html += '<p>ğŸ‘ï¸ Ø§Ù„Ø´Ø§Ù‡Ø¯: <strong>' + game.witness + '</strong></p>';
            html += '<p>ğŸ”¬ Ø§Ù„Ø·Ø¨ÙŠØ¨: <strong>' + game.forensic + '</strong></p>';
            html += '<hr style="margin:10px 0;border-color:rgba(255,255,255,0.2);">';
            html += '<p>âš”ï¸ Ø§Ù„Ø³Ù„Ø§Ø­: <strong>' + game.weapon + '</strong></p>';
            html += '<p>ğŸ” Ø§Ù„Ø¯Ù„ÙŠÙ„: <strong>' + game.evidence + '</strong></p>';
            if (game.witnessGuess) {
                html += '<hr style="margin:10px 0;border-color:rgba(255,255,255,0.2);">';
                html += '<p>ğŸ¯ ØªØ®Ù…ÙŠÙ† Ø§Ù„Ù‚Ø§ØªÙ„: <strong>' + game.witnessGuess + '</strong> ' + 
                    (game.witnessGuess === game.witness ? 'âœ…' : 'âŒ') + '</p>';
            }
            html += '</div>';
            
            if (game.isHost) {
                html += '<button onclick="restartGame()" class="btn-full btn-success" style="margin-top:15px;">ğŸ”„ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø© (Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†)</button>';
            } else {
                html += '<p style="margin-top:15px;opacity:0.7;">Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù…Ø¶ÙŠÙ Ù„Ø¨Ø¯Ø¡ Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©...</p>';
            }
            html += '<button onclick="exitGame()" class="btn-full btn-secondary" style="margin-top:10px;">ğŸšª Ø®Ø±ÙˆØ¬</button>';
            html += '</div>';

            res.innerHTML = html;
        }

        function exitGame() {
            if (roomRef) roomRef.off();
            destroyChat();
            sessionStorage.clear();
            db.ref('rooms/' + game.roomCode + '/players').once('value').then(function(snap) {
                if (snap.exists()) {
                    var players = snap.val();
                    var updatedPlayers = players.filter(function(p) { return p.id !== game.oderId; });
                    
                    if (updatedPlayers.length === 0 || game.isHost) {
                        db.ref('rooms/' + game.roomCode).remove();
                    } else {
                        db.ref('rooms/' + game.roomCode + '/players').set(updatedPlayers);
                    }
                }
                setTimeout(function() {
                    window.location.href = window.location.origin + window.location.pathname;
                }, 100);
            }).catch(function() {
                setTimeout(function() {
                    window.location.href = window.location.origin + window.location.pathname;
                }, 100);
            });
        }

        // ========== Firebase Listener ==========
        var roomRef = null;

        function listen() {
            if (roomRef) roomRef.off();
            roomRef = db.ref('rooms/' + game.roomCode);

            roomRef.on('value', function(snap) {
                if (!snap.exists()) return;
                var d = snap.val();

                game.players = d.players || [];
                game.maxPlayers = d.maxPlayers;

                if (game.started && !d.started) {
                    game.started = false;
                    game.role = null;
                    game.weapon = null;
                    game.evidence = null;
                    game.murderer = null;
                    game.accomplice = null;
                    game.witness = null;
                    game.forensic = null;
                    game.clues = [];
                    game.votes = [];
                    game.phase = 'waiting';
                    game.round = 1;
                    game.cards = [];
                    game.ready = false;
                    game.locationChanged = false;
                    game.replacedInRound = {};
                    game.correctVoter = null;
                    game.witnessGuess = null;
                    
                    hasVoted = false;
                    selectedWeapon = null;
                    selectedEvidence = null;
                    selectedSuspect = null;
                    selectedSuspectWeapon = null;
                    selectedSuspectEvidence = null;
                    selectedCardToReplace = null;
                    
                    document.getElementById('gameResults').classList.add('hidden');
                    document.getElementById('murdererSelection').classList.add('hidden');
                    document.getElementById('waitingMurderer').classList.add('hidden');
                    document.getElementById('forensicPanel').classList.add('hidden');
                    document.getElementById('playersSection').classList.add('hidden');
                    document.getElementById('cluesBar').classList.add('hidden');
                    document.getElementById('myItems').classList.add('hidden');
                    document.getElementById('secretInfo').classList.add('hidden');
                    document.getElementById('witnessInfo').classList.add('hidden');
                    document.getElementById('roleCard').classList.add('hidden');
                    
                    // Clear chat messages for new game
                    document.getElementById('chatMessages').innerHTML = '<div class="chat-empty" id="chatEmpty"><div>ğŸ’¬<br>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</div></div>';
                    
                    showScreen('lobbyScreen');
                    updateLobby();
                    if (game.isHost) {
                        document.getElementById('hostControls').classList.remove('hidden');
                    }
                    return;
                }

                if (!game.started && !d.started) {
                    updateLobby();
                    return;
                }

                game.started = d.started;
                game.weapon = d.weapon;
                game.evidence = d.evidence;
                game.murderer = d.murderer;
                game.accomplice = d.accomplice;
                game.witness = d.witness;
                game.forensic = d.forensic;
                game.cards = d.cards || [];
                game.clues = d.clues || [];
                game.votes = d.votes || [];
                game.round = d.round || 1;
                game.ready = d.ready;
                game.correctVoter = d.correctVoter;
                game.witnessGuess = d.witnessGuess;
                game.hasAccomplice = d.hasAccomplice !== undefined ? d.hasAccomplice : true;
                game.phase = d.phase || 'waiting';
                game.locationChanged = d.locationChanged || false;
                game.replacedInRound = d.replacedInRound || {};

                if (!game.votes || game.votes.length === 0) {
                    hasVoted = false;
                } else {
                    var myVote = game.votes.find(function(v) { return v.oderId === game.oderId; });
                    hasVoted = !!myVote;
                }

                if (game.started) {
                    if (game.phase === 'murderer_wins' || game.phase === 'investigators_win' || game.phase === 'murderer_wins_all_wrong') {
                        showResult();
                    } else {
                        showGame();
                    }
                }
            });
        }

        // ========== Init ==========
        window.onload = function() {
            console.log('App initialized');
            
            if (loadSession()) {
                db.ref('rooms/' + game.roomCode).once('value').then(function(snap) {
                    if (snap.exists()) {
                        var d = snap.val();
                        var found = d.players && d.players.some(function(p) { return p.id === game.oderId; });
                        
                        if (found) {
                            game.players = d.players;
                            game.maxPlayers = d.maxPlayers;
                            game.started = d.started;
                            game.weapon = d.weapon;
                            game.evidence = d.evidence;
                            game.murderer = d.murderer;
                            game.accomplice = d.accomplice;
                            game.witness = d.witness;
                            game.forensic = d.forensic;
                            game.cards = d.cards || [];
                            game.clues = d.clues || [];
                            game.votes = d.votes || [];
                            game.phase = d.phase || 'waiting';
                            game.round = d.round || 1;
                            game.correctVoter = d.correctVoter;
                            game.witnessGuess = d.witnessGuess;
                            game.hasAccomplice = d.hasAccomplice !== undefined ? d.hasAccomplice : true;

                            if (d.started) {
                                showGame();
                            } else {
                                showScreen('lobbyScreen');
                                updateLobby();
                                if (game.isHost) document.getElementById('hostControls').classList.remove('hidden');
                            }
                            listen();
                            initChat();
                        } else {
                            sessionStorage.clear();
                            showScreen('homeScreen');
                        }
                    } else {
                        sessionStorage.clear();
                        showScreen('homeScreen');
                    }
                }).catch(function(err) {
                    console.error('Error loading room:', err);
                    sessionStorage.clear();
                    showScreen('homeScreen');
                });
            } else {
                showScreen('homeScreen');
            }
        };
    </script>
    <!-- Chat FAB Button -->
    <button class="chat-fab hidden" id="chatFab" onclick="toggleChat()">
        ğŸ’¬
        <div class="chat-badge" id="chatBadge">0</div>
    </button>

    <!-- Chat Panel -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <h4><span>ğŸ’¬</span> Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h4>
            <button class="chat-close-btn" onclick="toggleChat()">âœ•</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-empty" id="chatEmpty">
                <div>ğŸ’¬<br>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©..." maxlength="200" autocomplete="off">
            <button class="chat-send-btn" onclick="sendChatMessage()">â¤</button>
        </div>
    </div>

    <script>
        // ========== Chat System ==========
        var chatRef = null;
        var chatOpen = false;
        var chatUnread = 0;
        var chatInitialized = false;

        function initChat() {
            if (!game.roomCode || chatInitialized) return;
            chatInitialized = true;
            
            document.getElementById('chatFab').classList.remove('hidden');
            
            chatRef = db.ref('rooms/' + game.roomCode + '/chat');
            
            chatRef.on('child_added', function(snap) {
                var msg = snap.val();
                renderChatMessage(msg);
                
                if (!chatOpen) {
                    chatUnread++;
                    updateChatBadge();
                    var fab = document.getElementById('chatFab');
                    fab.classList.remove('has-unread');
                    void fab.offsetWidth;
                    fab.classList.add('has-unread');
                }
                
                var container = document.getElementById('chatMessages');
                setTimeout(function() {
                    container.scrollTop = container.scrollHeight;
                }, 50);
            });
        }

        function destroyChat() {
            if (chatRef) chatRef.off();
            chatRef = null;
            chatInitialized = false;
            chatOpen = false;
            chatUnread = 0;
            document.getElementById('chatFab').classList.add('hidden');
            document.getElementById('chatPanel').classList.remove('open');
            document.getElementById('chatMessages').innerHTML = '<div class="chat-empty" id="chatEmpty"><div>ğŸ’¬<br>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ù…Ø¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</div></div>';
            updateChatBadge();
        }

        function toggleChat() {
            chatOpen = !chatOpen;
            var panel = document.getElementById('chatPanel');
            
            if (chatOpen) {
                panel.classList.add('open');
                chatUnread = 0;
                updateChatBadge();
                document.getElementById('chatInput').focus();
                var container = document.getElementById('chatMessages');
                setTimeout(function() {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            } else {
                panel.classList.remove('open');
            }
        }

        function updateChatBadge() {
            var badge = document.getElementById('chatBadge');
            if (chatUnread > 0) {
                badge.textContent = chatUnread > 99 ? '99+' : chatUnread;
                badge.classList.add('visible');
            } else {
                badge.classList.remove('visible');
            }
        }

        function sendChatMessage() {
            var input = document.getElementById('chatInput');
            var text = input.value.trim();
            if (!text || !game.roomCode || !game.name) return;
            
            var empty = document.getElementById('chatEmpty');
            if (empty) empty.style.display = 'none';
            
            var msgData = {
                senderId: game.oderId,
                senderName: game.name,
                text: text,
                time: Date.now()
            };
            
            chatRef.push(msgData);
            input.value = '';
            input.focus();
        }

        function renderChatMessage(msg) {
            var container = document.getElementById('chatMessages');
            
            var empty = document.getElementById('chatEmpty');
            if (empty) empty.style.display = 'none';
            
            var div = document.createElement('div');
            var isMe = msg.senderId === game.oderId;
            var isSystem = msg.type === 'system';
            
            if (isSystem) {
                div.className = 'chat-msg system-msg';
                div.textContent = msg.text;
            } else {
                div.className = 'chat-msg ' + (isMe ? 'me' : 'other');
                
                var time = new Date(msg.time);
                var hours = time.getHours();
                var minutes = time.getMinutes();
                var ampm = hours >= 12 ? 'Ù…' : 'Øµ';
                hours = hours % 12;
                hours = hours ? hours : 12;
                var timeStr = hours + ':' + (minutes < 10 ? '0' : '') + minutes + ' ' + ampm;
                
                div.innerHTML = '<div class="msg-sender">' + escapeHtml(msg.senderName) + '</div>' +
                    '<div class="msg-text">' + escapeHtml(msg.text) + '</div>' +
                    '<div class="msg-time">' + timeStr + '</div>';
            }
            
            container.appendChild(div);
        }

        function escapeHtml(text) {
            var d = document.createElement('div');
            d.appendChild(document.createTextNode(text));
            return d.innerHTML;
        }

        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendChatMessage();
            }
        });
    </script>
</body>
</html>
