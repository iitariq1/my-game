<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø®Ø§Ø¯Ø¹</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 10px;
            direction: rtl;
            color: #fff;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .screen { display: none; }
        .screen.active { display: block; }

        .header {
            text-align: center;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 15px;
            margin-bottom: 15px;
        }

        .header h1 { font-size: 1.5em; color: #ffd700; }

        .card {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            margin: 8px 0;
            font-size: 16px;
            font-family: 'Cairo', sans-serif;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin: 5px 0;
            transition: transform 0.2s;
        }

        button:hover { transform: scale(1.02); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .btn-success { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .btn-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .btn-secondary { background: #6c757d; }

        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† */
        .players-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-card {
            background: rgba(255,255,255,0.95);
            color: #333;
            padding: 15px;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .player-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-name {
            font-weight: bold;
            font-size: 1.1em;
            background: #fff;
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            border: 2px solid #333;
        }

        .player-items {
            display: none;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .player-card.expanded .player-items { display: flex; }

        .item-btn {
            width: auto;
            padding: 8px 12px;
            font-size: 12px;
            margin: 2px;
            background: #e0e0e0;
            color: #333;
        }

        .item-btn.selected {
            background: #667eea;
            color: white;
        }

        .item-btn.weapon { border-left: 3px solid #e74c3c; }
        .item-btn.evidence { border-left: 3px solid #3498db; }

        .vote-btn {
            width: auto;
            padding: 8px 20px;
            background: #e74c3c;
            display: none;
        }

        .player-card.ready-to-vote .vote-btn { display: inline-block; }

        .vote-info {
            background: rgba(0,0,0,0.1);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            display: none;
        }

        .player-card.voted .vote-info { display: block; }
        .player-card.voted .player-items { display: none; }
        .player-card.voted .vote-btn { display: none; }

        /* Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯ÙˆØ± */
        .role-card {
            text-align: center;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
        }

        .role-card.murderer { background: linear-gradient(135deg, #c0392b, #e74c3c); }
        .role-card.accomplice { background: linear-gradient(135deg, #8e44ad, #9b59b6); }
        .role-card.witness { background: linear-gradient(135deg, #f39c12, #e67e22); }
        .role-card.forensic { background: linear-gradient(135deg, #2980b9, #3498db); }
        .role-card.investigator { background: linear-gradient(135deg, #27ae60, #2ecc71); }

        .role-icon { font-size: 4em; }
        .role-title { font-size: 1.8em; margin: 10px 0; }

        /* Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ Ø§Ù„Ø¹Ø§Ø¦Ù…Ø© */
        .forensic-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(41, 128, 185, 0.95);
            border-radius: 15px;
            padding: 10px;
            z-index: 1000;
            max-height: 50vh;
            overflow-y: auto;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .forensic-panel.minimized {
            max-height: 50px;
            overflow: hidden;
        }

        .forensic-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 5px;
        }

        .forensic-panel-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
        }

        .forensic-clue-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
        }

        .clue-options {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .clue-option-btn {
            width: auto;
            padding: 6px 12px;
            font-size: 12px;
            background: rgba(255,255,255,0.2);
        }

        .clue-option-btn.selected {
            background: #27ae60;
        }

        /* Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© */
        .public-clues {
            background: rgba(39, 174, 96, 0.2);
            border: 2px solid #27ae60;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .clue-item {
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 5px 0;
        }

        /* Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ */
        .results-screen {
            text-align: center;
            padding: 30px;
        }

        .results-screen.win { background: linear-gradient(135deg, #27ae60, #2ecc71); }
        .results-screen.lose { background: linear-gradient(135deg, #c0392b, #e74c3c); }

        .result-icon { font-size: 5em; }
        .result-title { font-size: 2em; margin: 20px 0; }

        /* Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ© */
        .secret-info {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .room-code {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            letter-spacing: 5px;
        }

        .lobby-player {
            background: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 8px;
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
        }

        .lobby-player.host { border-right: 3px solid #ffd700; }

        /* ØªÙ†Ø¨ÙŠÙ‡Ø§Øª */
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
        }

        .alert-info { background: rgba(52, 152, 219, 0.3); }
        .alert-success { background: rgba(39, 174, 96, 0.3); }
        .alert-danger { background: rgba(231, 76, 60, 0.3); }
        .alert-warning { background: rgba(241, 196, 15, 0.3); }

        .hidden { display: none !important; }

        /* Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø®Ø§ØµØ© */
        .my-items {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
        }

        .my-items h4 { margin-bottom: 10px; color: #ffd700; }
        .my-items span { 
            display: inline-block; 
            background: rgba(255,255,255,0.1); 
            padding: 5px 10px; 
            border-radius: 5px; 
            margin: 3px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Ø§Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
        <div id="homeScreen" class="screen active">
            <div class="header">
                <h1>ğŸ” Ø§Ù„Ù…Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø®Ø§Ø¯Ø¹ ğŸ”ª</h1>
                <p>Ù„Ø¹Ø¨Ø© Ø§Ù„ØºÙ…ÙˆØ¶ ÙˆØ§Ù„ØªØ­Ù‚ÙŠÙ‚</p>
            </div>
            
            <div class="card">
                <p style="text-align: center; margin-bottom: 20px; line-height: 1.8;">
                    Ø­Ø¯Ø«Øª Ø¬Ø±ÙŠÙ…Ø© Ù‚ØªÙ„! Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆØ§Ù„Ø´Ø±ÙŠÙƒ ÙŠØ­Ø§ÙˆÙ„Ø§Ù† Ø§Ù„Ø¥ÙÙ„Ø§ØªØŒ ÙˆØ§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ ÙŠØ¹Ø±Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø© ÙˆÙŠØ³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ† Ø¨Ø§Ù„Ø£Ø¯Ù„Ø©.
                    Ø§Ù„Ø´Ø§Ù‡Ø¯ ÙŠØ¹Ø±Ù Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆØ§Ù„Ø´Ø±ÙŠÙƒ Ù„ÙƒÙ†Ù‡ Ù„Ø§ ÙŠØ¹Ø±Ù ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©.
                </p>
                <button onclick="showScreen('createRoomScreen')">ğŸ  Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
                <button onclick="showScreen('joinRoomScreen')" class="btn-secondary">ğŸšª Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</button>
            </div>
        </div>

        <!-- Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© -->
        <div id="createRoomScreen" class="screen">
            <div class="header">
                <h1>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</h1>
            </div>
            <div class="card">
                <label>Ø§Ø³Ù…Ùƒ:</label>
                <input type="text" id="hostName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
                
                <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†:</label>
                <select id="playerCount">
                    <option value="4">4 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="5">5 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="6">6 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="7">7 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="8">8 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                </select>
                
                <button onclick="createRoom()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©</button>
                <button onclick="showScreen('homeScreen')" class="btn-secondary">Ø±Ø¬ÙˆØ¹</button>
            </div>
        </div>

        <!-- Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© -->
        <div id="joinRoomScreen" class="screen">
            <div class="header">
                <h1>Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</h1>
            </div>
            <div class="card">
                <label>Ø§Ø³Ù…Ùƒ:</label>
                <input type="text" id="playerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
                
                <label>Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©:</label>
                <input type="text" id="roomCodeInput" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©" style="text-transform: uppercase;">
                
                <button onclick="joinRoom()">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
                <button onclick="showScreen('homeScreen')" class="btn-secondary">Ø±Ø¬ÙˆØ¹</button>
            </div>
        </div>

        <!-- ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± -->
        <div id="lobbyScreen" class="screen">
            <div class="header">
                <h1>ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h1>
                <div class="room-code" id="displayRoomCode">----</div>
            </div>
            <div class="card">
                <h3>Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† (<span id="playerCountDisplay">0</span>/<span id="maxPlayerDisplay">4</span>)</h3>
                <div id="lobbyPlayersList"></div>
            </div>
            <div id="hostControls" class="hidden">
                <button onclick="startGame()" class="btn-success" id="startBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
            </div>
        </div>

        <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© -->
        <div id="gameScreen" class="screen">
            <!-- Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¯ÙˆØ± -->
            <div id="roleCard" class="role-card">
                <div class="role-icon" id="roleIcon">ğŸ”</div>
                <div class="role-title" id="roleTitle">Ø¯ÙˆØ±Ùƒ</div>
                <div id="roleDescription"></div>
            </div>

            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ© -->
            <div id="secretInfo" class="secret-info hidden"></div>

            <!-- Ø£Ø¯ÙˆØ§ØªÙŠ -->
            <div id="myItems" class="my-items">
                <h4>ğŸ’ Ø£Ø¯ÙˆØ§ØªÙŠ:</h4>
                <div id="myWeapons"></div>
                <div id="myEvidence"></div>
            </div>

            <!-- Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© -->
            <div class="public-clues">
                <h3>ğŸ“‹ Ø£Ø¯Ù„Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ:</h3>
                <div id="publicCluesList">
                    <p style="color: #aaa;">Ù„Ù… ÙŠØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø£Ø¯Ù„Ø© Ø¨Ø¹Ø¯...</p>
                </div>
            </div>

            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„ØªØµÙˆÙŠØª -->
            <div class="card">
                <h3>ğŸ‘¥ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†:</h3>
                <div id="playersVotingList" class="players-list"></div>
            </div>

            <!-- Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
            <div id="gameResults" class="hidden"></div>
        </div>

        <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ -->
        <div id="forensicPanel" class="forensic-panel hidden">
            <div class="forensic-panel-header" onclick="toggleForensicPanel()">
                <span>ğŸ”¬ Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ</span>
                <button class="forensic-panel-toggle" id="panelToggleBtn">â–¼</button>
            </div>
            <div id="forensicContent">
                <div class="secret-info">
                    <p>ğŸ”ª <strong>Ø§Ù„Ù‚Ø§ØªÙ„:</strong> <span id="forensicMurderer">-</span></p>
                    <p>ğŸ¤ <strong>Ø§Ù„Ø´Ø±ÙŠÙƒ:</strong> <span id="forensicAccomplice">-</span></p>
                    <p>ğŸ‘ï¸ <strong>Ø§Ù„Ø´Ø§Ù‡Ø¯:</strong> <span id="forensicWitness">-</span></p>
                    <p>âš”ï¸ <strong>Ø§Ù„Ø³Ù„Ø§Ø­:</strong> <span id="forensicWeapon">-</span></p>
                    <p>ğŸ” <strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> <span id="forensicEvidence">-</span></p>
                </div>
                <div id="forensicClueCards"></div>
            </div>
        </div>
    </div>

    <script>
        // ==================== Firebase ====================
        var firebaseConfig = {
            apiKey: "AIzaSyB88NCDQzsUzHZgH07B63e4Dpxc3LfXSyY",
            authDomain: "detective-game-df960.firebaseapp.com",
            databaseURL: "https://detective-game-df960-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "detective-game-df960"
        };

        firebase.initializeApp(firebaseConfig);
        window.db = firebase.database();

        // ==================== Game Data ====================
        var WEAPONS = [
            'ğŸ”« Ù…Ø³Ø¯Ø³', 'ğŸ”ª Ø³ÙƒÙŠÙ†', 'ğŸª¢ Ø­Ø¨Ù„', 'â˜ ï¸ Ø³Ù…', 'ğŸª“ ÙØ£Ø³', 'ğŸ”¨ Ù…Ø·Ø±Ù‚Ø©',
            'âš¾ Ø¹ØµØ§ Ø¨ÙŠØ³Ø¨ÙˆÙ„', 'âœ‚ï¸ Ù…Ù‚Øµ', 'ğŸ’‰ Ø­Ù‚Ù†Ø©', 'ğŸ”Œ ÙƒØ§Ø¨Ù„ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ',
            'ğŸª› Ù…ÙÙƒ Ø¨Ø±Ø§ØºÙŠ', 'ğŸ”© Ù‚Ø¶ÙŠØ¨ Ø­Ø¯ÙŠØ¯ÙŠ', 'âš”ï¸ Ø³ÙŠÙ', 'ğŸ¹ Ù‚ÙˆØ³ ÙˆÙ†Ø´Ø§Ø¨',
            'â›“ï¸ Ø³Ù„Ø³Ù„Ø©', 'ğŸ”§ Ù…ÙØªØ§Ø­ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ', 'ğŸª¨ Ø­Ø¬Ø± Ø«Ù‚ÙŠÙ„', 'ğŸ—¡ï¸ Ø®Ù†Ø¬Ø±',
            'ğŸ³ Ù…Ù‚Ù„Ø§Ø©', 'ğŸ Ù‡Ø±Ø§ÙˆØ©', 'âš¡ ØµØ§Ø¹Ù‚ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ', 'ğŸ”¥ Ù†Ø§Ø±'
        ];

        var EVIDENCE = [
            'ğŸ‘£ Ø¢Ø«Ø§Ø± Ø£Ù‚Ø¯Ø§Ù…', 'ğŸ©¸ Ø¨Ù‚Ø¹Ø© Ø¯Ù…', 'ğŸ’‡ Ø´Ø¹Ø±Ø©', 'ğŸ‘† Ø¨ØµÙ…Ø©', 'ğŸ§µ Ù‚Ù…Ø§Ø´ Ù…Ù…Ø²Ù‚',
            'ğŸ“± Ù‡Ø§ØªÙ', 'ğŸ”‘ Ù…ÙØªØ§Ø­', 'ğŸ’ Ø®Ø§ØªÙ…', 'ğŸ« ØªØ°ÙƒØ±Ø©', 'ğŸ“ Ø±Ø³Ø§Ù„Ø©',
            'ğŸ§¤ Ù‚ÙØ§Ø²', 'ğŸ‘“ Ù†Ø¸Ø§Ø±Ø©', 'âŒš Ø³Ø§Ø¹Ø©', 'ğŸ­ Ù‚Ù†Ø§Ø¹', 'ğŸ§ª Ø¹ÙŠÙ†Ø©',
            'ğŸ“· ØµÙˆØ±Ø©', 'ğŸ’³ Ø¨Ø·Ø§Ù‚Ø©', 'ğŸ—ï¸ Ù…ÙØªØ§Ø­ Ù‚Ø¯ÙŠÙ…', 'ğŸ“œ ÙˆØ«ÙŠÙ‚Ø©', 'ğŸ’Š Ø­Ø¨ÙˆØ¨'
        ];

        var CLUE_CARDS = [
            { title: 'Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©', options: ['ØºØ±ÙØ© Ø§Ù„Ù†ÙˆÙ…', 'Ø§Ù„Ù…Ø·Ø¨Ø®', 'Ø§Ù„Ø­Ù…Ø§Ù…', 'ØºØ±ÙØ© Ø§Ù„Ù…Ø¹ÙŠØ´Ø©', 'Ø§Ù„Ù…Ø±Ø¢Ø¨', 'Ø§Ù„Ø­Ø¯ÙŠÙ‚Ø©'] },
            { title: 'ÙˆÙ‚Øª Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©', options: ['Ø§Ù„ÙØ¬Ø±', 'Ø§Ù„ØµØ¨Ø§Ø­', 'Ø§Ù„Ø¸Ù‡Ø±', 'Ø§Ù„Ø¹ØµØ±', 'Ø§Ù„Ù…Ø³Ø§Ø¡', 'Ù…Ù†ØªØµÙ Ø§Ù„Ù„ÙŠÙ„'] },
            { title: 'Ø­Ø§Ù„Ø© Ø§Ù„Ø¶Ø­ÙŠØ©', options: ['Ù†Ø§Ø¦Ù…', 'Ø¬Ø§Ù„Ø³', 'ÙˆØ§Ù‚Ù', 'ÙŠØ±ÙƒØ¶', 'ÙŠØ£ÙƒÙ„', 'ÙŠØªØ­Ø¯Ø« Ø¨Ø§Ù„Ù‡Ø§ØªÙ'] },
            { title: 'Ø§Ù„Ø¯Ø§ÙØ¹', options: ['Ø§Ù„Ù…Ø§Ù„', 'Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù…', 'Ø§Ù„ØºÙŠØ±Ø©', 'Ø§Ù„Ø³Ù„Ø·Ø©', 'Ø§Ù„Ø³Ø±', 'Ø§Ù„Ø­Ø¨'] },
            { title: 'Ø§Ù„Ø·Ù‚Ø³', options: ['Ù…Ø´Ù…Ø³', 'ØºØ§Ø¦Ù…', 'Ù…Ù…Ø·Ø±', 'Ø¹Ø§ØµÙ', 'Ø«Ù„Ø¬ÙŠ', 'Ø¶Ø¨Ø§Ø¨ÙŠ'] },
            { title: 'Ù…Ù„Ø§Ø¨Ø³ Ø§Ù„Ù‚Ø§ØªÙ„', options: ['Ø£Ø³ÙˆØ¯', 'Ø£Ø¨ÙŠØ¶', 'Ø£Ø­Ù…Ø±', 'Ø£Ø²Ø±Ù‚', 'Ù‚Ù†Ø§Ø¹', 'Ù‚ÙØ§Ø²Ø§Øª'] }
        ];

        // ==================== Game State ====================
        var gameState = {
            roomCode: null,
            playerId: null,
            playerName: null,
            isHost: false,
            players: [],
            gameStarted: false,
            role: null,
            murderWeapon: null,
            murderEvidence: null,
            murdererName: null,
            accompliceName: null,
            witnessName: null,
            clues: [],
            votes: [],
            gamePhase: 'playing',
            selectedVote: {}
        };

        // ==================== Session Storage ====================
        function saveSession() {
            sessionStorage.setItem('detectiveGame', JSON.stringify({
                roomCode: gameState.roomCode,
                playerId: gameState.playerId,
                playerName: gameState.playerName,
                isHost: gameState.isHost
            }));
        }

        function loadSession() {
            var saved = sessionStorage.getItem('detectiveGame');
            if (saved) {
                var data = JSON.parse(saved);
                if (data.roomCode && data.playerId) {
                    gameState.roomCode = data.roomCode;
                    gameState.playerId = data.playerId;
                    gameState.playerName = data.playerName;
                    gameState.isHost = data.isHost;
                    return true;
                }
            }
            return false;
        }

        // ==================== Utility Functions ====================
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function generateRoomCode() {
            var chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            var code = '';
            for (var i = 0; i < 4; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        function shuffle(array) {
            var arr = array.slice();
            for (var i = arr.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var temp = arr[i];
                arr[i] = arr[j];
                arr[j] = temp;
            }
            return arr;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(function(s) {
                s.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        // ==================== Room Management ====================
        function createRoom() {
            var hostName = document.getElementById('hostName').value.trim();
            var playerCount = parseInt(document.getElementById('playerCount').value);

            if (!hostName) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ');
                return;
            }

            gameState.roomCode = generateRoomCode();
            gameState.playerId = generateId();
            gameState.playerName = hostName;
            gameState.isHost = true;
            gameState.maxPlayers = playerCount;
            gameState.players = [{
                id: gameState.playerId,
                name: hostName,
                isHost: true
            }];

            saveSession();
            saveGameState().then(function() {
                showScreen('lobbyScreen');
                updateLobby();
                document.getElementById('hostControls').classList.remove('hidden');
                listenToRoom();
            });
        }

        function joinRoom() {
            var playerName = document.getElementById('playerName').value.trim();
            var roomCode = document.getElementById('roomCodeInput').value.trim().toUpperCase();

            if (!playerName || !roomCode) {
                alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ±Ù…Ø² Ø§Ù„ØºØ±ÙØ©');
                return;
            }

            gameState.roomCode = roomCode;
            gameState.playerId = generateId();
            gameState.playerName = playerName;
            gameState.isHost = false;

            loadGameState().then(function(data) {
                if (!data) {
                    alert('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    return;
                }

                if (data.gameStarted) {
                    alert('Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª Ø¨Ø§Ù„ÙØ¹Ù„');
                    return;
                }

                gameState.players = data.players || [];
                gameState.maxPlayers = data.maxPlayers;
                gameState.players.push({
                    id: gameState.playerId,
                    name: playerName,
                    isHost: false
                });

                saveSession();
                
                firebase.database().ref('rooms/' + roomCode).update({
                    players: gameState.players
                }).then(function() {
                    showScreen('lobbyScreen');
                    updateLobby();
                    listenToRoom();
                });
            });
        }

        function updateLobby() {
            document.getElementById('displayRoomCode').textContent = gameState.roomCode;
            document.getElementById('playerCountDisplay').textContent = gameState.players.length;
            document.getElementById('maxPlayerDisplay').textContent = gameState.maxPlayers || 4;

            var list = document.getElementById('lobbyPlayersList');
            list.innerHTML = '';
            
            gameState.players.forEach(function(p) {
                var div = document.createElement('div');
                div.className = 'lobby-player' + (p.isHost ? ' host' : '');
                div.innerHTML = '<span>' + p.name + '</span>' + 
                    (p.isHost ? '<span>ğŸ‘‘</span>' : '');
                list.appendChild(div);
            });

            var startBtn = document.getElementById('startBtn');
            if (startBtn && gameState.isHost) {
                startBtn.disabled = gameState.players.length < 4;
            }
        }

        // ==================== Game Start ====================
        function startGame() {
            if (gameState.players.length < 4) {
                alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ 4 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            var shuffledPlayers = shuffle(gameState.players);
            
            // Ø§Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„Ø«Ø§Ø¨ØªØ©: Ø·Ø¨ÙŠØ¨ Ø´Ø±Ø¹ÙŠØŒ Ù‚Ø§ØªÙ„ØŒ Ø´Ø±ÙŠÙƒØŒ Ø´Ø§Ù‡Ø¯
            var roles = ['forensic', 'murderer', 'accomplice', 'witness'];
            
            // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø­Ù‚Ù‚ÙˆÙ†
            for (var i = 4; i < shuffledPlayers.length; i++) {
                roles.push('investigator');
            }

            // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆØ§Ø±
            shuffledPlayers.forEach(function(player, index) {
                player.role = roles[index];
                player.weapons = shuffle(WEAPONS).slice(0, 4);
                player.evidence = shuffle(EVIDENCE).slice(0, 4);
            });

            // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆØ§Ù„Ø´Ø±ÙŠÙƒ ÙˆØ§Ù„Ø´Ø§Ù‡Ø¯
            var murderer = shuffledPlayers.find(function(p) { return p.role === 'murderer'; });
            var accomplice = shuffledPlayers.find(function(p) { return p.role === 'accomplice'; });
            var witness = shuffledPlayers.find(function(p) { return p.role === 'witness'; });

            gameState.players = shuffledPlayers;
            gameState.gameStarted = true;
            gameState.murdererName = murderer.name;
            gameState.accompliceName = accomplice.name;
            gameState.witnessName = witness.name;
            gameState.murderWeapon = murderer.weapons[0];
            gameState.murderEvidence = murderer.evidence[0];
            gameState.clues = [];
            gameState.votes = [];
            gameState.gamePhase = 'playing';
            gameState.forensicClueCards = shuffle(CLUE_CARDS).slice(0, 4);

            saveGameState();
        }

        // ==================== Game Display ====================
        function showGame() {
            showScreen('gameScreen');
            
            var myPlayer = gameState.players.find(function(p) {
                return p.id === gameState.playerId;
            });

            if (myPlayer) {
                gameState.role = myPlayer.role;
                showRole(myPlayer);
                showMyItems(myPlayer);
                renderPlayersForVoting();

                if (myPlayer.role === 'forensic') {
                    showForensicPanel();
                }
            }
        }

        function showRole(player) {
            var roleCard = document.getElementById('roleCard');
            var roleIcon = document.getElementById('roleIcon');
            var roleTitle = document.getElementById('roleTitle');
            var roleDesc = document.getElementById('roleDescription');
            var secretInfo = document.getElementById('secretInfo');

            roleCard.className = 'role-card ' + player.role;

            var roles = {
                murderer: { icon: 'ğŸ”ª', title: 'Ø§Ù„Ù‚Ø§ØªÙ„', desc: 'Ø£Ù†Øª Ø§Ù„Ù‚Ø§ØªÙ„! Ø§Ø®ØªØ¨Ø¦ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ†.' },
                accomplice: { icon: 'ğŸ¤', title: 'Ø§Ù„Ø´Ø±ÙŠÙƒ', desc: 'Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø§ØªÙ„ ÙÙŠ Ø§Ù„Ø¥ÙÙ„Ø§Øª!' },
                witness: { icon: 'ğŸ‘ï¸', title: 'Ø§Ù„Ø´Ø§Ù‡Ø¯', desc: 'Ø£Ù†Øª ØªØ¹Ø±Ù Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆØ§Ù„Ø´Ø±ÙŠÙƒØŒ Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ† Ø¨Ø­Ø°Ø±!' },
                forensic: { icon: 'ğŸ”¬', title: 'Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ', desc: 'Ù‚Ø¯Ù… Ø§Ù„Ø£Ø¯Ù„Ø© Ù„Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ†.' },
                investigator: { icon: 'ğŸ”', title: 'Ù…Ø­Ù‚Ù‚', desc: 'Ø§ÙƒØªØ´Ù Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆØ§Ù„Ø³Ù„Ø§Ø­ ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„!' }
            };

            var r = roles[player.role];
            roleIcon.textContent = r.icon;
            roleTitle.textContent = r.title;
            roleDesc.textContent = r.desc;

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø³Ø±ÙŠØ©
            secretInfo.classList.add('hidden');
            secretInfo.innerHTML = '';

            if (player.role === 'murderer') {
                var accomplice = gameState.players.find(function(p) { return p.role === 'accomplice'; });
                secretInfo.classList.remove('hidden');
                secretInfo.innerHTML = 
                    '<p>ğŸ¤ <strong>Ø´Ø±ÙŠÙƒÙƒ:</strong> ' + accomplice.name + '</p>' +
                    '<p>âš”ï¸ <strong>Ø³Ù„Ø§Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©:</strong> ' + gameState.murderWeapon + '</p>' +
                    '<p>ğŸ” <strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> ' + gameState.murderEvidence + '</p>';
            } else if (player.role === 'accomplice') {
                var murderer = gameState.players.find(function(p) { return p.role === 'murderer'; });
                secretInfo.classList.remove('hidden');
                secretInfo.innerHTML = 
                    '<p>ğŸ”ª <strong>Ø§Ù„Ù‚Ø§ØªÙ„:</strong> ' + murderer.name + '</p>' +
                    '<p>âš”ï¸ <strong>Ø³Ù„Ø§Ø­ Ø§Ù„Ø¬Ø±ÙŠÙ…Ø©:</strong> ' + gameState.murderWeapon + '</p>' +
                    '<p>ğŸ” <strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> ' + gameState.murderEvidence + '</p>';
            } else if (player.role === 'witness') {
                var murderer = gameState.players.find(function(p) { return p.role === 'murderer'; });
                var accomplice = gameState.players.find(function(p) { return p.role === 'accomplice'; });
                secretInfo.classList.remove('hidden');
                secretInfo.innerHTML = 
                    '<p>ğŸ”ª <strong>Ø§Ù„Ù‚Ø§ØªÙ„:</strong> ' + murderer.name + '</p>' +
                    '<p>ğŸ¤ <strong>Ø§Ù„Ø´Ø±ÙŠÙƒ:</strong> ' + accomplice.name + '</p>' +
                    '<p style="color: #f39c12;">âš ï¸ Ù„Ø§ ØªØ¹Ø±Ù Ø§Ù„Ø³Ù„Ø§Ø­ ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„!</p>';
            }
        }

        function showMyItems(player) {
            var weaponsDiv = document.getElementById('myWeapons');
            var evidenceDiv = document.getElementById('myEvidence');

            weaponsDiv.innerHTML = '<strong>Ø§Ù„Ø£Ø³Ù„Ø­Ø©:</strong> ';
            player.weapons.forEach(function(w) {
                weaponsDiv.innerHTML += '<span>' + w + '</span>';
            });

            evidenceDiv.innerHTML = '<strong>Ø§Ù„Ø£Ø¯Ù„Ø©:</strong> ';
            player.evidence.forEach(function(e) {
                evidenceDiv.innerHTML += '<span>' + e + '</span>';
            });
        }

        // ==================== Forensic Panel ====================
        function showForensicPanel() {
            var panel = document.getElementById('forensicPanel');
            panel.classList.remove('hidden');

            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ
            var murderer = gameState.players.find(function(p) { return p.role === 'murderer'; });
            var accomplice = gameState.players.find(function(p) { return p.role === 'accomplice'; });
            var witness = gameState.players.find(function(p) { return p.role === 'witness'; });

            document.getElementById('forensicMurderer').textContent = murderer.name;
            document.getElementById('forensicAccomplice').textContent = accomplice.name;
            document.getElementById('forensicWitness').textContent = witness.name;
            document.getElementById('forensicWeapon').textContent = gameState.murderWeapon;
            document.getElementById('forensicEvidence').textContent = gameState.murderEvidence;

            renderForensicCards();
        }

        function toggleForensicPanel() {
            var panel = document.getElementById('forensicPanel');
            var btn = document.getElementById('panelToggleBtn');
            panel.classList.toggle('minimized');
            btn.textContent = panel.classList.contains('minimized') ? 'â–²' : 'â–¼';
        }

        function renderForensicCards() {
            var container = document.getElementById('forensicClueCards');
            container.innerHTML = '';

            gameState.forensicClueCards.forEach(function(card, cardIndex) {
                var isUsed = gameState.clues.some(function(c) { return c.cardIndex === cardIndex; });
                
                var cardDiv = document.createElement('div');
                cardDiv.className = 'forensic-clue-card';
                if (isUsed) cardDiv.style.opacity = '0.5';

                var html = '<h4>' + card.title + '</h4><div class="clue-options">';
                
                card.options.forEach(function(option) {
                    html += '<button class="clue-option-btn" onclick="selectClue(' + cardIndex + ', \'' + option + '\')" ' +
                        (isUsed ? 'disabled' : '') + '>' + option + '</button>';
                });

                html += '</div>';
                cardDiv.innerHTML = html;
                container.appendChild(cardDiv);
            });
        }

        function selectClue(cardIndex, option) {
            var card = gameState.forensicClueCards[cardIndex];
            
            gameState.clues.push({
                cardIndex: cardIndex,
                cardTitle: card.title,
                option: option
            });

            saveGameState();
            renderForensicCards();
        }

        function displayPublicClues() {
            var container = document.getElementById('publicCluesList');
            
            if (!gameState.clues || gameState.clues.length === 0) {
                container.innerHTML = '<p style="color: #aaa;">Ù„Ù… ÙŠØªÙ… ØªÙ‚Ø¯ÙŠÙ… Ø£Ø¯Ù„Ø© Ø¨Ø¹Ø¯...</p>';
                return;
            }

            container.innerHTML = '';
            gameState.clues.forEach(function(clue) {
                var div = document.createElement('div');
                div.className = 'clue-item';
                div.innerHTML = '<strong>' + clue.cardTitle + ':</strong> ' + clue.option;
                container.appendChild(div);
            });
        }

        // ==================== Voting System ====================
        function renderPlayersForVoting() {
            var container = document.getElementById('playersVotingList');
            container.innerHTML = '';

            gameState.players.forEach(function(player) {
                // Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØµÙˆÙŠØª
                if (player.role === 'forensic') return;
                // Ù„Ø§ ÙŠØ¸Ù‡Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù†ÙØ³Ù‡
                if (player.id === gameState.playerId) return;

                var existingVote = gameState.votes.find(function(v) {
                    return v.suspectName === player.name;
                });

                var card = document.createElement('div');
                card.className = 'player-card';
                card.id = 'playerCard_' + player.id;

                if (existingVote) {
                    card.classList.add('voted');
                }

                var html = '<div class="player-header">' +
                    '<span class="player-name">' + player.name + '</span>' +
                    '<button class="btn-secondary" style="width:auto;padding:5px 15px;" onclick="togglePlayerCard(\'' + player.id + '\')">Ø§Ø®ØªÙŠØ§Ø±</button>' +
                    '</div>';

                // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ù„Ø§Ø¹Ø¨
                html += '<div class="player-items">';
                html += '<div style="width:100%;margin-bottom:5px;"><strong>Ø§Ù„Ø£Ø³Ù„Ø­Ø©:</strong></div>';
                player.weapons.forEach(function(w) {
                    var selected = gameState.selectedVote[player.id] && gameState.selectedVote[player.id].weapon === w;
                    html += '<button class="item-btn weapon' + (selected ? ' selected' : '') + '" onclick="selectItem(\'' + player.id + '\', \'weapon\', \'' + w + '\')">' + w + '</button>';
                });

                html += '<div style="width:100%;margin:10px 0 5px;"><strong>Ø§Ù„Ø£Ø¯Ù„Ø©:</strong></div>';
                player.evidence.forEach(function(e) {
                    var selected = gameState.selectedVote[player.id] && gameState.selectedVote[player.id].evidence === e;
                    html += '<button class="item-btn evidence' + (selected ? ' selected' : '') + '" onclick="selectItem(\'' + player.id + '\', \'evidence\', \'' + e + '\')">' + e + '</button>';
                });

                html += '<button class="vote-btn" id="voteBtn_' + player.id + '" onclick="submitVote(\'' + player.id + '\', \'' + player.name + '\')">ğŸ—³ï¸ ØªØµÙˆÙŠØª</button>';
                html += '</div>';

                // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµÙˆÙŠØª Ø§Ù„Ø³Ø§Ø¨Ù‚
                if (existingVote) {
                    html += '<div class="vote-info">' +
                        '<strong>ØµÙˆÙ‘Øª Ø¹Ù„ÙŠÙ‡:</strong> ' + existingVote.voterName + '<br>' +
                        '<strong>Ø§Ù„Ø³Ù„Ø§Ø­:</strong> ' + existingVote.weapon + '<br>' +
                        '<strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> ' + existingVote.evidence +
                        '</div>';
                }

                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        function togglePlayerCard(playerId) {
            var card = document.getElementById('playerCard_' + playerId);
            if (card.classList.contains('voted')) return;
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
            document.querySelectorAll('.player-card').forEach(function(c) {
                if (c.id !== 'playerCard_' + playerId) {
                    c.classList.remove('expanded');
                }
            });
            
            card.classList.toggle('expanded');
        }

        function selectItem(playerId, type, value) {
            if (!gameState.selectedVote[playerId]) {
                gameState.selectedVote[playerId] = {};
            }
            gameState.selectedVote[playerId][type] = value;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            var card = document.getElementById('playerCard_' + playerId);
            card.querySelectorAll('.item-btn.' + type).forEach(function(btn) {
                btn.classList.remove('selected');
                if (btn.textContent === value) {
                    btn.classList.add('selected');
                }
            });

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
            var vote = gameState.selectedVote[playerId];
            if (vote.weapon && vote.evidence) {
                card.classList.add('ready-to-vote');
            } else {
                card.classList.remove('ready-to-vote');
            }
        }

        function submitVote(playerId, playerName) {
            if (gameState.hasVoted) {
                alert('Ù„Ù‚Ø¯ ØµÙˆÙ‘Øª Ø¨Ø§Ù„ÙØ¹Ù„!');
                return;
            }

            var vote = gameState.selectedVote[playerId];
            if (!vote || !vote.weapon || !vote.evidence) {
                alert('Ø§Ø®ØªØ± Ø§Ù„Ø³Ù„Ø§Ø­ ÙˆØ§Ù„Ø¯Ù„ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }

            var isCorrect = 
                playerName === gameState.murdererName &&
                vote.weapon === gameState.murderWeapon &&
                vote.evidence === gameState.murderEvidence;

            var voteData = {
                oderId: gameState.playerId,
                voterName: gameState.playerName,
                suspectId: playerId,
                suspectName: playerName,
                weapon: vote.weapon,
                evidence: vote.evidence,
                isCorrect: isCorrect
            };

            if (!gameState.votes) gameState.votes = [];
            gameState.votes.push(voteData);
            gameState.hasVoted = true;

            if (isCorrect) {
                gameState.gamePhase = 'witness_guess';
                gameState.correctVoterName = gameState.playerName;
            }

            saveGameState();
            renderPlayersForVoting();
        }

        // ==================== Game Results ====================
        function showCorrectAnswer(voterName) {
            var resultsDiv = document.getElementById('gameResults');
            resultsDiv.classList.remove('hidden');
            resultsDiv.className = 'results-screen';
            resultsDiv.style.background = 'rgba(0,0,0,0.8)';
            resultsDiv.style.borderRadius = '20px';
            resultsDiv.style.padding = '30px';
            resultsDiv.style.marginTop = '20px';

            var html = '<div class="result-icon">ğŸ¯</div>' +
                '<div class="result-title">ØªÙ… ÙƒØ´Ù Ø§Ù„Ù‚Ø§ØªÙ„!</div>' +
                '<p><strong>' + voterName + '</strong> Ø§ÙƒØªØ´Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©!</p>' +
                '<div class="secret-info" style="text-align:right;margin-top:20px;">' +
                '<p>ğŸ”ª <strong>Ø§Ù„Ù‚Ø§ØªÙ„:</strong> ' + gameState.murdererName + '</p>' +
                '<p>âš”ï¸ <strong>Ø§Ù„Ø³Ù„Ø§Ø­:</strong> ' + gameState.murderWeapon + '</p>' +
                '<p>ğŸ” <strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> ' + gameState.murderEvidence + '</p>' +
                '</div>';

            if (gameState.role === 'murderer') {
                html += '<div class="alert alert-danger" style="margin-top:20px;">' +
                    '<h3>âš ï¸ ØªÙ… Ø§ØµØ·ÙŠØ§Ø¯Ùƒ!</h3>' +
                    '<p>Ù„Ø¯ÙŠÙƒ ÙØ±ØµØ© Ø£Ø®ÙŠØ±Ø©... Ø­Ø¯Ø¯ Ø§Ù„Ø´Ø§Ù‡Ø¯ Ù„Ù„ÙÙˆØ²!</p>' +
                    '</div>' +
                    '<div style="margin-top:20px;">' +
                    '<label><strong>Ù…Ù† Ù‡Ùˆ Ø§Ù„Ø´Ø§Ù‡Ø¯ØŸ</strong></label>' +
                    '<select id="witnessGuess" style="margin:10px 0;">';
                
                gameState.players.forEach(function(p) {
                    if (p.role !== 'murderer' && p.role !== 'accomplice' && p.role !== 'forensic') {
                        html += '<option value="' + p.name + '">' + p.name + '</option>';
                    }
                });

                html += '</select>' +
                    '<button onclick="guessWitness()" class="btn-danger">ØªØ£ÙƒÙŠØ¯</button>' +
                    '</div>';
            } else {
                html += '<div class="alert alert-info" style="margin-top:20px;">' +
                    '<p>â³ Ø§Ù†ØªØ¸Ø±... Ø§Ù„Ù‚Ø§ØªÙ„ ÙŠØ­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ø§Ù‡Ø¯</p>' +
                    '</div>';
            }

            resultsDiv.innerHTML = html;
        }

        function guessWitness() {
            var guess = document.getElementById('witnessGuess').value;
            
            if (guess === gameState.witnessName) {
                gameState.gamePhase = 'murderer_wins';
            } else {
                gameState.gamePhase = 'investigators_win';
            }

            gameState.witnessGuess = guess;
            saveGameState();
        }

        function showFinalResult() {
            var resultsDiv = document.getElementById('gameResults');
            resultsDiv.classList.remove('hidden');

            var isWin = gameState.gamePhase === 'investigators_win';
            
            if (gameState.role === 'murderer' || gameState.role === 'accomplice') {
                isWin = gameState.gamePhase === 'murderer_wins';
            }

            resultsDiv.className = 'results-screen ' + (isWin ? 'win' : 'lose');
            resultsDiv.style.borderRadius = '20px';
            resultsDiv.style.padding = '30px';
            resultsDiv.style.marginTop = '20px';

            var title = gameState.gamePhase === 'murderer_wins' ? 
                'ğŸ”ª Ø§Ù„Ù‚Ø§ØªÙ„ ÙˆØ§Ù„Ø´Ø±ÙŠÙƒ ÙŠÙÙˆØ²Ø§Ù†!' : 'ğŸ‰ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙˆÙ† ÙŠÙÙˆØ²ÙˆÙ†!';

            var html = '<div class="result-icon">' + (gameState.gamePhase === 'murderer_wins' ? 'ğŸ”ª' : 'ğŸ‰') + '</div>' +
                '<div class="result-title">' + title + '</div>' +
                '<div class="secret-info" style="text-align:right;margin-top:20px;background:rgba(0,0,0,0.3);">' +
                '<p>ğŸ”ª <strong>Ø§Ù„Ù‚Ø§ØªÙ„:</strong> ' + gameState.murdererName + '</p>' +
                '<p>ğŸ¤ <strong>Ø§Ù„Ø´Ø±ÙŠÙƒ:</strong> ' + gameState.accompliceName + '</p>' +
                '<p>ğŸ‘ï¸ <strong>Ø§Ù„Ø´Ø§Ù‡Ø¯:</strong> ' + gameState.witnessName + '</p>' +
                '<p>âš”ï¸ <strong>Ø§Ù„Ø³Ù„Ø§Ø­:</strong> ' + gameState.murderWeapon + '</p>' +
                '<p>ğŸ” <strong>Ø§Ù„Ø¯Ù„ÙŠÙ„:</strong> ' + gameState.murderEvidence + '</p>';

            if (gameState.witnessGuess) {
                html += '<p>ğŸ¯ <strong>ØªØ®Ù…ÙŠÙ† Ø§Ù„Ù‚Ø§ØªÙ„ Ù„Ù„Ø´Ø§Ù‡Ø¯:</strong> ' + gameState.witnessGuess + 
                    (gameState.witnessGuess === gameState.witnessName ? ' âœ…' : ' âŒ') + '</p>';
            }

            html += '</div>' +
                '<button onclick="location.reload()" style="margin-top:20px;">Ù„Ø¹Ø¨Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>';

            resultsDiv.innerHTML = html;
        }

        // ==================== Firebase Functions ====================
        function saveGameState() {
            return firebase.database().ref('rooms/' + gameState.roomCode).set(gameState);
        }

        function loadGameState() {
            return firebase.database().ref('rooms/' + gameState.roomCode).once('value')
                .then(function(snapshot) {
                    return snapshot.val();
                });
        }

        var roomListener = null;

        function listenToRoom() {
            if (roomListener) roomListener.off();

            roomListener = firebase.database().ref('rooms/' + gameState.roomCode);
            
            roomListener.on('value', function(snapshot) {
                if (!snapshot.exists()) return;

                var data = snapshot.val();

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
                if (data.players) {
                    gameState.players = data.players;
                    
                    if (!gameState.gameStarted) {
                        gameState.maxPlayers = data.maxPlayers;
                        updateLobby();
                    }
                }

                // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
                if (!gameState.gameStarted && data.gameStarted) {
                    gameState.gameStarted = true;
                    gameState.murderWeapon = data.murderWeapon;
                    gameState.murderEvidence = data.murderEvidence;
                    gameState.murdererName = data.murdererName;
                    gameState.accompliceName = data.accompliceName;
                    gameState.witnessName = data.witnessName;
                    gameState.forensicClueCards = data.forensicClueCards || [];
                    gameState.clues = data.clues || [];
                    gameState.votes = data.votes || [];
                    
                    showGame();
                }

                // ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø©
                if (gameState.gameStarted) {
                    if (data.clues) {
                        gameState.clues = data.clues;
                        displayPublicClues();
                        if (gameState.role === 'forensic') {
                            renderForensicCards();
                        }
                    }

                    if (data.votes) {
                        gameState.votes = data.votes;
                        renderPlayersForVoting();
                    }

                    // Ù…Ø±Ø§Ø­Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©
                    if (data.gamePhase && data.gamePhase !== gameState.gamePhase) {
                        gameState.gamePhase = data.gamePhase;

                        if (data.gamePhase === 'witness_guess') {
                            showCorrectAnswer(data.correctVoterName || 'Ø£Ø­Ø¯ Ø§Ù„Ù…Ø­Ù‚Ù‚ÙŠÙ†');
                        } else if (data.gamePhase === 'murderer_wins' || data.gamePhase === 'investigators_win') {
                            gameState.witnessGuess = data.witnessGuess;
                            showFinalResult();
                        }
                    }
                }
            });
        }

        // ==================== Init ====================
        window.onload = function() {
            if (loadSession()) {
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø¨Ø©
                loadGameState().then(function(data) {
                    if (data) {
                        gameState.players = data.players || [];
                        gameState.maxPlayers = data.maxPlayers;
                        gameState.gameStarted = data.gameStarted;
                        gameState.murderWeapon = data.murderWeapon;
                        gameState.murderEvidence = data.murderEvidence;
                        gameState.murdererName = data.murdererName;
                        gameState.accompliceName = data.accompliceName;
                        gameState.witnessName = data.witnessName;
                        gameState.forensicClueCards = data.forensicClueCards || [];
                        gameState.clues = data.clues || [];
                        gameState.votes = data.votes || [];
                        gameState.gamePhase = data.gamePhase || 'playing';

                        if (data.gameStarted) {
                            showGame();
                            
                            if (data.gamePhase === 'witness_guess') {
                                showCorrectAnswer(data.correctVoterName);
                            } else if (data.gamePhase === 'murderer_wins' || data.gamePhase === 'investigators_win') {
                                gameState.witnessGuess = data.witnessGuess;
                                showFinalResult();
                            }
                        } else {
                            showScreen('lobbyScreen');
                            updateLobby();
                            if (gameState.isHost) {
                                document.getElementById('hostControls').classList.remove('hidden');
                            }
                        }
                        
                        listenToRoom();
                    }
                });
            }
        };
    </script>
</body>
</html>
