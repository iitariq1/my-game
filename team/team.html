<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒÙ†Ø¨Ø©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1A1E2E;
            --bg-card: #232840;
            --bg-card-alt: #2A3050;
            --border: #3A4065;
            --gold: #E8B830;
            --gold-dim: #A07D1C;
            --gold-glow: rgba(232, 184, 48, 0.15);
            --red: #E8443A;
            --red-bg: rgba(232, 68, 58, 0.12);
            --blue: #3A8BE8;
            --blue-bg: rgba(58, 139, 232, 0.12);
            --green: #2ECC71;
            --green-bg: rgba(46, 204, 113, 0.12);
            --text: #F0EDE6;
            --text-dim: #7A7E8C;
            --orange: #F39C12;
            --orange-bg: rgba(243, 156, 18, 0.12);
            --radius: 12px;
            --radius-sm: 8px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Tajawal', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100dvh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 12px;
            overflow-x: hidden;
        }

        .app {
            width: 100%;
            max-width: 460px;
            min-height: calc(100dvh - 24px);
            display: flex;
            flex-direction: column;
        }

        /* â•â•â• SCREENS â•â•â• */
        .screen { display: none; flex-direction: column; flex: 1; }
        .screen.active { display: flex; }

        /* â•â•â• HEADER â•â•â• */
        .header {
            text-align: center;
            padding: 16px 0 12px;
            position: relative;
        }
        .header h1 {
            font-size: 1.6em;
            font-weight: 900;
            color: var(--gold);
            letter-spacing: 1px;
        }
        .header .sub {
            font-size: 0.8em;
            color: var(--text-dim);
            margin-top: 2px;
        }

        /* â•â•â• CARD â•â•â• */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 10px;
        }

        .card-title {
            font-size: 0.8em;
            font-weight: 700;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        /* â•â•â• INPUTS â•â•â• */
        .field { margin-bottom: 12px; }
        .field label {
            display: block;
            font-size: 0.85em;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 5px;
        }
        .field input, .field select {
            width: 100%;
            padding: 11px 14px;
            background: var(--bg-card-alt);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-family: inherit;
            font-size: 0.95em;
            font-weight: 500;
            outline: none;
            transition: border 0.2s;
        }
        .field input:focus, .field select:focus {
            border-color: var(--gold);
        }
        .field input::placeholder { color: var(--text-dim); }
        .field select option { background: var(--bg-card); }

        /* â•â•â• BUTTONS â•â•â• */
        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 1em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 6px;
        }
        .btn:active { transform: scale(0.97); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        .btn-gold {
            background: var(--gold);
            color: var(--bg-dark);
        }
        .btn-gold:hover:not(:disabled) { background: #F0C540; }

        .btn-outline {
            background: transparent;
            border: 1.5px solid var(--border);
            color: var(--text-dim);
        }
        .btn-outline:hover:not(:disabled) { border-color: var(--text-dim); color: var(--text); }

        .btn-green {
            background: var(--green);
            color: #fff;
        }
        .btn-red {
            background: var(--red);
            color: #fff;
        }
        .btn-blue {
            background: var(--blue);
            color: #fff;
        }

        /* â•â•â• ROOM CODE â•â•â• */
        .room-code-display {
            text-align: center;
            padding: 14px;
            background: var(--gold-glow);
            border: 1.5px solid var(--gold-dim);
            border-radius: var(--radius);
            margin-bottom: 12px;
        }
        .room-code-display .label { font-size: 0.8em; color: var(--gold-dim); font-weight: 700; }
        .room-code-display .code {
            font-size: 2.4em;
            font-weight: 900;
            color: var(--gold);
            letter-spacing: 10px;
            font-variant-numeric: tabular-nums;
        }

        /* â•â•â• PLAYER LIST â•â•â• */
        .player-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            background: var(--bg-card-alt);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.82em;
            font-weight: 600;
            margin: 3px;
        }
        .player-chip .dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        .dot-red { background: var(--red); }
        .dot-blue { background: var(--blue); }
        .dot-gold { background: var(--gold); }

        /* â•â•â• TEAM SELECT BUTTONS â•â•â• */
        .team-select-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 8px 0;
        }
        .team-select-btn {
            padding: 14px 8px;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 0.95em;
            font-weight: 700;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
            text-align: center;
        }
        .team-select-btn.red-team {
            background: var(--red-bg);
            color: var(--red);
            border-color: rgba(232,68,58,0.3);
        }
        .team-select-btn.blue-team {
            background: var(--blue-bg);
            color: var(--blue);
            border-color: rgba(58,139,232,0.3);
        }
        .team-select-btn.selected {
            border-color: var(--gold) !important;
            box-shadow: 0 0 12px var(--gold-glow);
        }
        .team-select-btn:active { transform: scale(0.96); }

        /* â•â•â• GAME SCREEN â•â•â• */
        .game-top-bar {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
        }
        .team-score-box {
            padding: 8px;
            border-radius: var(--radius-sm);
            text-align: center;
        }
        .team-score-box.red { background: var(--red-bg); border: 1px solid rgba(232,68,58,0.25); }
        .team-score-box.blue { background: var(--blue-bg); border: 1px solid rgba(58,139,232,0.25); }
        .team-score-box .t-name {
            font-size: 0.7em;
            font-weight: 700;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .team-score-box.red .t-name { color: var(--red); }
        .team-score-box.blue .t-name { color: var(--blue); }
        .team-score-box .t-score {
            font-size: 1.5em;
            font-weight: 900;
            line-height: 1;
        }
        .team-score-box.red .t-score { color: var(--red); }
        .team-score-box.blue .t-score { color: var(--blue); }
        .vs-badge {
            font-size: 0.75em;
            font-weight: 900;
            color: var(--text-dim);
            padding: 4px 8px;
            border-radius: 20px;
            border: 1px solid var(--border);
            background: var(--bg-card);
        }

        /* â•â•â• COUCH â•â•â• */
        .couch-section {
            background: var(--gold-glow);
            border: 1.5px solid var(--gold-dim);
            border-radius: var(--radius);
            padding: 10px;
            margin-bottom: 8px;
        }
        .couch-label {
            text-align: center;
            font-size: 0.75em;
            font-weight: 800;
            color: var(--gold);
            letter-spacing: 2px;
            margin-bottom: 6px;
        }
        .couch-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .couch-col { text-align: center; }
        .couch-col .col-label {
            font-size: 0.7em;
            font-weight: 700;
            margin-bottom: 4px;
            opacity: 0.7;
        }
        .couch-col.red .col-label { color: var(--red); }
        .couch-col.blue .col-label { color: var(--blue); }
        .couch-seat {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75em;
            font-weight: 700;
            margin: 2px;
            background: var(--gold);
            color: var(--bg-dark);
        }
        .couch-empty-text {
            font-size: 0.7em;
            color: var(--text-dim);
            font-style: italic;
        }
        .seat-slot {
            width: 28px; height: 28px;
            border-radius: 50%;
            border: 1.5px dashed var(--text-dim);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 2px;
            font-size: 0.65em;
            opacity: 0.4;
        }

        /* â•â•â• QUESTION AREA â•â•â• */
        .question-card {
            background: var(--bg-card);
            border: 1.5px solid var(--border);
            border-radius: var(--radius);
            padding: 14px;
            margin-bottom: 8px;
            text-align: center;
            position: relative;
        }
        .q-category {
            font-size: 0.7em;
            font-weight: 700;
            color: var(--gold-dim);
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        .q-text {
            font-size: 1.05em;
            font-weight: 700;
            line-height: 1.5;
            color: var(--text);
        }

        /* â•â•â• TIMER â•â•â• */
        .timer-bar {
            text-align: center;
            margin-bottom: 8px;
        }
        .timer-circle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 56px; height: 56px;
            border-radius: 50%;
            border: 3px solid var(--gold);
            font-size: 1.5em;
            font-weight: 900;
            color: var(--gold);
            transition: all 0.3s;
        }
        .timer-circle.danger {
            border-color: var(--red);
            color: var(--red);
            animation: timer-pulse 0.5s infinite;
        }
        .timer-circle.small {
            width: 44px; height: 44px;
            font-size: 1.2em;
            border-color: var(--orange);
            color: var(--orange);
        }
        .timer-circle.small.danger {
            border-color: var(--red);
            color: var(--red);
        }
        @keyframes timer-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        /* â•â•â• BUZZER â•â•â• */
        .buzzer-btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: var(--radius);
            font-family: inherit;
            font-size: 1.2em;
            font-weight: 800;
            cursor: pointer;
            background: linear-gradient(135deg, var(--orange) 0%, #E67E22 100%);
            color: #fff;
            box-shadow: 0 4px 20px rgba(243,156,18,0.3);
            transition: all 0.15s;
            margin-bottom: 8px;
            position: relative;
            overflow: hidden;
        }
        .buzzer-btn:active:not(:disabled) { transform: scale(0.96); }
        .buzzer-btn:disabled {
            background: var(--bg-card-alt);
            color: var(--text-dim);
            box-shadow: none;
            cursor: not-allowed;
        }

        /* â•â•â• STATUS â•â•â• */
        .status-bar {
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 0.85em;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
        }
        .status-bar.info { background: var(--blue-bg); color: var(--blue); border: 1px solid rgba(58,139,232,0.2); }
        .status-bar.success { background: var(--green-bg); color: var(--green); border: 1px solid rgba(46,204,113,0.2); }
        .status-bar.error { background: var(--red-bg); color: var(--red); border: 1px solid rgba(232,68,58,0.2); }
        .status-bar.warning { background: var(--orange-bg); color: var(--orange); border: 1px solid rgba(243,156,18,0.2); }

        /* â•â•â• OPTIONS GRID â•â•â• */
        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }
        .option-btn {
            padding: 12px 8px;
            background: var(--bg-card-alt);
            border: 1.5px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.88em;
            font-weight: 700;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .option-btn:hover:not(:disabled) {
            border-color: var(--gold);
            background: var(--gold-glow);
        }
        .option-btn:active:not(:disabled) { transform: scale(0.96); }
        .option-btn:disabled {
            opacity: 0.35;
            cursor: not-allowed;
        }
        .option-btn.correct { border-color: var(--green); background: var(--green-bg); color: var(--green); }
        .option-btn.wrong { border-color: var(--red); background: var(--red-bg); color: var(--red); }

        /* â•â•â• ANSWER INPUT â•â•â• */
        .answer-input-area {
            margin-bottom: 8px;
        }
        .answer-input-area input {
            width: 100%;
            padding: 12px;
            background: var(--bg-card-alt);
            border: 2px solid var(--gold);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-family: inherit;
            font-size: 1em;
            font-weight: 700;
            text-align: center;
            outline: none;
            margin-bottom: 6px;
        }
        .answer-input-area input::placeholder { color: var(--text-dim); }

        /* â•â•â• CHOICE BUTTONS â•â•â• */
        .choice-grid {
            display: grid;
            gap: 8px;
            margin-bottom: 8px;
        }
        .choice-btn {
            padding: 14px;
            border: none;
            border-radius: var(--radius-sm);
            font-family: inherit;
            font-size: 0.95em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }
        .choice-btn:active { transform: scale(0.97); }
        .choice-btn.sit { background: var(--green); color: #fff; }
        .choice-btn.pull { background: var(--red); color: #fff; }

        /* â•â•â• ON COUCH MESSAGE â•â•â• */
        .on-couch-banner {
            text-align: center;
            padding: 30px 16px;
            background: var(--green-bg);
            border: 1.5px solid rgba(46,204,113,0.3);
            border-radius: var(--radius);
            margin-bottom: 8px;
        }
        .on-couch-banner .icon { font-size: 2.5em; margin-bottom: 8px; }
        .on-couch-banner h3 { color: var(--green); font-size: 1.2em; }
        .on-couch-banner p { color: var(--text-dim); font-size: 0.85em; margin-top: 4px; }

        /* â•â•â• VICTORY â•â•â• */
        .victory-overlay {
            display: none;
            text-align: center;
            padding: 40px 16px;
            flex: 1;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .victory-overlay.active { display: flex; }
        .victory-overlay .trophy { font-size: 4em; margin-bottom: 12px; animation: bounce-trophy 1.5s infinite; }
        @keyframes bounce-trophy {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-12px) rotate(-5deg); }
            75% { transform: translateY(-12px) rotate(5deg); }
        }
        .victory-overlay h2 {
            font-size: 1.8em;
            font-weight: 900;
            color: var(--gold);
            margin-bottom: 20px;
        }

        /* â•â•â• HOST BADGE â•â•â• */
        .host-next-btn {
            margin-top: auto;
            padding-top: 10px;
            padding-bottom: 10px;
        }

        /* â•â•â• MISC â•â•â• */
        .spacer { flex: 1; }
        .text-center { text-align: center; }
        .mt-8 { margin-top: 8px; }
        .mb-8 { margin-bottom: 8px; }
        .mb-12 { margin-bottom: 12px; }
        .hidden { display: none !important; }

        .buzzer-indicator-bar {
            padding: 6px 12px;
            border-radius: var(--radius-sm);
            background: var(--orange-bg);
            border: 1px solid rgba(243,156,18,0.2);
            text-align: center;
            font-size: 0.82em;
            font-weight: 700;
            color: var(--orange);
            margin-bottom: 8px;
        }

        .players-in-team {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            justify-content: center;
            margin-top: 4px;
        }
        .mini-player {
            font-size: 0.65em;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: 600;
            background: rgba(255,255,255,0.06);
            color: var(--text-dim);
        }
        .mini-player.on-couch {
            opacity: 0.35;
            text-decoration: line-through;
        }
    </style>
</head>
<body>
<div class="app" id="app">

    <!-- â•â•â•â•â•â• WELCOME â•â•â•â•â•â• -->
    <div class="screen active" id="welcomeScreen">
        <div style="flex:1;display:flex;flex-direction:column;justify-content:center;">
            <div class="header">
                <h1>ğŸ›‹ï¸ Ù„Ø¹Ø¨Ø© Ø§Ù„ÙƒÙ†Ø¨Ø©</h1>
                <div class="sub">Ù…Ù† ÙŠØ¬Ù„Ø³ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ†Ø¨Ø© Ø£ÙˆÙ„Ø§Ù‹ ÙŠÙÙˆØ²!</div>
            </div>
            <div style="padding:0 10px;">
                <button class="btn btn-gold" onclick="showScreen('createRoomScreen')">Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©</button>
                <button class="btn btn-outline mt-8" onclick="showScreen('joinRoomScreen')">Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</button>
                <button class="btn btn-outline mt-8" onclick="goToMainPage()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â• CREATE ROOM â•â•â•â•â•â• -->
    <div class="screen" id="createRoomScreen">
        <div class="header">
            <h1>Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</h1>
        </div>
        <div class="card">
            <div class="field">
                <label>Ø§Ø³Ù…Ùƒ</label>
                <input type="text" id="hostName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
            </div>
            <div class="field">
                <label>Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„</label>
                <input type="text" id="team1NameInput" placeholder="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±" value="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±">
            </div>
            <div class="field">
                <label>Ø§Ø³Ù… Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
                <input type="text" id="team2NameInput" placeholder="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚" value="Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚">
            </div>
            <div class="field">
                <label>Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙÙŠ ÙƒÙ„ ÙØ±ÙŠÙ‚</label>
                <select id="teamSizeInput">
                    <option value="2">2 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="3">3 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="4">4 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                    <option value="5">5 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                </select>
            </div>
            <button class="btn btn-gold" onclick="createRoom()">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØºØ±ÙØ©</button>
            <button class="btn btn-outline mt-8" onclick="showScreen('welcomeScreen')">Ø±Ø¬ÙˆØ¹</button>
        </div>
    </div>

    <!-- â•â•â•â•â•â• JOIN ROOM â•â•â•â•â•â• -->
    <div class="screen" id="joinRoomScreen">
        <div class="header">
            <h1>Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ©</h1>
        </div>
        <div class="card">
            <div class="field">
                <label>Ø§Ø³Ù…Ùƒ</label>
                <input type="text" id="playerName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
            </div>
            <div class="field">
                <label>ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©</label>
                <input type="text" id="roomCodeInput" placeholder="0000" maxlength="4" inputmode="numeric" pattern="[0-9]*">
            </div>
            <button class="btn btn-gold" onclick="joinRoom()">Ø§Ù†Ø¶Ù…</button>
            <button class="btn btn-outline mt-8" onclick="showScreen('welcomeScreen')">Ø±Ø¬ÙˆØ¹</button>
        </div>
    </div>

    <!-- â•â•â•â•â•â• TEAM SELECTION (for joining players) â•â•â•â•â•â• -->
    <div class="screen" id="teamSelectionScreen">
        <div class="header">
            <h1>Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</h1>
            <div class="sub">Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="welcomePlayerName"></span></div>
        </div>
        <div class="card">
            <div class="team-select-grid" id="teamSelectBtns"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â• LOBBY â•â•â•â•â•â• -->
    <div class="screen" id="lobbyScreen">
        <div class="header">
            <h1>ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h1>
        </div>
        <div class="room-code-display">
            <div class="label">ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ©</div>
            <div class="code" id="displayRoomCode">0000</div>
        </div>
        <div class="card">
            <div class="card-title">Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ</div>
            <div class="team-select-grid" id="hostTeamBtns"></div>
        </div>
        <div class="card">
            <div class="card-title">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† (<span id="playerCount">0</span>)</div>
            <div id="lobbyPlayersList" style="display:flex;flex-wrap:wrap;gap:4px;"></div>
        </div>
        <div class="spacer"></div>
        <button class="btn btn-gold" onclick="startGame()" id="startGameBtn" disabled>Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
    </div>

    <!-- â•â•â•â•â•â• WAITING â•â•â•â•â•â• -->
    <div class="screen" id="waitingScreen">
        <div class="header">
            <h1>ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡</h1>
            <div class="sub">Ø£Ù†Øª ÙÙŠ <span id="waitingTeamName" style="color:var(--gold);font-weight:700;"></span></div>
        </div>
        <div class="card">
            <div class="card-title">Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ†</div>
            <div id="waitingPlayersList" style="display:flex;flex-wrap:wrap;gap:4px;"></div>
        </div>
    </div>

    <!-- â•â•â•â•â•â• GAME SCREEN (UNIFIED for host & players) â•â•â•â•â•â• -->
    <div class="screen" id="gameScreen">
        <!-- Top bar: teams scores -->
        <div class="game-top-bar" id="gameTopBar">
            <div class="team-score-box red">
                <div class="t-name" id="gTeam1Name">Ø§Ù„ÙØ±ÙŠÙ‚ Ù¡</div>
                <div class="t-score" id="gTeam1Score">0</div>
                <div class="players-in-team" id="gTeam1Players"></div>
            </div>
            <div class="vs-badge">VS</div>
            <div class="team-score-box blue">
                <div class="t-name" id="gTeam2Name">Ø§Ù„ÙØ±ÙŠÙ‚ Ù¢</div>
                <div class="t-score" id="gTeam2Score">0</div>
                <div class="players-in-team" id="gTeam2Players"></div>
            </div>
        </div>

        <!-- Couch -->
        <div class="couch-section" id="couchSection">
            <div class="couch-label">ğŸ›‹ï¸ ÙƒÙ†Ø¨Ø© Ø§Ù„ÙÙˆØ²</div>
            <div class="couch-grid">
                <div class="couch-col red">
                    <div class="col-label" id="couchTeam1Label">Ø§Ù„ÙØ±ÙŠÙ‚ Ù¡</div>
                    <div id="couchTeam1Seats"></div>
                </div>
                <div class="couch-col blue">
                    <div class="col-label" id="couchTeam2Label">Ø§Ù„ÙØ±ÙŠÙ‚ Ù¢</div>
                    <div id="couchTeam2Seats"></div>
                </div>
            </div>
        </div>

        <!-- On couch message -->
        <div class="on-couch-banner hidden" id="onCouchBanner">
            <div class="icon">ğŸ†</div>
            <h3>Ø£Ù†Øª Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ†Ø¨Ø©!</h3>
            <p>Ø§Ø³ØªØ±Ø®Ù ÙˆØ§Ù†ØªØ¸Ø± Ø§Ù„ÙÙˆØ²</p>
        </div>

        <!-- Game content area -->
        <div id="gameContent">
            <!-- Question -->
            <div class="question-card hidden" id="questionCard">
                <div class="q-category" id="qCategory"></div>
                <div class="q-text" id="qText"></div>
            </div>

            <!-- Main Timer (30s) -->
            <div class="timer-bar hidden" id="mainTimerBar">
                <div class="timer-circle" id="mainTimerCircle">30</div>
            </div>

            <!-- Buzzer indicator -->
            <div class="buzzer-indicator-bar hidden" id="buzzerIndicator"></div>

            <!-- Status -->
            <div class="status-bar info" id="gameStatus">Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø³Ø¤Ø§Ù„...</div>

            <!-- Buzzer button -->
            <button class="buzzer-btn hidden" id="buzzerBtn" onclick="buzzIn()" disabled>ğŸ”” Ø§Ø¶ØºØ· Ø§Ù„Ø¬Ø±Ø³!</button>

            <!-- Answer input (5s text) -->
            <div class="answer-input-area hidden" id="answerInputArea">
                <div class="timer-bar">
                    <div class="timer-circle small" id="answerTimerCircle">5</div>
                </div>
                <input type="text" id="textAnswerInput" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ..." autocomplete="off">
                <button class="btn btn-green" onclick="submitTextAnswer()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
            </div>

            <!-- Options -->
            <div class="options-grid hidden" id="optionsGrid"></div>

            <!-- Choice buttons (sit/pull) -->
            <div class="choice-grid hidden" id="choiceGrid"></div>
        </div>

        <!-- Victory overlay -->
        <div class="victory-overlay" id="victoryOverlay">
            <div class="trophy">ğŸ†</div>
            <h2 id="victoryMsg">Ø§Ù„ÙØ±ÙŠÙ‚ ÙØ§Ø²!</h2>
            <button class="btn btn-gold" onclick="replayGame()">Ù„Ø¹Ø¨ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰</button>
            <button class="btn btn-outline mt-8" onclick="goToMainPage()">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨</button>
        </div>

        <!-- Host: Next question (always at bottom) -->
        <div class="spacer"></div>
        <div class="host-next-btn hidden" id="hostNextBtn">
            <button class="btn btn-gold" onclick="nextQuestion()" id="nextQBtn">Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ â–¶ï¸</button>
        </div>
    </div>

</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script>
// â•â•â•â•â•â• FIREBASE INIT â•â•â•â•â•â•
const firebaseConfig = {
    apiKey: "AIzaSyBUXlgxP463b18dg9_Og_8EcMDLfLIr76o",
    authDomain: "team-cc63c.firebaseapp.com",
    databaseURL: "https://team-cc63c-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "team-cc63c",
    storageBucket: "team-cc63c.firebasestorage.app",
    messagingSenderId: "511582595742",
    appId: "1:511582595742:web:3e21273dcf49bf26d7298f",
    measurementId: "G-PSDJ9N34PH"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// â•â•â•â•â•â• QUESTIONS â•â•â•â•â•â•
const questions = [
    {category: "Ø¯ÙŠÙ†ÙŠØ©", question: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø³ÙˆØ± Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ", options: ["114 Ø³ÙˆØ±Ø©", "110 Ø³ÙˆØ±Ø©", "120 Ø³ÙˆØ±Ø©", "100 Ø³ÙˆØ±Ø©"], correct: 0},
    {category: "Ø¯ÙŠÙ†ÙŠØ©", question: "Ù…Ø§ Ù‡ÙŠ Ø£Ø·ÙˆÙ„ Ø³ÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…ØŸ", options: ["Ø³ÙˆØ±Ø© Ø§Ù„Ø¨Ù‚Ø±Ø©", "Ø³ÙˆØ±Ø© Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†", "Ø³ÙˆØ±Ø© Ø§Ù„Ù†Ø³Ø§Ø¡", "Ø³ÙˆØ±Ø© Ø§Ù„Ø£Ø¹Ø±Ø§Ù"], correct: 0},
    {category: "Ø¯ÙŠÙ†ÙŠØ©", question: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŸ", options: ["5 Ø£Ø±ÙƒØ§Ù†", "4 Ø£Ø±ÙƒØ§Ù†", "6 Ø£Ø±ÙƒØ§Ù†", "7 Ø£Ø±ÙƒØ§Ù†"], correct: 0},
    {category: "Ø¯ÙŠÙ†ÙŠØ©", question: "Ù…Ù† Ù‡Ùˆ Ø®Ø§ØªÙ… Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡ØŸ", options: ["Ù…Ø­Ù…Ø¯ ï·º", "Ø¹ÙŠØ³Ù‰ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…", "Ù…ÙˆØ³Ù‰ Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ… Ø¹Ù„ÙŠÙ‡ Ø§Ù„Ø³Ù„Ø§Ù…"], correct: 0},
    {category: "Ø¯ÙŠÙ†ÙŠØ©", question: "ÙÙŠ Ø£ÙŠ Ø´Ù‡Ø± ÙØ±Ø¶ Ø§Ù„ØµÙŠØ§Ù…ØŸ", options: ["Ø±Ù…Ø¶Ø§Ù†", "Ø´Ø¹Ø¨Ø§Ù†", "Ø±Ø¬Ø¨", "Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©"], correct: 0},
    {category: "Ø«Ù‚Ø§ÙÙŠØ©", question: "Ù…Ù† Ù‡Ùˆ Ù…Ø¤Ù„Ù Ø±ÙˆØ§ÙŠØ© 'Ù…Ø¦Ø© Ø¹Ø§Ù… Ù…Ù† Ø§Ù„Ø¹Ø²Ù„Ø©'ØŸ", options: ["ØºØ§Ø¨Ø±ÙŠÙŠÙ„ ØºØ§Ø±Ø³ÙŠØ§ Ù…Ø§Ø±ÙƒÙŠØ²", "Ø¨Ø§Ø¨Ù„Ùˆ Ù†ÙŠØ±ÙˆØ¯Ø§", "Ø®ÙˆØ±Ø®ÙŠ Ù„ÙˆÙŠØ³ Ø¨ÙˆØ±Ø®ÙŠØ³", "Ø¥ÙŠØ²Ø§Ø¨ÙŠÙ„ Ø§Ù„Ù„ÙŠÙ†Ø¯ÙŠ"], correct: 0},
    {category: "Ø¬ØºØ±Ø§ÙÙŠØ©", question: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„ÙŠØ§Ø¨Ø§Ù†ØŸ", options: ["Ø·ÙˆÙƒÙŠÙˆ", "ÙƒÙŠÙˆØªÙˆ", "Ø£ÙˆØ³Ø§ÙƒØ§", "ÙŠÙˆÙƒÙˆÙ‡Ø§Ù…Ø§"], correct: 0},
    {category: "Ø±ÙŠØ§Ø¶ÙŠØ©", question: "ÙƒÙ… Ø¹Ø¯Ø¯ Ù„Ø§Ø¹Ø¨ÙŠ ÙƒØ±Ø© Ø§Ù„Ù‚Ø¯Ù… ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙˆØ§Ø­Ø¯ØŸ", options: ["11 Ù„Ø§Ø¹Ø¨Ø§Ù‹", "10 Ù„Ø§Ø¹Ø¨ÙŠÙ†", "12 Ù„Ø§Ø¹Ø¨Ø§Ù‹", "9 Ù„Ø§Ø¹Ø¨ÙŠÙ†"], correct: 0},
    {category: "Ø¹Ù„Ù…ÙŠØ©", question: "ÙƒÙ… Ø¹Ø¯Ø¯ ÙƒÙˆØ§ÙƒØ¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©ØŸ", options: ["8 ÙƒÙˆØ§ÙƒØ¨", "9 ÙƒÙˆØ§ÙƒØ¨", "7 ÙƒÙˆØ§ÙƒØ¨", "10 ÙƒÙˆØ§ÙƒØ¨"], correct: 0},
    {category: "Ø¹Ø§Ù…Ø©", question: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ù„ÙˆØ§Ù† Ù‚ÙˆØ³ Ù‚Ø²Ø­ØŸ", options: ["7 Ø£Ù„ÙˆØ§Ù†", "6 Ø£Ù„ÙˆØ§Ù†", "8 Ø£Ù„ÙˆØ§Ù†", "5 Ø£Ù„ÙˆØ§Ù†"], correct: 0}
];

// â•â•â•â•â•â• STATE â•â•â•â•â•â•
let currentRoomCode = null;
let currentPlayerId = null;
let currentPlayerName = null;
let isHost = false;
let currentTeam = null;
let roomData = null;
let mainTimerInterval = null;
let answerTimerInterval = null;
let roomListener = null;

// â•â•â•â•â•â• SESSION PERSISTENCE â•â•â•â•â•â•
function saveSession() {
    if (currentRoomCode && currentPlayerId) {
        sessionStorage.setItem('gameSession', JSON.stringify({
            roomCode: currentRoomCode,
            playerId: currentPlayerId,
            playerName: currentPlayerName,
            isHost: isHost,
            team: currentTeam
        }));
    }
}

function clearSession() {
    sessionStorage.removeItem('gameSession');
}

function restoreSession() {
    const saved = sessionStorage.getItem('gameSession');
    if (!saved) return false;
    
    try {
        const session = JSON.parse(saved);
        // Check if room still exists
        database.ref('rooms/' + session.roomCode).once('value', (snapshot) => {
            if (!snapshot.exists()) {
                clearSession();
                return;
            }
            const data = snapshot.val();
            // Check if player still in room
            if (!data.players || !data.players[session.playerId]) {
                clearSession();
                return;
            }
            
            currentRoomCode = session.roomCode;
            currentPlayerId = session.playerId;
            currentPlayerName = session.playerName;
            isHost = session.isHost;
            currentTeam = session.team;
            
            listenToRoom();
        });
        return true;
    } catch (e) {
        clearSession();
        return false;
    }
}

// â•â•â•â•â•â• SCREEN MANAGEMENT â•â•â•â•â•â•
function showScreen(id) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
}

function goToMainPage() {
    clearTimers();
    // Remove player from room first
    if (currentRoomCode && currentPlayerId) {
        database.ref('rooms/' + currentRoomCode + '/players/' + currentPlayerId).remove();
    }
    // Remove listener
    if (currentRoomCode && roomListener) {
        database.ref('rooms/' + currentRoomCode).off('value', roomListener);
        roomListener = null;
    }
    clearSession();
    // Reset state
    currentRoomCode = null;
    currentPlayerId = null;
    currentPlayerName = null;
    isHost = false;
    currentTeam = null;
    roomData = null;
    showScreen('welcomeScreen');
}

function clearTimers() {
    clearInterval(mainTimerInterval);
    clearInterval(answerTimerInterval);
    if (typeof localDisplayInterval !== 'undefined') clearInterval(localDisplayInterval);
    mainTimerInterval = null;
    answerTimerInterval = null;
    if (typeof localDisplayInterval !== 'undefined') localDisplayInterval = null;
}

// â•â•â•â•â•â• CREATE ROOM â•â•â•â•â•â•
function createRoom() {
    const name = document.getElementById('hostName').value.trim();
    if (!name) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ'); return; }

    const team1Name = document.getElementById('team1NameInput').value.trim() || 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø­Ù…Ø±';
    const team2Name = document.getElementById('team2NameInput').value.trim() || 'Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£Ø²Ø±Ù‚';
    const teamSize = parseInt(document.getElementById('teamSizeInput').value);

    currentRoomCode = Math.floor(1000 + Math.random() * 9000).toString();
    currentPlayerId = 'host-' + Date.now();
    currentPlayerName = name;
    isHost = true;

    database.ref('rooms/' + currentRoomCode).set({
        code: currentRoomCode,
        host: currentPlayerId,
        team1Name, team2Name, teamSize,
        players: { [currentPlayerId]: { name, isHost: true, team: '' } },
        gameState: 'lobby',
        currentQuestion: '',
        usedQuestions: [],
        team1Couch: [], team2Couch: [],
        team1Score: 0, team2Score: 0,
        buzzedPlayer: '',
        showOptions: false,
        bannedTeam: '',
        correctAnswer: '',
        selectedAnswer: '',
        waitingForChoice: false,
        choicePlayer: '',
        waitingForTextAnswer: false,
        questionStartTime: '',
        buzzTime: ''
    });

    saveSession();
    listenToRoom();
    showLobby();
}

// â•â•â•â•â•â• JOIN ROOM â•â•â•â•â•â•
function joinRoom() {
    const name = document.getElementById('playerName').value.trim();
    const code = document.getElementById('roomCodeInput').value.trim();
    if (!name) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ'); return; }
    if (!code || code.length !== 4) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„ØºØ±ÙØ© (4 Ø£Ø±Ù‚Ø§Ù…)'); return; }

    database.ref('rooms/' + code).once('value', (snapshot) => {
        if (!snapshot.exists()) { alert('Ø§Ù„ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'); return; }

        currentRoomCode = code;
        currentPlayerId = 'player-' + Date.now();
        currentPlayerName = name;
        isHost = false;

        database.ref('rooms/' + currentRoomCode + '/players/' + currentPlayerId).set({
            name, isHost: false, team: ''
        });

        saveSession();
        listenToRoom();
        showScreen('teamSelectionScreen');
        document.getElementById('welcomePlayerName').textContent = name;
    });
}

// â•â•â•â•â•â• LISTEN TO ROOM â•â•â•â•â•â•
function listenToRoom() {
    if (roomListener) {
        database.ref('rooms/' + currentRoomCode).off('value', roomListener);
    }
    roomListener = database.ref('rooms/' + currentRoomCode).on('value', (snapshot) => {
        if (!snapshot.exists()) {
            clearSession();
            showScreen('welcomeScreen');
            return;
        }
        roomData = snapshot.val();
        // Make sure player still exists
        if (!roomData.players || !roomData.players[currentPlayerId]) {
            // Player was removed â€” if this was page refresh, re-add might be needed
            // But we keep session, so just return
            return;
        }
        // Sync team from DB in case of refresh
        const myData = roomData.players[currentPlayerId];
        if (myData.team && !currentTeam) {
            currentTeam = myData.team;
        }
        updateUI();
    });
}

// â•â•â•â•â•â• SHOW LOBBY â•â•â•â•â•â•
function showLobby() {
    showScreen('lobbyScreen');
    document.getElementById('displayRoomCode').textContent = currentRoomCode;
    renderHostTeamBtns();
}

function renderHostTeamBtns() {
    if (!roomData) return;
    const container = document.getElementById('hostTeamBtns');
    container.innerHTML = `
        <button class="team-select-btn red-team ${currentTeam === 'team1' ? 'selected' : ''}" onclick="selectHostTeam('team1')">ğŸ”´ ${roomData.team1Name}</button>
        <button class="team-select-btn blue-team ${currentTeam === 'team2' ? 'selected' : ''}" onclick="selectHostTeam('team2')">ğŸ”µ ${roomData.team2Name}</button>
    `;
}

function selectHostTeam(team) {
    currentTeam = team;
    database.ref('rooms/' + currentRoomCode + '/players/' + currentPlayerId).update({ team });
    saveSession();
    renderHostTeamBtns();
}

// â•â•â•â•â•â• TEAM SELECTION (joining players) â•â•â•â•â•â•
function renderTeamSelectBtns() {
    if (!roomData) return;
    const container = document.getElementById('teamSelectBtns');
    container.innerHTML = `
        <button class="team-select-btn red-team" onclick="selectTeam('team1')">ğŸ”´ ${roomData.team1Name}</button>
        <button class="team-select-btn blue-team" onclick="selectTeam('team2')">ğŸ”µ ${roomData.team2Name}</button>
    `;
}

function selectTeam(team) {
    currentTeam = team;
    database.ref('rooms/' + currentRoomCode + '/players/' + currentPlayerId).update({ team });
    saveSession();
    
    if (roomData.gameState === 'playing') {
        showScreen('gameScreen');
    } else {
        showScreen('waitingScreen');
    }
}

// â•â•â•â•â•â• UPDATE UI â•â•â•â•â•â•
function updateUI() {
    if (!roomData) return;

    if (roomData.gameState === 'lobby') {
        if (isHost) {
            if (!document.getElementById('lobbyScreen').classList.contains('active')) {
                showLobby();
            }
            updateLobby();
        } else if (!currentTeam) {
            if (!document.getElementById('teamSelectionScreen').classList.contains('active')) {
                showScreen('teamSelectionScreen');
                document.getElementById('welcomePlayerName').textContent = currentPlayerName;
            }
            renderTeamSelectBtns();
        } else {
            if (!document.getElementById('waitingScreen').classList.contains('active')) {
                showScreen('waitingScreen');
            }
            updateWaiting();
        }
    } else if (roomData.gameState === 'playing') {
        if (!currentTeam) {
            showScreen('teamSelectionScreen');
            document.getElementById('welcomePlayerName').textContent = currentPlayerName;
            renderTeamSelectBtns();
        } else {
            if (!document.getElementById('gameScreen').classList.contains('active')) {
                showScreen('gameScreen');
            }
            updateGameScreen();
        }
    }
}

// â•â•â•â•â•â• UPDATE LOBBY â•â•â•â•â•â•
function updateLobby() {
    const players = roomData.players || {};
    const count = Object.keys(players).length;
    const required = (roomData.teamSize || 2) * 2;

    document.getElementById('playerCount').textContent = count;

    const list = document.getElementById('lobbyPlayersList');
    list.innerHTML = '';
    Object.entries(players).forEach(([id, p]) => {
        const chip = document.createElement('div');
        chip.className = 'player-chip';
        let dotClass = 'dot-gold';
        if (p.team === 'team1') dotClass = 'dot-red';
        if (p.team === 'team2') dotClass = 'dot-blue';
        chip.innerHTML = `<span class="dot ${dotClass}"></span>${p.name}${p.isHost ? ' ğŸ‘‘' : ''}`;
        list.appendChild(chip);
    });

    renderHostTeamBtns();

    const startBtn = document.getElementById('startGameBtn');
    if (count >= required && currentTeam) {
        startBtn.disabled = false;
        startBtn.textContent = 'Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø© â–¶ï¸';
    } else if (!currentTeam) {
        startBtn.disabled = true;
        startBtn.textContent = 'Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ Ø£ÙˆÙ„Ø§Ù‹';
    } else {
        startBtn.disabled = true;
        startBtn.textContent = `Ø¨Ø­Ø§Ø¬Ø© Ø¥Ù„Ù‰ ${required - count} Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¥Ø¶Ø§ÙÙŠÙŠÙ†`;
    }
}

// â•â•â•â•â•â• UPDATE WAITING â•â•â•â•â•â•
function updateWaiting() {
    const teamName = currentTeam === 'team1' ? roomData.team1Name : roomData.team2Name;
    document.getElementById('waitingTeamName').textContent = teamName;

    const list = document.getElementById('waitingPlayersList');
    list.innerHTML = '';
    Object.entries(roomData.players || {}).forEach(([id, p]) => {
        const chip = document.createElement('div');
        chip.className = 'player-chip';
        let dotClass = 'dot-gold';
        if (p.team === 'team1') dotClass = 'dot-red';
        if (p.team === 'team2') dotClass = 'dot-blue';
        chip.innerHTML = `<span class="dot ${dotClass}"></span>${p.name}${p.isHost ? ' ğŸ‘‘' : ''}`;
        list.appendChild(chip);
    });
}

// â•â•â•â•â•â• START GAME â•â•â•â•â•â•
function startGame() {
    if (!currentTeam) { alert('Ø§Ø®ØªØ± ÙØ±ÙŠÙ‚Ùƒ Ø£ÙˆÙ„Ø§Ù‹'); return; }
    database.ref('rooms/' + currentRoomCode).update({ gameState: 'playing' });
    showScreen('gameScreen');
}

// â•â•â•â•â•â• GAME SCREEN UPDATE â•â•â•â•â•â•
function updateGameScreen() {
    if (!roomData) return;

    // Victory check first
    const teamSize = roomData.teamSize || 2;
    const t1c = roomData.team1Couch || [];
    const t2c = roomData.team2Couch || [];

    if (t1c.length >= teamSize || t2c.length >= teamSize) {
        showVictory();
        return;
    }

    // Hide victory if not won
    document.getElementById('victoryOverlay').classList.remove('active');

    // Top bar
    document.getElementById('gTeam1Name').textContent = roomData.team1Name;
    document.getElementById('gTeam2Name').textContent = roomData.team2Name;
    document.getElementById('gTeam1Score').textContent = t1c.length + '/' + teamSize;
    document.getElementById('gTeam2Score').textContent = t2c.length + '/' + teamSize;

    // Team players in top bar
    renderTeamPlayers('gTeam1Players', 'team1');
    renderTeamPlayers('gTeam2Players', 'team2');

    // Couch
    document.getElementById('couchTeam1Label').textContent = roomData.team1Name;
    document.getElementById('couchTeam2Label').textContent = roomData.team2Name;
    renderCouchSeats('couchTeam1Seats', t1c, teamSize);
    renderCouchSeats('couchTeam2Seats', t2c, teamSize);

    // Check if I'm on couch
    const isOnCouch = (currentTeam === 'team1' && t1c.includes(currentPlayerId)) ||
                      (currentTeam === 'team2' && t2c.includes(currentPlayerId));

    const onCouchBanner = document.getElementById('onCouchBanner');
    const gameContent = document.getElementById('gameContent');

    if (isOnCouch) {
        onCouchBanner.classList.remove('hidden');
        gameContent.style.display = 'none';
    } else {
        onCouchBanner.classList.add('hidden');
        gameContent.style.display = 'block';
        renderGameContent();
    }

    // Host next button - ALWAYS visible and enabled for host
    const hostNextBtn = document.getElementById('hostNextBtn');
    if (isHost) {
        hostNextBtn.classList.remove('hidden');
    } else {
        hostNextBtn.classList.add('hidden');
    }
}

function renderTeamPlayers(containerId, team) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    const couch = roomData[team + 'Couch'] || [];
    Object.entries(roomData.players || {}).forEach(([id, p]) => {
        if (p.team === team) {
            const span = document.createElement('span');
            span.className = 'mini-player' + (couch.includes(id) ? ' on-couch' : '');
            span.textContent = p.name;
            container.appendChild(span);
        }
    });
}

function renderCouchSeats(containerId, couchArr, teamSize) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    for (let i = 0; i < teamSize; i++) {
        if (couchArr[i]) {
            const player = roomData.players[couchArr[i]];
            if (player) {
                const div = document.createElement('div');
                div.className = 'couch-seat';
                div.textContent = 'ğŸ† ' + player.name;
                container.appendChild(div);
            }
        } else {
            const div = document.createElement('div');
            div.className = 'seat-slot';
            div.textContent = 'â€”';
            container.appendChild(div);
        }
    }
}

// â•â•â•â•â•â• HELPER: Firebase removes null keys, so we use '' as "no value" â•â•â•â•â•â•
function hasAnswer() {
    // correctAnswer is set to '' when no answer, true when correct, false when wrong
    return roomData.correctAnswer === true || roomData.correctAnswer === false;
}

// â•â•â•â•â•â• GAME CONTENT RENDERING â•â•â•â•â•â•
function renderGameContent() {
    const questionCard = document.getElementById('questionCard');
    const mainTimerBar = document.getElementById('mainTimerBar');
    const buzzerIndicator = document.getElementById('buzzerIndicator');
    const gameStatus = document.getElementById('gameStatus');
    const buzzerBtn = document.getElementById('buzzerBtn');
    const answerInputArea = document.getElementById('answerInputArea');
    const optionsGrid = document.getElementById('optionsGrid');
    const choiceGrid = document.getElementById('choiceGrid');

    // Reset all
    questionCard.classList.add('hidden');
    mainTimerBar.classList.add('hidden');
    buzzerIndicator.classList.add('hidden');
    buzzerBtn.classList.add('hidden');
    answerInputArea.classList.add('hidden');
    optionsGrid.classList.add('hidden');
    choiceGrid.classList.add('hidden');
    buzzerBtn.disabled = true;

    const myTeam = roomData.players[currentPlayerId]?.team;

    // â”€â”€ STATE: Waiting for choice (sit/pull) â”€â”€
    if (roomData.waitingForChoice && roomData.choicePlayer === currentPlayerId) {
        questionCard.classList.remove('hidden');
        if (roomData.currentQuestion) {
            document.getElementById('qCategory').textContent = roomData.currentQuestion.category || '';
            document.getElementById('qText').textContent = roomData.currentQuestion.question;
        }
        gameStatus.textContent = 'âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©! Ø§Ø®ØªØ± Ù…Ø§Ø°Ø§ ØªØ±ÙŠØ¯ Ø£Ù† ØªÙØ¹Ù„:';
        gameStatus.className = 'status-bar success';
        renderChoiceButtons();
        return;
    }
    if (roomData.waitingForChoice) {
        const cp = roomData.players[roomData.choicePlayer];
        questionCard.classList.remove('hidden');
        if (roomData.currentQuestion) {
            document.getElementById('qCategory').textContent = roomData.currentQuestion.category || '';
            document.getElementById('qText').textContent = roomData.currentQuestion.question;
        }
        gameStatus.textContent = `${cp?.name || ''} ÙŠØ®ØªØ§Ø± Ø§Ù„Ø¢Ù†...`;
        gameStatus.className = 'status-bar info';
        return;
    }

    // â”€â”€ STATE: No question yet â”€â”€
    if (!roomData.currentQuestion) {
        gameStatus.textContent = 'Ø§Ù†ØªØ¸Ø± Ø§Ù„Ø³Ø¤Ø§Ù„...';
        gameStatus.className = 'status-bar info';
        return;
    }

    // Show question always when there is one
    questionCard.classList.remove('hidden');
    document.getElementById('qCategory').textContent = roomData.currentQuestion.category || '';
    document.getElementById('qText').textContent = roomData.currentQuestion.question;

    // â”€â”€ STATE: Text answer input (5 seconds) â”€â”€
    if (roomData.waitingForTextAnswer && roomData.buzzedPlayer === currentPlayerId && !hasAnswer()) {
        gameStatus.textContent = 'Ø§ÙƒØªØ¨ Ø¥Ø¬Ø§Ø¨ØªÙƒ Ø¨Ø³Ø±Ø¹Ø©!';
        gameStatus.className = 'status-bar warning';
        answerInputArea.classList.remove('hidden');
        showSyncedMainTimer();
        startAnswerTimerDisplay();
        return;
    }

    // â”€â”€ STATE: Someone else is typing â”€â”€
    if (roomData.waitingForTextAnswer && roomData.buzzedPlayer && roomData.buzzedPlayer !== currentPlayerId && !hasAnswer()) {
        const bp = roomData.players[roomData.buzzedPlayer];
        const bTeam = bp?.team === 'team1' ? roomData.team1Name : roomData.team2Name;
        buzzerIndicator.classList.remove('hidden');
        buzzerIndicator.textContent = `ğŸ”” ${bp?.name} Ù…Ù† ${bTeam} ÙŠÙƒØªØ¨ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©...`;
        gameStatus.textContent = 'Ø§Ù†ØªØ¸Ø±...';
        gameStatus.className = 'status-bar info';
        showSyncedMainTimer();
        return;
    }

    // â”€â”€ STATE: Options shown (no answer yet) â”€â”€
    if (roomData.showOptions && !hasAnswer()) {
        // Options visible to ALL
        optionsGrid.classList.remove('hidden');
        optionsGrid.innerHTML = '';

        const isBanned = roomData.bannedTeam && roomData.bannedTeam === myTeam;

        roomData.currentQuestion.options.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.textContent = opt;
            if (isBanned) {
                btn.disabled = true;
            } else {
                btn.onclick = () => selectAnswer(idx);
            }
            optionsGrid.appendChild(btn);
        });

        if (isBanned) {
            gameStatus.textContent = 'ÙØ±ÙŠÙ‚Ùƒ Ù…Ù…Ù†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„';
            gameStatus.className = 'status-bar error';
        } else if (roomData.bannedTeam) {
            gameStatus.textContent = 'ÙØ±ØµØ© ÙØ±ÙŠÙ‚Ùƒ! Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©';
            gameStatus.className = 'status-bar info';
        } else {
            gameStatus.textContent = 'Ù„Ù… ÙŠØ¶ØºØ· Ø£Ø­Ø¯ Ø§Ù„Ø¬Ø±Ø³! Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©';
            gameStatus.className = 'status-bar info';
        }
        return;
    }

    // â”€â”€ STATE: Correct/Wrong answer result â”€â”€
    if (hasAnswer()) {
        if (roomData.correctAnswer === true) {
            gameStatus.textContent = 'âœ… Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø©!';
            gameStatus.className = 'status-bar success';
        } else {
            gameStatus.textContent = 'âŒ Ø¥Ø¬Ø§Ø¨Ø© Ø®Ø§Ø·Ø¦Ø©!';
            gameStatus.className = 'status-bar error';
        }
        return;
    }

    // â”€â”€ STATE: Question active, no buzz yet, timer running â”€â”€
    if (!roomData.buzzedPlayer && !roomData.showOptions) {
        showSyncedMainTimer();
        buzzerBtn.classList.remove('hidden');
        buzzerBtn.disabled = false;
        gameStatus.textContent = 'Ø§Ù‚Ø±Ø£ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙˆØ§Ø¶ØºØ· Ø§Ù„Ø¬Ø±Ø³ Ù„Ù„Ø¥Ø¬Ø§Ø¨Ø©!';
        gameStatus.className = 'status-bar info';
        return;
    }

    // â”€â”€ STATE: Someone buzzed but not me â”€â”€
    if (roomData.buzzedPlayer && roomData.buzzedPlayer !== currentPlayerId) {
        const bp = roomData.players[roomData.buzzedPlayer];
        gameStatus.textContent = `${bp?.name || ''} ÙŠØ¬ÙŠØ¨ Ø§Ù„Ø¢Ù†...`;
        gameStatus.className = 'status-bar warning';
        showSyncedMainTimer();
    }
}

// â•â•â•â•â•â• SYNCED TIMERS â•â•â•â•â•â•
let localDisplayInterval = null;

function showSyncedMainTimer() {
    if (!roomData.questionStartTime) return;

    const mainTimerBar = document.getElementById('mainTimerBar');
    const circle = document.getElementById('mainTimerCircle');
    mainTimerBar.classList.remove('hidden');

    // Calculate remaining from server time
    const elapsed = Math.floor((Date.now() - roomData.questionStartTime) / 1000);
    const timeLeft = Math.max(0, 30 - elapsed);
    circle.textContent = timeLeft;
    circle.classList.toggle('danger', timeLeft <= 3);

    // Start local display interval for smooth countdown (all players)
    if (!localDisplayInterval) {
        localDisplayInterval = setInterval(() => {
            if (!roomData || !roomData.questionStartTime) {
                clearInterval(localDisplayInterval);
                localDisplayInterval = null;
                return;
            }
            const el = Math.floor((Date.now() - roomData.questionStartTime) / 1000);
            const tl = Math.max(0, 30 - el);
            const c = document.getElementById('mainTimerCircle');
            if (c) {
                c.textContent = tl;
                c.classList.toggle('danger', tl <= 3);
            }
            if (tl <= 0) {
                clearInterval(localDisplayInterval);
                localDisplayInterval = null;
            }
        }, 500);
    }

    // If host, also run the authoritative timer logic
    if (isHost && !mainTimerInterval) {
        runHostMainTimer();
    }
}

function runHostMainTimer() {
    clearInterval(mainTimerInterval);
    mainTimerInterval = setInterval(() => {
        if (!roomData || !roomData.questionStartTime) {
            clearInterval(mainTimerInterval);
            mainTimerInterval = null;
            return;
        }
        const elapsed = Math.floor((Date.now() - roomData.questionStartTime) / 1000);
        const timeLeft = Math.max(0, 30 - elapsed);

        const circle = document.getElementById('mainTimerCircle');
        if (circle) {
            circle.textContent = timeLeft;
            circle.classList.toggle('danger', timeLeft <= 3);
        }

        if (timeLeft <= 0) {
            clearInterval(mainTimerInterval);
            mainTimerInterval = null;
            // Open options for everyone
            if (!hasAnswer() && !roomData.showOptions) {
                const updateData = { showOptions: true, waitingForTextAnswer: false };
                if (roomData.buzzedPlayer) {
                    updateData.bannedTeam = roomData.players[roomData.buzzedPlayer]?.team || '';
                }
                database.ref('rooms/' + currentRoomCode).update(updateData);
            }
        }
    }, 500);
}

function startAnswerTimerDisplay() {
    if (!roomData.buzzTime) return;
    clearInterval(answerTimerInterval);

    const circle = document.getElementById('answerTimerCircle');
    
    answerTimerInterval = setInterval(() => {
        if (!roomData.buzzTime) { clearInterval(answerTimerInterval); return; }
        const elapsed = Math.floor((Date.now() - roomData.buzzTime) / 1000);
        const timeLeft = Math.max(0, 5 - elapsed);
        circle.textContent = timeLeft;
        circle.classList.toggle('danger', timeLeft <= 2);

        if (timeLeft <= 0) {
            clearInterval(answerTimerInterval);
            // Time ran out for text answer â€” mark as wrong
            if (roomData.buzzedPlayer === currentPlayerId && !hasAnswer()) {
                const playerTeam = roomData.players[currentPlayerId]?.team;
                database.ref('rooms/' + currentRoomCode).update({
                    correctAnswer: false,
                    waitingForTextAnswer: false,
                    showOptions: true,
                    bannedTeam: playerTeam
                });
            }
        }
    }, 300);
}

// â•â•â•â•â•â• BUZZER â•â•â•â•â•â•
function buzzIn() {
    if (!roomData.currentQuestion || roomData.buzzedPlayer || roomData.showOptions) return;
    database.ref('rooms/' + currentRoomCode).update({
        buzzedPlayer: currentPlayerId,
        waitingForTextAnswer: true,
        buzzTime: Date.now()
    });
}

// â•â•â•â•â•â• SUBMIT TEXT ANSWER â•â•â•â•â•â•
function submitTextAnswer() {
    const input = document.getElementById('textAnswerInput');
    const userAnswer = normalizeArabic(input.value.trim());
    
    if (!userAnswer) { alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø¥Ø¬Ø§Ø¨Ø©!'); return; }
    clearInterval(answerTimerInterval);

    const correctOption = roomData.currentQuestion.options[roomData.currentQuestion.correct];
    const correctNorm = normalizeArabic(correctOption);

    const isCorrect = userAnswer === correctNorm;

    const roomRef = database.ref('rooms/' + currentRoomCode);

    if (isCorrect) {
        roomRef.update({ correctAnswer: true, waitingForTextAnswer: false });
        // Check if other team has couch players
        const otherTeam = currentTeam === 'team1' ? 'team2' : 'team1';
        const otherCouch = roomData[otherTeam + 'Couch'] || [];
        const myCouch = roomData[currentTeam + 'Couch'] || [];
        const teamSize = roomData.teamSize || 2;

        if (myCouch.length >= teamSize && otherCouch.length > 0) {
            // Couch full, must pull
            roomRef.update({ waitingForChoice: true, choicePlayer: currentPlayerId });
        } else if (myCouch.length >= teamSize) {
            // Couch full, no one to pull â€” do nothing special
        } else if (otherCouch.length > 0) {
            // Can sit or pull
            roomRef.update({ waitingForChoice: true, choicePlayer: currentPlayerId });
        } else {
            // Just sit
            addToCouch();
        }
    } else {
        const playerTeam = roomData.players[currentPlayerId]?.team;
        roomRef.update({
            correctAnswer: false,
            waitingForTextAnswer: false,
            showOptions: true,
            bannedTeam: playerTeam
        });
    }
    input.value = '';
}

// â•â•â•â•â•â• NORMALIZE ARABIC â•â•â•â•â•â•
function normalizeArabic(str) {
    return str
        .toLowerCase()
        .replace(/[\u064B-\u065F\u0670]/g, '') // remove tashkeel
        .replace(/Ø©/g, 'Ù‡')  // taa marbuta â†’ ha
        .replace(/Ù‰/g, 'ÙŠ')  // alef maqsura â†’ ya
        .replace(/Ø£|Ø¥|Ø¢/g, 'Ø§') // normalize alef
        .replace(/\s+/g, ' ')
        .trim();
}

// â•â•â•â•â•â• SELECT ANSWER (from options) â•â•â•â•â•â•
function selectAnswer(idx) {
    const isCorrect = idx === roomData.currentQuestion.correct;

    clearInterval(mainTimerInterval);
    clearInterval(localDisplayInterval);
    mainTimerInterval = null;
    localDisplayInterval = null;

    const roomRef = database.ref('rooms/' + currentRoomCode);

    roomRef.update({
        selectedAnswer: idx,
        correctAnswer: isCorrect,
        showOptions: false,
        buzzedPlayer: roomData.buzzedPlayer || currentPlayerId
    });

    if (isCorrect) {
        const otherTeam = currentTeam === 'team1' ? 'team2' : 'team1';
        const otherCouch = roomData[otherTeam + 'Couch'] || [];
        const myCouch = roomData[currentTeam + 'Couch'] || [];
        const teamSize = roomData.teamSize || 2;

        if (myCouch.length >= teamSize && otherCouch.length > 0) {
            roomRef.update({ waitingForChoice: true, choicePlayer: currentPlayerId, bannedTeam: '' });
        } else if (myCouch.length >= teamSize) {
            roomRef.update({ bannedTeam: '' });
        } else if (otherCouch.length > 0) {
            roomRef.update({ waitingForChoice: true, choicePlayer: currentPlayerId, bannedTeam: '' });
        } else {
            addToCouch();
            roomRef.update({ bannedTeam: '' });
        }
    }
}

// â•â•â•â•â•â• CHOICE: SIT or PULL â•â•â•â•â•â•
function renderChoiceButtons() {
    const choiceGrid = document.getElementById('choiceGrid');
    choiceGrid.classList.remove('hidden');
    choiceGrid.innerHTML = '';

    const teamSize = roomData.teamSize || 2;
    const myCouch = roomData[currentTeam + 'Couch'] || [];
    const otherTeam = currentTeam === 'team1' ? 'team2' : 'team1';
    const otherCouch = roomData[otherTeam + 'Couch'] || [];
    const myCouchFull = myCouch.length >= teamSize;

    if (myCouchFull && otherCouch.length > 0) {
        const btn = document.createElement('button');
        btn.className = 'choice-btn pull';
        btn.textContent = 'ğŸ¯ Ø§Ø³Ø­Ø¨ Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø±';
        btn.onclick = () => makeChoice('steal');
        choiceGrid.appendChild(btn);
    } else if (!myCouchFull) {
        const sitBtn = document.createElement('button');
        sitBtn.className = 'choice-btn sit';
        sitBtn.textContent = 'ğŸ›‹ï¸ Ø§Ø¬Ù„Ø³ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ†Ø¨Ø©';
        sitBtn.onclick = () => makeChoice('sit');
        choiceGrid.appendChild(sitBtn);

        if (otherCouch.length > 0) {
            const pullBtn = document.createElement('button');
            pullBtn.className = 'choice-btn pull';
            pullBtn.textContent = 'ğŸ¯ Ø§Ø³Ø­Ø¨ Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø±';
            pullBtn.onclick = () => makeChoice('steal');
            choiceGrid.appendChild(pullBtn);
        }
    }
}

function makeChoice(choice) {
    if (choice === 'sit') {
        addToCouch();
    } else if (choice === 'steal') {
        stealFromCouch();
    }
}

function addToCouch() {
    const couchKey = currentTeam + 'Couch';
    const teamSize = roomData.teamSize || 2;
    const currentCouch = roomData[couchKey] || [];

    if (currentCouch.length >= teamSize) {
        database.ref('rooms/' + currentRoomCode).update({
            waitingForChoice: false, choicePlayer: ''
        });
        return;
    }

    const newCouch = [...currentCouch, currentPlayerId];
    database.ref('rooms/' + currentRoomCode).update({
        [couchKey]: newCouch,
        waitingForChoice: false,
        choicePlayer: ''
    });
}

function stealFromCouch() {
    const otherTeam = currentTeam === 'team1' ? 'team2' : 'team1';
    const otherCouchKey = otherTeam + 'Couch';
    const couchKey = currentTeam + 'Couch';
    const teamSize = roomData.teamSize || 2;

    const otherCouch = [...(roomData[otherCouchKey] || [])];
    const myCouch = [...(roomData[couchKey] || [])];

    if (otherCouch.length === 0) {
        database.ref('rooms/' + currentRoomCode).update({
            waitingForChoice: false, choicePlayer: ''
        });
        return;
    }

    // Pull last player from other team's couch
    otherCouch.pop();

    const updates = {
        [otherCouchKey]: otherCouch,
        waitingForChoice: false,
        choicePlayer: ''
    };

    // If my couch not full, I also sit
    if (myCouch.length < teamSize) {
        updates[couchKey] = [...myCouch, currentPlayerId];
    }

    database.ref('rooms/' + currentRoomCode).update(updates);
}

// â•â•â•â•â•â• NEXT QUESTION â•â•â•â•â•â•
function nextQuestion() {
    clearTimers();

    const usedQuestions = roomData.usedQuestions || [];
    let available = questions.filter(q => !usedQuestions.includes(q.question));
    if (available.length === 0) {
        available = [...questions];
        usedQuestions.length = 0;
    }

    const q = available[Math.floor(Math.random() * available.length)];
    usedQuestions.push(q.question);

    // Use empty string instead of null for Firebase (null deletes the key)
    database.ref('rooms/' + currentRoomCode).update({
        currentQuestion: q,
        usedQuestions: usedQuestions,
        buzzedPlayer: '',
        showOptions: false,
        bannedTeam: '',
        correctAnswer: '',  // empty = no answer yet
        selectedAnswer: '',
        waitingForChoice: false,
        choicePlayer: '',
        questionStartTime: Date.now(),
        waitingForTextAnswer: false,
        buzzTime: ''
    });
}

// â•â•â•â•â•â• VICTORY â•â•â•â•â•â•
function showVictory() {
    const teamSize = roomData.teamSize || 2;
    const t1c = (roomData.team1Couch || []).length;
    const t2c = (roomData.team2Couch || []).length;

    clearTimers();

    let winner = '';
    if (t1c >= teamSize) winner = roomData.team1Name;
    if (t2c >= teamSize) winner = roomData.team2Name;

    document.getElementById('victoryOverlay').classList.add('active');
    document.getElementById('victoryMsg').textContent = `ğŸ‰ ${winner} ÙØ§Ø² Ø¨Ø§Ù„Ù„Ø¹Ø¨Ø©! ğŸ‰`;
    
    // Hide game content
    document.getElementById('gameContent').style.display = 'none';
    document.getElementById('onCouchBanner').classList.add('hidden');
    document.getElementById('hostNextBtn').classList.add('hidden');
    document.getElementById('gameTopBar').style.display = 'none';
    document.getElementById('couchSection').style.display = 'none';
}

function replayGame() {
    database.ref('rooms/' + currentRoomCode).update({
        gameState: 'playing',
        currentQuestion: '',
        usedQuestions: [],
        team1Couch: [], team2Couch: [],
        team1Score: 0, team2Score: 0,
        buzzedPlayer: '',
        showOptions: false,
        bannedTeam: '',
        correctAnswer: '',
        selectedAnswer: '',
        waitingForChoice: false,
        choicePlayer: '',
        waitingForTextAnswer: false,
        questionStartTime: '',
        buzzTime: ''
    });
    // Re-show elements
    document.getElementById('gameTopBar').style.display = '';
    document.getElementById('couchSection').style.display = '';
    document.getElementById('gameContent').style.display = '';
    document.getElementById('victoryOverlay').classList.remove('active');
}

// â•â•â•â•â•â• INPUT LISTENERS â•â•â•â•â•â•
document.getElementById('roomCodeInput')?.addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9]/g, '');
});

document.getElementById('textAnswerInput')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') submitTextAnswer();
});

// â•â•â•â•â•â• INIT: Try restore session â•â•â•â•â•â•
if (!restoreSession()) {
    showScreen('welcomeScreen');
}
</script>
</body>
</html>
