<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø®Ø§Ø¯Ø¹ 3D</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2e 100%);
            overflow: hidden;
            direction: rtl;
            color: #fff;
        }

        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        .menu {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.95), rgba(136, 14, 79, 0.95));
            padding: 40px 50px;
            border-radius: 30px;
            border: 3px solid rgba(255, 215, 0, 0.6);
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.9);
            z-index: 100;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .menu.hidden {
            display: none;
        }

        h1 {
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 20px;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .subtitle {
            font-size: 1em;
            color: #ccc;
            margin-bottom: 30px;
        }

        input, select {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.4);
            color: #fff;
            font-size: 1em;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ffd700;
        }

        button {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-family: inherit;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .info-bar {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 40px;
            border-radius: 20px;
            border: 2px solid rgba(255, 215, 0, 0.6);
            z-index: 50;
            text-align: center;
        }

        .room-code {
            font-size: 2em;
            color: #ffd700;
            letter-spacing: 8px;
            font-weight: bold;
        }

        .error {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .success {
            color: #2ecc71;
            margin-top: 10px;
            font-size: 0.9em;
        }

        .player-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            margin: 5px 0;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
        }

        .player-item.host {
            border-right: 3px solid #ffd700;
            background: rgba(255, 215, 0, 0.15);
        }

        .player-item.me {
            border-right: 3px solid #e74c3c;
            background: rgba(231, 76, 60, 0.15);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <!-- Menu -->
    <div class="menu" id="menu">
        <h1>ğŸ” Ø§Ù„Ù…Ø­Ù‚Ù‚ Ø§Ù„Ù…Ø®Ø§Ø¯Ø¹ ğŸ”ª</h1>
        <div class="subtitle">Ù„Ø¹Ø¨Ø© ØªØ­Ù‚ÙŠÙ‚ Ø«Ù„Ø§Ø«ÙŠØ© Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯</div>
        
        <div id="mainMenu">
            <button onclick="showCreate()">ğŸ  Ø¥Ù†Ø´Ø§Ø¡ ØºØ±ÙØ©</button>
            <button onclick="showJoin()" class="btn-secondary">ğŸšª Ø§Ù†Ø¶Ù…Ø§Ù…</button>
        </div>

        <div id="createMenu" style="display:none;">
            <input type="text" id="hostName" placeholder="Ø§Ø³Ù…Ùƒ" maxlength="12">
            <select id="playerCount">
                <option value="4">4 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                <option value="5">5 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                <option value="6">6 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                <option value="7">7 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
                <option value="8">8 Ù„Ø§Ø¹Ø¨ÙŠÙ†</option>
            </select>
            <button onclick="createRoom()" class="btn-success">Ø¥Ù†Ø´Ø§Ø¡</button>
            <button onclick="backToMain()" class="btn-secondary">Ø±Ø¬ÙˆØ¹</button>
            <div id="createMsg"></div>
        </div>

        <div id="joinMenu" style="display:none;">
            <input type="text" id="playerName" placeholder="Ø§Ø³Ù…Ùƒ" maxlength="12">
            <input type="text" id="roomCode" placeholder="Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©" maxlength="4" style="text-transform:uppercase;text-align:center;letter-spacing:5px;">
            <button onclick="joinRoom()" class="btn-success">Ø§Ù†Ø¶Ù…Ø§Ù…</button>
            <button onclick="backToMain()" class="btn-secondary">Ø±Ø¬ÙˆØ¹</button>
            <div id="joinMsg"></div>
        </div>
    </div>

    <div class="info-bar" id="infoBar" style="display:none;">
        <div class="room-code" id="roomCodeDisplay">----</div>
        <div style="font-size:0.9em;color:#ccc;margin-top:5px;">
            <span id="playerCount">0</span>/<span id="maxPlayers">4</span> Ù„Ø§Ø¹Ø¨ÙŠÙ†
        </div>
        <div id="playersList" style="margin-top:15px;max-height:200px;overflow-y:auto;"></div>
        <button id="startGameBtn" style="display:none;margin-top:15px;width:auto;padding:12px 30px;" onclick="startGamePlay()" class="btn-success">
            ğŸ® Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        </button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script>
        console.log('ğŸ® Starting game...');

        // Check if libraries loaded
        if (typeof THREE === 'undefined') {
            alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Three.js');
            console.error('Three.js failed to load');
        }
        if (typeof firebase === 'undefined') {
            alert('Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Firebase');
            console.error('Firebase failed to load');
        }

        // Firebase
        firebase.initializeApp({
            apiKey: "AIzaSyB88NCDQzsUzHZgH07B63e4Dpxc3LfXSyY",
            authDomain: "detective-game-df960.firebaseapp.com",
            databaseURL: "https://detective-game-df960-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "detective-game-df960"
        });
        var db = firebase.database();
        console.log('âœ… Firebase ready');

        // Three.js Setup
        const canvas = document.getElementById('gameCanvas');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        scene.background = new THREE.Color(0x0a0a0a);
        console.log('âœ… Three.js ready');

        // Lights
        const ambientLight = new THREE.AmbientLight(0x404040, 2);
        scene.add(ambientLight);

        const spotLight = new THREE.SpotLight(0xffd700, 2);
        spotLight.position.set(0, 15, 0);
        spotLight.castShadow = true;
        scene.add(spotLight);

        const pointLight1 = new THREE.PointLight(0xff0040, 1, 30);
        pointLight1.position.set(-10, 5, -10);
        scene.add(pointLight1);

        const pointLight2 = new THREE.PointLight(0x0040ff, 1, 30);
        pointLight2.position.set(10, 5, -10);
        scene.add(pointLight2);

        // Table
        const tableGeometry = new THREE.CylinderGeometry(5, 5, 0.3, 32);
        const tableMaterial = new THREE.MeshStandardMaterial({ color: 0x4a2c2a });
        const table = new THREE.Mesh(tableGeometry, tableMaterial);
        table.castShadow = true;
        table.receiveShadow = true;
        scene.add(table);

        // Felt
        const feltGeometry = new THREE.CylinderGeometry(4.8, 4.8, 0.05, 32);
        const feltMaterial = new THREE.MeshStandardMaterial({ color: 0x0a5f38 });
        const felt = new THREE.Mesh(feltGeometry, feltMaterial);
        felt.position.y = 0.18;
        felt.receiveShadow = true;
        scene.add(felt);

        // Floor
        const floorGeometry = new THREE.PlaneGeometry(50, 50);
        const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x1a1a1a });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -2;
        floor.receiveShadow = true;
        scene.add(floor);

        // Camera
        camera.position.set(0, 12, 15);
        camera.lookAt(0, 0, 0);

        // Camera controls
        let cameraAngle = 0;
        let isDragging = false;
        let previousMouse = { x: 0, y: 0 };

        canvas.addEventListener('mousedown', (e) => {
            isDragging = true;
            previousMouse = { x: e.clientX, y: e.clientY };
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - previousMouse.x;
                cameraAngle -= deltaX * 0.01;
                previousMouse = { x: e.clientX, y: e.clientY };
            }
        });

        canvas.addEventListener('mouseup', () => {
            isDragging = false;
        });

        // Player seats
        const playerSeats = [];
        function createSeat(index, total) {
            const angle = (index / total) * Math.PI * 2;
            const radius = 7;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;

            const seatGeometry = new THREE.CylinderGeometry(0.8, 0.8, 0.3, 16);
            const seatMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x667eea,
                emissive: 0x667eea,
                emissiveIntensity: 0.2
            });
            const seat = new THREE.Mesh(seatGeometry, seatMaterial);
            seat.position.set(x, 0.5, z);
            seat.castShadow = true;
            scene.add(seat);

            playerSeats.push(seat);
        }

        // Cards
        const cards = [];
        function createCard(delay = 0) {
            setTimeout(() => {
                const angle = Math.random() * Math.PI * 2;
                const radius = Math.random() * 2 + 1.5;
                const x = Math.cos(angle) * radius;
                const z = Math.sin(angle) * radius;

                const cardGeometry = new THREE.BoxGeometry(0.6, 0.02, 0.9);
                const cardMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff });
                const card = new THREE.Mesh(cardGeometry, cardMaterial);
                card.position.set(x, 10, z);
                card.castShadow = true;
                scene.add(card);

                let progress = 0;
                function animateCard() {
                    progress += 0.02;
                    if (progress <= 1) {
                        card.position.y = 10 - (9.5 * progress);
                        card.rotation.y = progress * Math.PI * 2;
                        requestAnimationFrame(animateCard);
                    } else {
                        card.position.y = 0.5;
                    }
                }
                animateCard();

                cards.push(card);
            }, delay);
        }

        // Game state
        var game = {
            roomCode: null,
            playerId: null,
            name: null,
            isHost: false,
            players: [],
            maxPlayers: 4,
            started: false
        };

        // Animation
        function animate() {
            requestAnimationFrame(animate);

            if (!isDragging) {
                cameraAngle += 0.002;
            }

            const radius = 15;
            camera.position.x = Math.sin(cameraAngle) * radius;
            camera.position.z = Math.cos(cameraAngle) * radius;
            camera.lookAt(0, 0, 0);

            playerSeats.forEach((seat, i) => {
                seat.rotation.y += 0.01;
            });

            renderer.render(scene, camera);
        }
        animate();

        // UI Functions
        function showCreate() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('createMenu').style.display = 'block';
        }

        function showJoin() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('joinMenu').style.display = 'block';
        }

        function backToMain() {
            document.getElementById('createMenu').style.display = 'none';
            document.getElementById('joinMenu').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'block';
        }

        function genId() { 
            return Math.random().toString(36).substr(2, 8); 
        }

        function genCode() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }

        function createRoom() {
            const name = document.getElementById('hostName').value.trim();
            const msgEl = document.getElementById('createMsg');
            
            if (!name) {
                msgEl.className = 'error';
                msgEl.textContent = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ';
                return;
            }

            msgEl.className = 'success';
            msgEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...';

            game.roomCode = genCode();
            game.playerId = genId();
            game.name = name;
            game.isHost = true;
            game.maxPlayers = parseInt(document.getElementById('playerCount').value);
            game.players = [{ id: game.playerId, name: name, isHost: true }];

            db.ref('rooms/' + game.roomCode).set({
                roomCode: game.roomCode,
                maxPlayers: game.maxPlayers,
                players: game.players,
                started: false
            }).then(() => {
                console.log('âœ… Room created');
                startGame();
            }).catch((err) => {
                msgEl.className = 'error';
                msgEl.textContent = 'Ø®Ø·Ø£: ' + err.message;
            });
        }

        function joinRoom() {
            const name = document.getElementById('playerName').value.trim();
            const code = document.getElementById('roomCode').value.trim().toUpperCase();
            const msgEl = document.getElementById('joinMsg');

            if (!name || !code) {
                msgEl.className = 'error';
                msgEl.textContent = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ±Ù…Ø² Ø§Ù„ØºØ±ÙØ©';
                return;
            }

            msgEl.className = 'success';
            msgEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…...';

            db.ref('rooms/' + code).once('value').then(snap => {
                if (!snap.exists()) {
                    msgEl.className = 'error';
                    msgEl.textContent = 'ØºØ±ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©';
                    return;
                }

                const data = snap.val();
                if (data.started) {
                    msgEl.className = 'error';
                    msgEl.textContent = 'Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨Ø¯Ø£Øª';
                    return;
                }

                if (data.players.length >= data.maxPlayers) {
                    msgEl.className = 'error';
                    msgEl.textContent = 'Ø§Ù„ØºØ±ÙØ© Ù…Ù…ØªÙ„Ø¦Ø©';
                    return;
                }

                game.roomCode = code;
                game.playerId = genId();
                game.name = name;
                game.isHost = false;
                game.maxPlayers = data.maxPlayers;
                game.players = data.players;
                game.players.push({ id: game.playerId, name: name, isHost: false });

                db.ref('rooms/' + code + '/players').set(game.players).then(() => {
                    console.log('âœ… Joined room');
                    startGame();
                }).catch((err) => {
                    msgEl.className = 'error';
                    msgEl.textContent = 'Ø®Ø·Ø£: ' + err.message;
                });
            }).catch((err) => {
                msgEl.className = 'error';
                msgEl.textContent = 'Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„';
            });
        }

        function startGame() {
            document.getElementById('menu').classList.add('hidden');
            document.getElementById('infoBar').style.display = 'block';
            document.getElementById('roomCodeDisplay').textContent = game.roomCode;

            // Create seats
            for (let i = 0; i < game.maxPlayers; i++) {
                createSeat(i, game.maxPlayers);
            }

            // Deal cards
            for (let i = 0; i < 6; i++) {
                createCard(i * 300);
            }

            // Show start button if host
            if (game.isHost) {
                document.getElementById('startGameBtn').style.display = 'inline-block';
            }

            // Listen to updates
            db.ref('rooms/' + game.roomCode).on('value', snap => {
                if (snap.exists()) {
                    const data = snap.val();
                    game.players = data.players || [];
                    game.started = data.started || false;
                    
                    updatePlayersList();
                    
                    // Enable start button if enough players
                    const startBtn = document.getElementById('startGameBtn');
                    if (startBtn && game.isHost) {
                        startBtn.disabled = game.players.length < 4;
                    }

                    // Handle game started
                    if (game.started && data.players) {
                        const me = data.players.find(p => p.id === game.playerId);
                        if (me && me.role) {
                            showRole(me);
                        }
                    }
                }
            });

            console.log('ğŸ® Game started!');
        }

        function updatePlayersList() {
            const container = document.getElementById('playersList');
            container.innerHTML = '';
            
            document.getElementById('playerCount').textContent = game.players.length;
            document.getElementById('maxPlayers').textContent = game.maxPlayers;

            game.players.forEach(player => {
                const div = document.createElement('div');
                div.className = 'player-item';
                if (player.isHost) div.classList.add('host');
                if (player.id === game.playerId) div.classList.add('me');

                const roleIcon = player.role === 'forensic' ? 'ğŸ”¬' :
                                player.role === 'murderer' ? 'ğŸ”ª' :
                                player.role === 'witness' ? 'ğŸ‘ï¸' :
                                player.role === 'accomplice' ? 'ğŸ¤' :
                                player.role === 'investigator' ? 'ğŸ•µï¸' : 'ğŸ­';

                div.innerHTML = `
                    <span>${roleIcon} ${player.name}</span>
                    <span>${player.isHost ? 'ğŸ‘‘' : ''}</span>
                `;
                container.appendChild(div);
            });
        }

        function startGamePlay() {
            if (game.players.length < 4) {
                alert('ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ 4 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
                return;
            }

            // Assign roles
            const shuffled = game.players.slice().sort(() => Math.random() - 0.5);
            const roles = ['forensic', 'murderer', 'accomplice', 'witness'];
            for (let i = 4; i < shuffled.length; i++) {
                roles.push('investigator');
            }

            shuffled.forEach((player, i) => {
                player.role = roles[i];
            });

            // Update Firebase
            db.ref('rooms/' + game.roomCode).update({
                players: shuffled,
                started: true
            }).then(() => {
                console.log('âœ… Game roles assigned!');
                document.getElementById('startGameBtn').style.display = 'none';
            });
        }

        function showRole(player) {
            const roles = {
                murderer: { icon: 'ğŸ”ª', title: 'Ø§Ù„Ù‚Ø§ØªÙ„', desc: 'Ø§Ø®ØªØ± Ø³Ù„Ø§Ø­Ùƒ ÙˆØ¯Ù„ÙŠÙ„Ùƒ!' },
                accomplice: { icon: 'ğŸ¤', title: 'Ø§Ù„Ø´Ø±ÙŠÙƒ', desc: 'Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù‚Ø§ØªÙ„!' },
                witness: { icon: 'ğŸ‘ï¸', title: 'Ø§Ù„Ø´Ø§Ù‡Ø¯', desc: 'ØªØ¹Ø±Ù Ø§Ù„Ù…ØªÙ‡Ù…ÙŠÙ†!' },
                forensic: { icon: 'ğŸ”¬', title: 'Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø´Ø±Ø¹ÙŠ', desc: 'Ù‚Ø¯Ù… Ø§Ù„Ø£Ø¯Ù„Ø©!' },
                investigator: { icon: 'ğŸ•µï¸', title: 'Ù…Ø­Ù‚Ù‚', desc: 'Ø§ÙƒØ´Ù Ø§Ù„Ø­Ù‚ÙŠÙ‚Ø©!' }
            };

            const role = roles[player.role] || roles.investigator;
            
            // Update seat color
            const seatIndex = game.players.findIndex(p => p.id === player.id);
            if (playerSeats[seatIndex]) {
                if (player.role === 'forensic') {
                    playerSeats[seatIndex].material.color.setHex(0x3498db);
                    playerSeats[seatIndex].material.emissive.setHex(0x3498db);
                } else if (player.id === game.playerId) {
                    playerSeats[seatIndex].material.color.setHex(0xe74c3c);
                    playerSeats[seatIndex].material.emissive.setHex(0xe74c3c);
                }
            }

            // Show role alert
            alert(`${role.icon} Ø£Ù†Øª: ${role.title}\n\n${role.desc}`);
        }

        // Window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        console.log('âœ… Game ready!');
    </script>
</body>
</html>
