<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÿßŸÑŸÖÿ≠ŸÇŸÇ ÿßŸÑŸÖÿÆÿßÿØÿπ - 3D</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Cairo', sans-serif;
            background: #0a0a0a;
            overflow: hidden;
            direction: rtl;
            color: #fff;
        }

        #gameCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .ui-element {
            pointer-events: auto;
        }

        .top-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.9), rgba(136, 14, 79, 0.9));
            padding: 15px 40px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.6),
                0 0 30px rgba(255, 215, 0, 0.3);
            border: 2px solid rgba(255, 215, 0, 0.4);
            text-align: center;
        }

        .room-code-3d {
            font-size: 2em;
            font-weight: bold;
            color: #ffd700;
            letter-spacing: 8px;
            text-shadow: 
                0 0 20px rgba(255, 215, 0, 0.8),
                0 0 40px rgba(255, 215, 0, 0.5);
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.5); }
            to { text-shadow: 0 0 30px rgba(255, 215, 0, 1), 0 0 60px rgba(255, 215, 0, 0.7); }
        }

        .player-seats {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .player-seat {
            position: absolute;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            padding: 12px 20px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 20px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            text-align: center;
            min-width: 120px;
        }

        .player-seat:hover {
            transform: scale(1.05);
            border-color: rgba(255, 215, 0, 0.5);
            box-shadow: 
                0 10px 30px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(255, 215, 0, 0.3);
        }

        .player-seat.me {
            border-color: #e74c3c;
            box-shadow: 
                0 8px 20px rgba(231, 76, 60, 0.4),
                0 0 25px rgba(231, 76, 60, 0.3);
        }

        .player-seat.forensic {
            border-color: #ffd700;
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.3), rgba(41, 128, 185, 0.3));
            box-shadow: 
                0 8px 20px rgba(52, 152, 219, 0.4),
                0 0 25px rgba(255, 215, 0, 0.4);
        }

        .player-icon {
            font-size: 2em;
            margin-bottom: 5px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.5));
        }

        .player-name {
            font-size: 0.9em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .center-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.6));
            backdrop-filter: blur(20px);
            padding: 30px 50px;
            border-radius: 25px;
            border: 3px solid rgba(255, 215, 0, 0.5);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 40px rgba(255, 215, 0, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.1);
            text-align: center;
            max-width: 500px;
        }

        .role-display {
            font-size: 3em;
            margin-bottom: 10px;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .role-title {
            font-size: 2em;
            color: #ffd700;
            margin-bottom: 10px;
            text-shadow: 
                0 0 20px rgba(255, 215, 0, 0.8),
                0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .role-desc {
            font-size: 1.1em;
            opacity: 0.9;
            color: #ccc;
        }

        .clues-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.9), rgba(46, 204, 113, 0.9));
            padding: 15px 30px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 2px solid rgba(255, 215, 0, 0.4);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            max-width: 90%;
            text-align: center;
        }

        .clue-tag {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 10px;
            margin: 4px;
            font-size: 0.85em;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .start-screen.hidden {
            display: none;
        }

        .menu-box {
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.9), rgba(136, 14, 79, 0.9));
            padding: 40px;
            border-radius: 30px;
            border: 3px solid rgba(255, 215, 0, 0.5);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.8),
                0 0 50px rgba(255, 215, 0, 0.3);
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .menu-title {
            font-size: 2.5em;
            color: #ffd700;
            margin-bottom: 15px;
            text-shadow: 
                0 0 20px rgba(255, 215, 0, 0.8),
                0 4px 8px rgba(0, 0, 0, 0.5);
        }

        .menu-desc {
            font-size: 0.95em;
            color: #ccc;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        input, select {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1em;
            font-family: 'Cairo', sans-serif;
            backdrop-filter: blur(10px);
        }

        input:focus, select:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        button {
            width: 100%;
            padding: 15px;
            margin: 8px 0;
            border: none;
            border-radius: 12px;
            font-size: 1.1em;
            font-family: 'Cairo', sans-serif;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 
                0 8px 20px rgba(102, 126, 234, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 12px 30px rgba(102, 126, 234, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        button:active {
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
        }

        .hidden {
            display: none !important;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .cards-area {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .card-3d {
            position: absolute;
            width: 80px;
            height: 120px;
            background: linear-gradient(135deg, #fff, #f0f0f0);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-style: preserve-3d;
            border: 2px solid #333;
        }

        .card-3d.dealing {
            animation: dealCard 1s ease forwards;
        }

        @keyframes dealCard {
            0% {
                transform: translateY(-200px) rotateY(180deg);
                opacity: 0;
            }
            100% {
                transform: translateY(0) rotateY(0deg);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="startScreen" class="start-screen">
        <div class="menu-box">
            <div class="menu-title">üîç ÿßŸÑŸÖÿ≠ŸÇŸÇ ÿßŸÑŸÖÿÆÿßÿØÿπ üî™</div>
            <div class="menu-desc">
                ÿ¨ÿ±ŸäŸÖÿ© ŸÇÿ™ŸÑ ÿ∫ÿßŸÖÿ∂ÿ© ŸÅŸä ÿ∫ÿ±ŸÅÿ© ÿ´ŸÑÿßÿ´Ÿäÿ© ÿßŸÑÿ£ÿ®ÿπÿßÿØ!<br>
                ÿßŸÑŸÇÿßÿ™ŸÑ ŸàÿßŸÑÿ¥ÿ±ŸäŸÉ ÿ®ŸäŸÜ ÿßŸÑŸÖÿ≠ŸÇŸÇŸäŸÜ...<br>
                ŸáŸÑ ÿ≥ÿ™ŸÉÿ¥ŸÅ ÿßŸÑÿ≠ŸÇŸäŸÇÿ©ÿü
            </div>
            <div id="homeMenu">
                <button onclick="showCreateRoom()">üè† ÿ•ŸÜÿ¥ÿßÿ° ÿ∫ÿ±ŸÅÿ©</button>
                <button onclick="showJoinRoom()" class="btn-secondary">üö™ ÿßŸÜÿ∂ŸÖÿßŸÖ</button>
            </div>
            <div id="createMenu" class="hidden">
                <input type="text" id="hostName" placeholder="ÿßÿ≥ŸÖŸÉ" maxlength="12">
                <select id="playerCount">
                    <option value="4">4 ŸÑÿßÿπÿ®ŸäŸÜ</option>
                    <option value="5">5 ŸÑÿßÿπÿ®ŸäŸÜ</option>
                    <option value="6">6 ŸÑÿßÿπÿ®ŸäŸÜ</option>
                    <option value="7">7 ŸÑÿßÿπÿ®ŸäŸÜ</option>
                    <option value="8">8 ŸÑÿßÿπÿ®ŸäŸÜ</option>
                </select>
                <button onclick="createRoom()" class="btn-success">ÿ•ŸÜÿ¥ÿßÿ°</button>
                <button onclick="backToHome()" class="btn-secondary">ÿ±ÿ¨Ÿàÿπ</button>
            </div>
            <div id="joinMenu" class="hidden">
                <input type="text" id="playerName" placeholder="ÿßÿ≥ŸÖŸÉ" maxlength="12">
                <input type="text" id="roomCode" placeholder="ÿ±ŸÖÿ≤ ÿßŸÑÿ∫ÿ±ŸÅÿ©" maxlength="4" style="text-transform:uppercase;text-align:center;font-size:1.5em;letter-spacing:5px;">
                <button onclick="joinRoom()" class="btn-success">ÿßŸÜÿ∂ŸÖÿßŸÖ</button>
                <button onclick="backToHome()" class="btn-secondary">ÿ±ÿ¨Ÿàÿπ</button>
            </div>
        </div>
    </div>

    <!-- 3D Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- UI Overlay -->
    <div id="ui-overlay">
        <!-- Top Bar -->
        <div class="top-bar ui-element hidden" id="topBar">
            <div class="room-code-3d" id="roomCodeDisplay">----</div>
            <div style="font-size:0.9em;margin-top:5px;color:#ccc;">
                <span id="playerCount">0</span>/<span id="maxPlayers">4</span> ŸÑÿßÿπÿ®ŸäŸÜ
            </div>
        </div>

        <!-- Player Seats -->
        <div class="player-seats" id="playerSeats"></div>

        <!-- Center Info -->
        <div class="center-info ui-element hidden" id="centerInfo">
            <div class="role-display" id="roleIcon">üîç</div>
            <div class="role-title" id="roleTitle">ÿØŸàÿ±ŸÉ</div>
            <div class="role-desc" id="roleDesc">ÿßŸÜÿ™ÿ∏ÿ±...</div>
        </div>

        <!-- Clues Panel -->
        <div class="clues-panel ui-element hidden" id="cluesPanel">
            <div style="font-weight:bold;margin-bottom:8px;">üìã ÿ£ÿØŸÑÿ© ÿßŸÑÿ∑ÿ®Ÿäÿ® ÿßŸÑÿ¥ÿ±ÿπŸä</div>
            <div id="cluesList"></div>
        </div>

        <!-- Cards Area -->
        <div class="cards-area" id="cardsArea"></div>
    </div>

    <script>
        // ========== Firebase Setup ==========
        firebase.initializeApp({
            apiKey: "AIzaSyB88NCDQzsUzHZgH07B63e4Dpxc3LfXSyY",
            authDomain: "detective-game-df960.firebaseapp.com",
            databaseURL: "https://detective-game-df960-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "detective-game-df960"
        });
        var db = firebase.database();

        // ========== Three.js Setup ==========
        const canvas = document.getElementById('gameCanvas');
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
        
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        // Background
        scene.background = new THREE.Color(0x0a0a0a);
        scene.fog = new THREE.Fog(0x0a0a0a, 10, 50);

        // Lights
        const ambientLight = new THREE.AmbientLight(0x404040, 1.5);
        scene.add(ambientLight);

        const spotLight = new THREE.SpotLight(0xffd700, 2);
        spotLight.position.set(0, 15, 0);
        spotLight.castShadow = true;
        spotLight.angle = Math.PI / 4;
        spotLight.penumbra = 0.3;
        spotLight.decay = 2;
        spotLight.distance = 40;
        scene.add(spotLight);

        const pointLight1 = new THREE.PointLight(0xff0040, 0.5, 30);
        pointLight1.position.set(-10, 5, -10);
        scene.add(pointLight1);

        const pointLight2 = new THREE.PointLight(0x0040ff, 0.5, 30);
        pointLight2.position.set(10, 5, -10);
        scene.add(pointLight2);

        // Table
        const tableGeometry = new THREE.CylinderGeometry(5, 5, 0.3, 32);
        const tableMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x4a2c2a,
            roughness: 0.4,
            metalness: 0.3
        });
        const table = new THREE.Mesh(tableGeometry, tableMaterial);
        table.position.y = 0;
        table.castShadow = true;
        table.receiveShadow = true;
        scene.add(table);

        // Table surface (green felt)
        const feltGeometry = new THREE.CylinderGeometry(4.8, 4.8, 0.05, 32);
        const feltMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x0a5f38,
            roughness: 0.8
        });
        const felt = new THREE.Mesh(feltGeometry, feltMaterial);
        felt.position.y = 0.18;
        felt.receiveShadow = true;
        scene.add(felt);

        // Floor
        const floorGeometry = new THREE.PlaneGeometry(50, 50);
        const floorMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x1a1a1a,
            roughness: 0.9
        });
        const floor = new THREE.Mesh(floorGeometry, floorMaterial);
        floor.rotation.x = -Math.PI / 2;
        floor.position.y = -2;
        floor.receiveShadow = true;
        scene.add(floor);

        // Camera position
        camera.position.set(0, 12, 15);
        camera.lookAt(0, 0, 0);

        // Camera animation
        let cameraAngle = 0;
        const cameraRadius = 15;
        const cameraHeight = 12;

        // Player seats (3D objects)
        const playerObjects = [];
        const seatMaterial = new THREE.MeshStandardMaterial({ 
            color: 0x667eea,
            emissive: 0x667eea,
            emissiveIntensity: 0.2,
            roughness: 0.5,
            metalness: 0.3
        });

        function createPlayerSeat(index, total) {
            const angle = (index / total) * Math.PI * 2;
            const radius = 7;
            const x = Math.cos(angle) * radius;
            const z = Math.sin(angle) * radius;

            // Seat base
            const seatGeometry = new THREE.CylinderGeometry(0.8, 0.8, 0.3, 16);
            const seat = new THREE.Mesh(seatGeometry, seatMaterial);
            seat.position.set(x, 0.5, z);
            seat.castShadow = true;
            scene.add(seat);

            // Glow effect
            const glowGeometry = new THREE.SphereGeometry(1, 16, 16);
            const glowMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x667eea,
                transparent: true,
                opacity: 0.2
            });
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            glow.position.set(x, 1, z);
            scene.add(glow);

            playerObjects.push({ seat, glow, angle });
        }

        // Cards on table
        const cards = [];

        function createCard(x, z, delay = 0) {
            const cardGeometry = new THREE.BoxGeometry(0.6, 0.02, 0.9);
            const cardMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xffffff,
                roughness: 0.3,
                metalness: 0.1
            });
            const card = new THREE.Mesh(cardGeometry, cardMaterial);
            card.position.set(x, -10, z);
            card.castShadow = true;
            scene.add(card);
            
            // Animate card dealing
            setTimeout(() => {
                let startY = -10;
                let targetY = 0.5;
                let progress = 0;
                
                const animateCard = () => {
                    progress += 0.05;
                    if (progress <= 1) {
                        card.position.y = startY + (targetY - startY) * progress;
                        card.rotation.y = progress * Math.PI * 2;
                        requestAnimationFrame(animateCard);
                    } else {
                        card.position.y = targetY;
                        card.rotation.y = 0;
                    }
                };
                animateCard();
            }, delay);

            cards.push(card);
            return card;
        }

        // Game State
        var game = {
            roomCode: null,
            playerId: null,
            name: null,
            isHost: false,
            players: [],
            maxPlayers: 4,
            started: false,
            role: null
        };

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);

            // Rotate camera slowly
            cameraAngle += 0.001;
            camera.position.x = Math.sin(cameraAngle) * cameraRadius;
            camera.position.z = Math.cos(cameraAngle) * cameraRadius;
            camera.position.y = cameraHeight;
            camera.lookAt(0, 0, 0);

            // Animate player glows
            playerObjects.forEach((obj, i) => {
                obj.glow.rotation.y += 0.02;
                const pulse = Math.sin(Date.now() * 0.002 + i) * 0.1 + 0.9;
                obj.glow.scale.set(pulse, pulse, pulse);
            });

            // Animate cards
            cards.forEach((card, i) => {
                card.rotation.y = Math.sin(Date.now() * 0.001 + i) * 0.1;
            });

            renderer.render(scene, camera);
        }
        animate();

        // Window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // UI Functions
        function showCreateRoom() {
            document.getElementById('homeMenu').classList.add('hidden');
            document.getElementById('createMenu').classList.remove('hidden');
        }

        function showJoinRoom() {
            document.getElementById('homeMenu').classList.add('hidden');
            document.getElementById('joinMenu').classList.remove('hidden');
        }

        function backToHome() {
            document.getElementById('createMenu').classList.add('hidden');
            document.getElementById('joinMenu').classList.add('hidden');
            document.getElementById('homeMenu').classList.remove('hidden');
        }

        function genId() { return Math.random().toString(36).substr(2, 8); }
        function genCode() {
            var c = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789', r = '';
            for (var i = 0; i < 4; i++) r += c[Math.floor(Math.random() * c.length)];
            return r;
        }

        function createRoom() {
            const name = document.getElementById('hostName').value.trim();
            if (!name) { alert('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ'); return; }

            game.roomCode = genCode();
            game.playerId = genId();
            game.name = name;
            game.isHost = true;
            game.maxPlayers = parseInt(document.getElementById('playerCount').value);
            game.players = [{ id: game.playerId, name: name, isHost: true }];

            db.ref('rooms/' + game.roomCode).set({
                roomCode: game.roomCode,
                maxPlayers: game.maxPlayers,
                players: game.players,
                started: false
            }).then(() => {
                startLobby();
            });
        }

        function joinRoom() {
            const name = document.getElementById('playerName').value.trim();
            const code = document.getElementById('roomCode').value.trim().toUpperCase();
            if (!name || !code) { alert('ÿ£ÿØÿÆŸÑ ÿßÿ≥ŸÖŸÉ Ÿàÿ±ŸÖÿ≤ ÿßŸÑÿ∫ÿ±ŸÅÿ©'); return; }

            db.ref('rooms/' + code).once('value').then(snap => {
                if (!snap.exists()) { alert('ÿ∫ÿ±ŸÅÿ© ÿ∫Ÿäÿ± ŸÖŸàÿ¨ŸàÿØÿ©'); return; }
                const data = snap.val();
                if (data.started) { alert('ÿßŸÑŸÑÿπÿ®ÿ© ÿ®ÿØÿ£ÿ™'); return; }
                if (data.players.length >= data.maxPlayers) { alert('ÿßŸÑÿ∫ÿ±ŸÅÿ© ŸÖŸÖÿ™ŸÑÿ¶ÿ©'); return; }

                game.roomCode = code;
                game.playerId = genId();
                game.name = name;
                game.isHost = false;
                game.maxPlayers = data.maxPlayers;
                game.players = data.players;
                game.players.push({ id: game.playerId, name: name, isHost: false });

                db.ref('rooms/' + code + '/players').set(game.players).then(() => {
                    startLobby();
                });
            });
        }

        function startLobby() {
            document.getElementById('startScreen').classList.add('hidden');
            document.getElementById('topBar').classList.remove('hidden');
            document.getElementById('roomCodeDisplay').textContent = game.roomCode;
            updatePlayers();
            listenToRoom();
            
            // Create player seats
            game.players.forEach((p, i) => {
                createPlayerSeat(i, game.maxPlayers);
            });

            // Deal cards animation
            setTimeout(() => {
                for (let i = 0; i < 6; i++) {
                    const angle = (Math.random() - 0.5) * Math.PI;
                    const radius = Math.random() * 2 + 1;
                    createCard(
                        Math.cos(angle) * radius,
                        Math.sin(angle) * radius,
                        i * 200
                    );
                }
            }, 1000);
        }

        function updatePlayers() {
            document.getElementById('playerCount').textContent = game.players.length;
            document.getElementById('maxPlayers').textContent = game.maxPlayers;

            const seatsContainer = document.getElementById('playerSeats');
            seatsContainer.innerHTML = '';

            const positions = [
                { top: '15%', left: '50%', transform: 'translateX(-50%)' },
                { top: '30%', left: '75%' },
                { top: '55%', left: '80%' },
                { bottom: '20%', left: '70%' },
                { bottom: '15%', left: '50%', transform: 'translateX(-50%)' },
                { bottom: '20%', left: '30%' },
                { top: '55%', left: '20%' },
                { top: '30%', left: '25%' }
            ];

            game.players.forEach((player, index) => {
                const seat = document.createElement('div');
                seat.className = 'player-seat ui-element';
                if (player.id === game.playerId) seat.classList.add('me');
                if (player.role === 'forensic') seat.classList.add('forensic');

                const icon = player.role === 'forensic' ? 'üî¨' : 
                            player.role === 'murderer' ? 'üî™' :
                            player.role === 'witness' ? 'üëÅÔ∏è' :
                            player.role === 'accomplice' ? 'ü§ù' : 'üïµÔ∏è';

                seat.innerHTML = `
                    <div class="player-icon">${icon}</div>
                    <div class="player-name">${player.name}</div>
                `;

                Object.assign(seat.style, positions[index % positions.length]);
                seatsContainer.appendChild(seat);
            });
        }

        function listenToRoom() {
            db.ref('rooms/' + game.roomCode).on('value', snap => {
                if (!snap.exists()) return;
                const data = snap.val();
                game.players = data.players || [];
                game.started = data.started;
                
                updatePlayers();

                if (game.started) {
                    const me = game.players.find(p => p.id === game.playerId);
                    if (me) {
                        game.role = me.role;
                        showRole(me);
                    }
                }
            });
        }

        function showRole(player) {
            const centerInfo = document.getElementById('centerInfo');
            centerInfo.classList.remove('hidden');

            const roles = {
                murderer: { icon: 'üî™', title: 'ÿßŸÑŸÇÿßÿ™ŸÑ', desc: 'ÿßÿÆÿ™ÿ± ÿ≥ŸÑÿßÿ≠ŸÉ ŸàÿØŸÑŸäŸÑŸÉ!' },
                accomplice: { icon: 'ü§ù', title: 'ÿßŸÑÿ¥ÿ±ŸäŸÉ', desc: 'ÿ≥ÿßÿπÿØ ÿßŸÑŸÇÿßÿ™ŸÑ!' },
                witness: { icon: 'üëÅÔ∏è', title: 'ÿßŸÑÿ¥ÿßŸáÿØ', desc: 'ÿ™ÿπÿ±ŸÅ ÿßŸÑŸÖÿ™ŸáŸÖŸäŸÜ!' },
                forensic: { icon: 'üî¨', title: 'ÿßŸÑÿ∑ÿ®Ÿäÿ® ÿßŸÑÿ¥ÿ±ÿπŸä', desc: 'ŸÇÿØŸÖ ÿßŸÑÿ£ÿØŸÑÿ©!' },
                investigator: { icon: 'üïµÔ∏è', title: 'ŸÖÿ≠ŸÇŸÇ', desc: 'ÿßŸÉÿ¥ŸÅ ÿßŸÑÿ≠ŸÇŸäŸÇÿ©!' }
            };

            const role = roles[player.role] || roles.investigator;
            document.getElementById('roleIcon').textContent = role.icon;
            document.getElementById('roleTitle').textContent = role.title;
            document.getElementById('roleDesc').textContent = role.desc;

            setTimeout(() => {
                centerInfo.classList.add('hidden');
            }, 5000);
        }
    </script>
</body>
</html>
